<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>EpicStage EventOS â€“ ë¡œê·¸ì¸</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.3/babel.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#080b14;--surface:#0f1623;--card:#141d2e;--border:rgba(255,255,255,0.07);
  --primary:#6366f1;--primary-dim:rgba(99,102,241,0.15);--primary-border:rgba(99,102,241,0.3);
  --accent:#ec4899;--success:#10b981;--warn:#f59e0b;--danger:#ef4444;
  --txt:#e2e8f0;--txt2:#94a3b8;--txt3:#64748b;--txt4:#475569;
  --radius:12px;--radius-sm:8px;--sidebar:240px;--topbar:56px;--bottomnav:60px;
}
html{font-size:16px;-webkit-text-size-adjust:100%}
body{font-family:'Apple SD Gothic Neo','Pretendard','Noto Sans KR',sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(99,102,241,.3);border-radius:99px}
button{font-family:inherit;cursor:pointer}input,textarea,select{font-family:inherit}
/* â”€ Topbar â”€ */
#topbar{position:fixed;top:0;left:0;right:0;height:var(--topbar);background:rgba(8,11,20,.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:12px;z-index:200}
#topbar .logo{display:flex;align-items:center;gap:8px;flex-shrink:0;margin-right:16px}
#topbar .logo-icon{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:900;color:#fff}
#topbar .logo-text{color:var(--txt);font-weight:800;font-size:15px;white-space:nowrap}
#topbar nav{display:flex;gap:2px;flex:1}
#topbar nav button{background:transparent;border:none;color:var(--txt3);padding:6px 12px;border-radius:6px;font-size:13px;transition:all .15s;white-space:nowrap}
#topbar nav button.active{background:var(--primary-dim);color:#a5b4fc;font-weight:600}
#topbar nav button:hover:not(.active){background:rgba(255,255,255,.04);color:var(--txt2)}
#topbar .user{margin-left:auto;display:flex;align-items:center;gap:10px;flex-shrink:0}
#topbar .user-badge{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#ec4899);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}
#topbar .user-name{font-size:13px;color:var(--txt2)}
/* â”€ Bottom Nav (mobile) â”€ */
#bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;height:var(--bottomnav);background:rgba(8,11,20,.96);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-top:1px solid var(--border);z-index:200;justify-content:space-around;align-items:center;padding:0 8px}
#bottom-nav button{background:transparent;border:none;display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 12px;border-radius:8px;transition:all .15s;min-width:54px}
#bottom-nav button span.icon{font-size:20px}
#bottom-nav button span.label{font-size:10px;color:var(--txt3);font-weight:500}
#bottom-nav button.active span.icon{filter:drop-shadow(0 0 6px #6366f1)}
#bottom-nav button.active span.label{color:#a5b4fc;font-weight:700}
/* â”€ Main â”€ */
#main{margin-top:var(--topbar);padding:24px 24px 40px;max-width:1280px;margin-left:auto;margin-right:auto}
/* â”€ Cards â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.card-sm{background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px}
/* â”€ Status badge â”€ */
.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
/* â”€ Buttons â”€ */
.btn{border:none;border-radius:8px;padding:8px 16px;font-size:13px;font-weight:600;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff}
.btn-primary:hover{opacity:.88}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--txt2)}
.btn-ghost:hover{border-color:var(--primary-border);color:var(--txt)}
.btn-danger{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);color:#fca5a5}
/* â”€ Form â”€ */
.form-input{width:100%;background:#1e293b;border:1.5px solid #334155;color:var(--txt);border-radius:8px;padding:10px 14px;font-size:13px;outline:none;transition:border-color .18s}
.form-input:focus{border-color:var(--primary)}
.form-label{font-size:12px;font-weight:600;color:var(--txt3);margin-bottom:5px;display:block}
.form-group{margin-bottom:14px}
/* â”€ Progress â”€ */
.prog-track{height:4px;background:rgba(255,255,255,.06);border-radius:99px;overflow:hidden}
.prog-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,#6366f1,#8b5cf6);transition:width .8s cubic-bezier(.4,0,.2,1)}
/* â”€ Tab bar â”€ */
.tab-bar{display:flex;gap:2px;border-bottom:1px solid var(--border);margin-bottom:20px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.tab-bar::-webkit-scrollbar{display:none}
.tab-btn{background:transparent;border:none;border-bottom:2px solid transparent;color:var(--txt3);padding:8px 14px;font-size:13px;white-space:nowrap;transition:all .15s;margin-bottom:-1px}
.tab-btn.active{border-bottom-color:var(--primary);color:#a5b4fc;font-weight:600}
/* â”€ Toast â”€ */
#toasts{position:fixed;bottom:80px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{background:rgba(15,22,35,.96);backdrop-filter:blur(12px);border:1px solid var(--border);color:var(--txt);padding:10px 16px;border-radius:10px;font-size:13px;font-weight:500;box-shadow:0 4px 20px rgba(0,0,0,.3);animation:toastIn .2s ease;pointer-events:all}
@keyframes toastIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
/* â”€ Modal â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:500;display:flex;align-items:flex-end;justify-content:center;padding:0}
.modal-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius) var(--radius) 0 0;width:100%;max-width:540px;padding:24px;max-height:90vh;overflow-y:auto;animation:slideUp .25s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-title{font-size:16px;font-weight:800;color:var(--txt);margin-bottom:18px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:18px}
/* â”€ Grid utilities â”€ */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.flex-row{display:flex;align-items:center;gap:10px}
.flex-between{display:flex;align-items:center;justify-content:space-between}
/* â”€ Gantt â”€ */
.gantt-row{display:flex;align-items:center;margin-bottom:5px}
.gantt-label{color:var(--txt2);font-size:11px;text-align:right;padding-right:10px;flex-shrink:0;width:130px}
.gantt-track{flex:1;position:relative;height:22px;background:rgba(255,255,255,.03);border-radius:3px}
.gantt-bar{position:absolute;top:1px;height:20px;border-radius:3px;display:flex;align-items:center;padding-left:8px}
.gantt-bar span{font-size:10px;font-weight:600;color:#fff;white-space:nowrap}
/* â”€ Log â”€ */
.log-item{display:flex;gap:10px;padding:10px;border-radius:8px;margin-bottom:6px}
.log-auto{background:rgba(99,102,241,.06);border:1px solid rgba(99,102,241,.12)}
.log-comment{background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.12)}
.log-avatar{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
/* â”€ Checklist â”€ */
.cl-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;margin-bottom:3px}
.cl-done{background:rgba(16,185,129,.05);border:1px solid rgba(16,185,129,.12)}
.cl-undone{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05)}
/* â”€ Stat card â”€ */
.stat-card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px}
.stat-label{color:var(--txt3);font-size:11px;letter-spacing:.06em;text-transform:uppercase;margin-bottom:8px}
.stat-value{color:var(--txt);font-size:26px;font-weight:800;line-height:1}
.stat-sub{color:var(--txt4);font-size:12px;margin-top:6px}
/* â”€ Project card â”€ */
.proj-card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:var(--radius);padding:18px;cursor:pointer;transition:all .2s}
.proj-card:hover{border-color:var(--primary-border);background:rgba(99,102,241,.04)}
/* â”€ File zone â”€ */
.drop-zone{border:2px dashed rgba(99,102,241,.3);border-radius:var(--radius);padding:36px 20px;text-align:center;cursor:pointer;transition:all .2s}
.drop-zone:hover{border-color:var(--primary);background:var(--primary-dim)}
/* â•â• ADMIN PANEL â•â• */
.admin-user-row{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.02);margin-bottom:8px;flex-wrap:wrap}
.admin-user-row.approved{border-left:3px solid #10b981}
.admin-user-row.pending{border-left:3px solid #f59e0b}
.admin-user-row.blocked{border-left:3px solid #ef4444}
.status-pill{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700}
.pill-approved{background:rgba(16,185,129,.12);color:#34d399;border:1px solid rgba(16,185,129,.2)}
.pill-pending{background:rgba(245,158,11,.12);color:#fbbf24;border:1px solid rgba(245,158,11,.2)}
.pill-blocked{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.2)}
.admin-action-btn{padding:5px 12px;border-radius:7px;font-size:12px;font-weight:600;border:none;cursor:pointer;transition:all .15s}
/* â•â• LOGIN PAGE â•â• */
.login-wrap{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px}
.login-bg-orb{position:fixed;border-radius:50%;filter:blur(80px);pointer-events:none;z-index:0}
.login-card{position:relative;z-index:1;background:rgba(15,22,35,.85);border:1px solid rgba(99,102,241,.18);border-radius:20px;padding:40px 36px;width:100%;max-width:400px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);box-shadow:0 24px 80px rgba(0,0,0,.5)}
.login-logo{text-align:center;margin-bottom:28px}
.login-logo-icon{width:56px;height:56px;border-radius:16px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:900;color:#fff;margin:0 auto 14px}
.login-brand{font-size:22px;font-weight:900;color:var(--txt);letter-spacing:-.5px}
.login-sub{font-size:13px;color:var(--txt4);margin-top:4px}
.login-divider{height:1px;background:var(--border);margin:20px 0}
.login-field{position:relative;margin-bottom:14px}
.login-field-label{font-size:11px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:7px;display:block}
.login-field input{width:100%;background:#0e1520;border:1.5px solid #1e2d42;color:var(--txt);border-radius:10px;padding:12px 14px 12px 42px;font-size:14px;outline:none;transition:all .18s}
.login-field input:focus{border-color:#6366f1;background:#111925;box-shadow:0 0 0 3px rgba(99,102,241,.1)}
.login-field .field-icon{position:absolute;left:14px;bottom:12px;font-size:16px;color:var(--txt4);pointer-events:none}
.login-btn{width:100%;padding:13px;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;margin-top:6px;transition:all .18s;letter-spacing:.02em}
.login-btn:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 8px 24px rgba(99,102,241,.35)}
.login-btn:active{transform:translateY(0)}
.login-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.login-error{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.25);border-radius:8px;padding:10px 14px;color:#fca5a5;font-size:13px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.login-notice{background:rgba(99,102,241,.06);border:1px solid rgba(99,102,241,.12);border-radius:10px;padding:12px 14px;margin-top:20px;text-align:center}
.login-notice-txt{color:var(--txt4);font-size:12px;line-height:1.6}
.login-attempts{font-size:11px;color:var(--txt4);text-align:center;margin-top:10px}
/* show-pw toggle */
.pw-toggle{position:absolute;right:12px;bottom:10px;background:transparent;border:none;color:var(--txt4);font-size:18px;cursor:pointer;padding:2px 4px;transition:color .15s}
.pw-toggle:hover{color:var(--txt2)}
/* â”€ Report preview â”€ */
.report-preview{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:10px;padding:16px;max-height:280px;overflow-y:auto}
.report-preview pre{color:var(--txt2);font-size:13px;line-height:1.7;white-space:pre-wrap;font-family:inherit}
/* â”€ AI panel â”€ */
.ai-panel{background:linear-gradient(135deg,rgba(99,102,241,.08),rgba(139,92,246,.08));border:1px solid rgba(99,102,241,.2);border-radius:var(--radius);padding:16px}

/* â”€ Sync spinner â”€ */
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

/* â•â• RESPONSIVE â•â• */
@media(max-width:768px){
  #topbar nav{display:none}
  #topbar .user-name{display:none}
  #bottom-nav{display:flex}
  #main{padding:16px 14px calc(var(--bottomnav) + 16px)}
  .grid-4{grid-template-columns:1fr 1fr}
  .grid-3{grid-template-columns:1fr}
  .grid-2{grid-template-columns:1fr}
  .gantt-label{width:90px;font-size:10px}
  .modal-box{max-height:95vh}
}
@media(min-width:769px) and (max-width:1100px){
  .grid-4{grid-template-columns:repeat(2,1fr)}
}
@media(min-width:769px){
  .modal-overlay{align-items:center;padding:20px}
  .modal-box{border-radius:var(--radius);animation:fadeScale .22s ease}
  @keyframes fadeScale{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
  #toasts{bottom:24px}
}
</style>
</head>
<body>

<div id="root"></div>
<div id="toasts"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;

/* â•â• íŒ€ ê³„ì • (EpicStage ì „ìš©) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   approved ê°’ì€ adminì´ ìŠ¹ì¸í•´ì•¼ë§Œ ë¡œê·¸ì¸ ê°€ëŠ¥.
   admin ê³„ì •ì€ í•­ìƒ approved=true (í•˜ë“œì½”ë”© ë¶ˆë³€)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const INIT_USERS = [
  { id:"admin", pw:"Epicstage2026",  name:"ê´€ë¦¬ì", role:"ì‹œìŠ¤í…œ ê´€ë¦¬ì", color:"#a855f7", initial:"ê´€", producer:null,      isAdmin:true,  approved:true,  createdAt:"2026-01-01", lastLogin:null },
  { id:"kim",   pw:"Epic2026",  name:"ê¹€ì§€í˜„",  role:"í–‰ì‚¬ ê¸°íš íŒ€ì¥",  color:"#6366f1", initial:"ê¹€", producer:"ê¹€ì§€í˜„",  isAdmin:true,  approved:false, createdAt:"2026-01-10", lastLogin:null },
  { id:"lee",   pw:"Epic2026",  name:"ì´ì„œì—°",  role:"ê¸°íš PD",        color:"#ec4899", initial:"ì´", producer:"ì´ì„œì—°",  isAdmin:false, approved:false, createdAt:"2026-01-10", lastLogin:null },
  { id:"park",  pw:"Epic2026",  name:"ë°•ë¯¼ì¤€",  role:"í˜„ì¥ ë§¤ë‹ˆì €",     color:"#10b981", initial:"ë°•", producer:"ë°•ë¯¼ì¤€",  isAdmin:false, approved:false, createdAt:"2026-01-10", lastLogin:null },
  { id:"choi",  pw:"Epic2026",  name:"ìµœë‹¤ì€",  role:"ë””ìì´ë„ˆ",        color:"#f59e0b", initial:"ìµœ", producer:"ìµœë‹¤ì€",  isAdmin:false, approved:false, createdAt:"2026-01-10", lastLogin:null },
];
const MAX_ATTEMPTS = 5;
const LOCK_MINUTES = 10;
const USER_COLORS = ["#6366f1","#ec4899","#10b981","#f59e0b","#06b6d4","#a855f7","#f97316","#84cc16"];

/* â•â• Google Drive ì—°ë™ ì„¤ì • â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Google Apps Script Web App URLì„ ì•„ë˜ì— ì„¤ì •í•˜ì„¸ìš”.
   ì„¤ì • ë°©ë²•: https://script.google.com ì—ì„œ Code.gs ë°°í¬ í›„ URL ë³µì‚¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DRIVE_CONFIG = {
  GAS_URL: "",  // â† Google Apps Script ë°°í¬ URLì„ ì—¬ê¸°ì— ì…ë ¥
  ROOT_FOLDER_ID: "17KmQNhns3Q35o2psQIw7NMBs3BawdRcu",
  SYNC_DEBOUNCE_MS: 3000,
  ENABLED: false, // GAS_URL ì„¤ì • ì‹œ ìë™ í™œì„±í™”
};
// GAS_URLì´ ìˆìœ¼ë©´ ìë™ í™œì„±í™”
if (DRIVE_CONFIG.GAS_URL) DRIVE_CONFIG.ENABLED = true;

/* â”€â”€ localStorage ì˜ì†í™” + Google Drive ë™ê¸°í™” ëª¨ë“ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// SyncManager: ë””ë°”ìš´ìŠ¤ëœ Google Drive ë™ê¸°í™” í
const SyncManager = {
  _timers: {},
  _status: "idle", // "idle" | "syncing" | "success" | "error" | "offline"
  _listeners: new Set(),
  _lastSyncTime: null,

  subscribe(fn) { this._listeners.add(fn); return () => this._listeners.delete(fn); },
  _notify() { this._listeners.forEach(fn => fn(this._status, this._lastSyncTime)); },

  setStatus(s) { this._status = s; this._notify(); },
  getStatus() { return this._status; },

  // GASì— ë°ì´í„° ì €ì¥ (ë””ë°”ìš´ìŠ¤)
  queueSync(action, data) {
    if (!DRIVE_CONFIG.ENABLED) return;
    if (!navigator.onLine) { this.setStatus("offline"); return; }

    clearTimeout(this._timers[action]);
    this._timers[action] = setTimeout(async () => {
      this.setStatus("syncing");
      try {
        const res = await fetch(DRIVE_CONFIG.GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({ action, ...data }),
          redirect: "follow",
        });
        const text = await res.text();
        let result;
        try { result = JSON.parse(text); } catch { result = { ok: true }; }
        if (result.error) throw new Error(result.error);
        this._lastSyncTime = new Date();
        this.setStatus("success");
      } catch (err) {
        console.error("[DriveSync]", action, err);
        this.setStatus("error");
      }
    }, DRIVE_CONFIG.SYNC_DEBOUNCE_MS);
  },

  // GASì—ì„œ ì „ì²´ ë°ì´í„° ë¡œë“œ
  async loadFromCloud() {
    if (!DRIVE_CONFIG.ENABLED) return null;
    if (!navigator.onLine) { this.setStatus("offline"); return null; }
    this.setStatus("syncing");
    try {
      const res = await fetch(`${DRIVE_CONFIG.GAS_URL}?action=loadAll`, { redirect: "follow" });
      const text = await res.text();
      const data = JSON.parse(text);
      if (data.error) throw new Error(data.error);
      this._lastSyncTime = new Date();
      this.setStatus("success");
      return data;
    } catch (err) {
      console.error("[DriveSync] loadAll error:", err);
      this.setStatus("error");
      return null;
    }
  },

  // íŒŒì¼ ì—…ë¡œë“œ
  async uploadFile(projectName, fileName, base64Data, mimeType) {
    if (!DRIVE_CONFIG.ENABLED) { toast("Google Driveê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "error"); return null; }
    this.setStatus("syncing");
    try {
      const res = await fetch(DRIVE_CONFIG.GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({ action: "uploadFile", projectName, fileName, base64Data, mimeType }),
        redirect: "follow",
      });
      const text = await res.text();
      const result = JSON.parse(text);
      if (result.error) throw new Error(result.error);
      this._lastSyncTime = new Date();
      this.setStatus("success");
      return result;
    } catch (err) {
      console.error("[DriveSync] uploadFile error:", err);
      this.setStatus("error");
      return null;
    }
  },

  // íŒŒì¼ ëª©ë¡ ì¡°íšŒ
  async listFiles(projectName) {
    if (!DRIVE_CONFIG.ENABLED) return [];
    try {
      const res = await fetch(`${DRIVE_CONFIG.GAS_URL}?action=listFiles&projectName=${encodeURIComponent(projectName)}`, { redirect: "follow" });
      const text = await res.text();
      const result = JSON.parse(text);
      return result.files || [];
    } catch (err) {
      console.error("[DriveSync] listFiles error:", err);
      return [];
    }
  },
};

// ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ê°ì§€
if (typeof window !== "undefined") {
  window.addEventListener("online", () => { if (SyncManager._status === "offline") SyncManager.setStatus("idle"); });
  window.addEventListener("offline", () => SyncManager.setStatus("offline"));
}

// usePersistedState: useState + localStorage ìë™ ë™ê¸°í™”
function usePersistedState(key, defaultValue) {
  const [state, setState] = useState(() => {
    try {
      const saved = localStorage.getItem(key);
      if (saved !== null) return JSON.parse(saved);
    } catch {}
    return defaultValue;
  });

  const setPersistedState = useCallback((valOrFn) => {
    setState(prev => {
      const next = typeof valOrFn === "function" ? valOrFn(prev) : valOrFn;
      try { localStorage.setItem(key, JSON.stringify(next)); } catch {}
      return next;
    });
  }, [key]);

  return [state, setPersistedState];
}

// useSyncStatus: SyncManager ìƒíƒœë¥¼ React ìƒíƒœë¡œ ì—°ê²°
function useSyncStatus() {
  const [status, setStatus] = useState(SyncManager.getStatus());
  const [lastSync, setLastSync] = useState(SyncManager._lastSyncTime);
  useEffect(() => {
    return SyncManager.subscribe((s, t) => { setStatus(s); setLastSync(t); });
  }, []);
  return { status, lastSync };
}

// SyncStatusBar ì»´í¬ë„ŒíŠ¸: Topbarì— í‘œì‹œë˜ëŠ” ë™ê¸°í™” ìƒíƒœ
function SyncStatusBar() {
  const { status, lastSync } = useSyncStatus();
  if (!DRIVE_CONFIG.ENABLED) {
    return (
      <div style={{display:"flex",alignItems:"center",gap:5,padding:"3px 10px",borderRadius:6,
        background:"rgba(245,158,11,.1)",border:"1px solid rgba(245,158,11,.2)",fontSize:11,color:"#fbbf24",whiteSpace:"nowrap"}}>
        <span>ğŸ“</span><span>Drive ë¯¸ì—°ê²°</span>
      </div>
    );
  }
  const configs = {
    idle:    { icon:"â˜ï¸", text:"ëŒ€ê¸°", bg:"rgba(255,255,255,.04)", border:"var(--border)", color:"var(--txt4)" },
    syncing: { icon:"ğŸ”„", text:"ì €ì¥ ì¤‘...", bg:"rgba(99,102,241,.1)", border:"rgba(99,102,241,.2)", color:"#a5b4fc" },
    success: { icon:"âœ…", text: lastSync ? `${lastSync.toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"})} ë™ê¸°í™”` : "ë™ê¸°í™”ë¨", bg:"rgba(16,185,129,.08)", border:"rgba(16,185,129,.2)", color:"#34d399" },
    error:   { icon:"âš ï¸", text:"ë™ê¸°í™” ì‹¤íŒ¨", bg:"rgba(239,68,68,.08)", border:"rgba(239,68,68,.2)", color:"#fca5a5" },
    offline: { icon:"ğŸ“´", text:"ì˜¤í”„ë¼ì¸", bg:"rgba(107,114,128,.1)", border:"rgba(107,114,128,.2)", color:"#9ca3af" },
  };
  const c = configs[status] || configs.idle;
  return (
    <div style={{display:"flex",alignItems:"center",gap:5,padding:"3px 10px",borderRadius:6,
      background:c.bg,border:`1px solid ${c.border}`,fontSize:11,color:c.color,whiteSpace:"nowrap",
      transition:"all .3s"}}>
      <span style={status==="syncing"?{animation:"spin 1s linear infinite"}:{}}>{c.icon}</span>
      <span>{c.text}</span>
    </div>
  );
}

/* â”€â”€ ë¡œê·¸ì¸ í˜ì´ì§€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function LoginPage({ onLogin, users }) {
  const [uid, setUid] = useState("");
  const [pw, setPw] = useState("");
  const [showPw, setShowPw] = useState(false);
  const [error, setError] = useState("");
  const [errorType, setErrorType] = useState("default"); // "default" | "not_approved" | "blocked"
  const [attempts, setAttempts] = useState(0);
  const [locked, setLocked] = useState(false);
  const [lockEnd, setLockEnd] = useState(null);
  const [lockRemain, setLockRemain] = useState(0);
  const [loading, setLoading] = useState(false);
  const pwRef = useRef(null);

  // ì ê¸ˆ ì¹´ìš´íŠ¸ë‹¤ìš´
  useEffect(() => {
    if (!locked || !lockEnd) return;
    const tick = setInterval(() => {
      const remain = Math.ceil((lockEnd - Date.now()) / 1000);
      if (remain <= 0) { setLocked(false); setAttempts(0); setLockEnd(null); clearInterval(tick); }
      else setLockRemain(remain);
    }, 1000);
    return () => clearInterval(tick);
  }, [locked, lockEnd]);

  const handleLogin = async () => {
    if (locked) return;
    setError(""); setErrorType("default");
    if (!uid.trim() || !pw) { setError("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
    setLoading(true);
    await new Promise(r => setTimeout(r, 700));
    // í˜„ì¬ ìµœì‹  users ëª©ë¡ì—ì„œ í™•ì¸
    const matchId = users.find(u => u.id === uid.trim().toLowerCase());
    const matchFull = matchId && matchId.pw === pw;
    setLoading(false);

    if (matchFull) {
      // adminì€ í•­ìƒ í†µê³¼, ë‚˜ë¨¸ì§€ëŠ” approved ì²´í¬
      if (matchId.id === "admin" || matchId.approved) {
        setAttempts(0);
        onLogin(matchId);
      } else {
        // ê³„ì • ì¡´ì¬í•˜ì§€ë§Œ ë¯¸ìŠ¹ì¸ â†’ ì ê¸ˆ ì¹´ìš´íŠ¸ ì•ˆ í•¨
        setErrorType("not_approved");
        setError(`"${matchId.name}" ê³„ì •ì€ ì•„ì§ ê´€ë¦¬ì ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\nì ‘ê·¼ ìŠ¹ì¸ ìš”ì²­: kimjh@epicstage.co.kr`);
        setPw("");
      }
    } else {
      const next = attempts + 1;
      setAttempts(next);
      if (next >= MAX_ATTEMPTS) {
        setLocked(true);
        const end = Date.now() + LOCK_MINUTES * 60 * 1000;
        setLockEnd(end);
        setLockRemain(LOCK_MINUTES * 60);
        setErrorType("default");
        setError(`ë¡œê·¸ì¸ ì‹œë„ ${MAX_ATTEMPTS}íšŒ ì´ˆê³¼. ${LOCK_MINUTES}ë¶„ê°„ ì ê¸ˆë©ë‹ˆë‹¤.`);
      } else {
        setErrorType("default");
        setError(`ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (${next}/${MAX_ATTEMPTS}íšŒ)`);
      }
      setPw("");
    }
  };

  const lockMin = Math.floor(lockRemain / 60);
  const lockSec = lockRemain % 60;

  return (
    <div className="login-wrap">
      <div className="login-bg-orb" style={{width:500,height:500,background:"rgba(99,102,241,.10)",top:-150,right:-100}}/>
      <div className="login-bg-orb" style={{width:350,height:350,background:"rgba(236,72,153,.07)",bottom:-100,left:-80}}/>
      <div className="login-bg-orb" style={{width:200,height:200,background:"rgba(16,185,129,.05)",top:"40%",left:"10%"}}/>

      <div className="login-card">
        {/* ë¡œê³  */}
        <div className="login-logo">
          <div className="login-logo-icon">E</div>
          <div className="login-brand">EpicStage EventOS</div>
          <div className="login-sub">í–‰ì‚¬ ê¸°íš í†µí•© ìš´ì˜ í¬í„¸</div>
        </div>

        <div className="login-divider"/>

        {/* ì—ëŸ¬/ìƒíƒœ ë©”ì‹œì§€ */}
        {locked && (
          <div className="login-error" style={{background:"rgba(239,68,68,.1)"}}>
            ğŸ”’ <span>ê³„ì • ì ê¸ˆ: {lockMin}ë¶„ {lockSec.toString().padStart(2,"0")}ì´ˆ í›„ í•´ì œë©ë‹ˆë‹¤</span>
          </div>
        )}
        {error && !locked && errorType === "not_approved" && (
          <div className="login-error" style={{background:"rgba(245,158,11,.1)",borderColor:"rgba(245,158,11,.3)",color:"#fbbf24",flexDirection:"column",alignItems:"flex-start",gap:6}}>
            <span style={{fontWeight:700}}>ğŸ”‘ ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ</span>
            <span style={{whiteSpace:"pre-line",fontSize:12}}>{error}</span>
          </div>
        )}
        {error && !locked && errorType === "default" && (
          <div className="login-error">âš ï¸ <span>{error}</span></div>
        )}

        {/* ì•„ì´ë”” */}
        <div className="login-field">
          <label className="login-field-label">ì‚¬ë²ˆ / ì•„ì´ë””</label>
          <span className="field-icon">ğŸ‘¤</span>
          <input
            type="text" placeholder="ì•„ì´ë”” ì…ë ¥" value={uid} autoComplete="username"
            onChange={e => { setUid(e.target.value); setError(""); setErrorType("default"); }}
            onKeyDown={e => e.key === "Enter" && pwRef.current?.focus()}
            disabled={locked}
          />
        </div>

        {/* ë¹„ë°€ë²ˆí˜¸ */}
        <div className="login-field">
          <label className="login-field-label">ë¹„ë°€ë²ˆí˜¸</label>
          <span className="field-icon">ğŸ”‘</span>
          <input
            ref={pwRef} type={showPw ? "text" : "password"}
            placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" value={pw} autoComplete="current-password"
            onChange={e => { setPw(e.target.value); setError(""); setErrorType("default"); }}
            onKeyDown={e => e.key === "Enter" && !locked && handleLogin()}
            disabled={locked} style={{paddingRight:44}}
          />
          <button className="pw-toggle" tabIndex={-1} onClick={() => setShowPw(v => !v)}>
            {showPw ? "ğŸ™ˆ" : "ğŸ‘ï¸"}
          </button>
        </div>

        <button className="login-btn" onClick={handleLogin} disabled={locked || loading}>
          {loading ? "ì¸ì¦ ì¤‘..." : locked ? `ğŸ”’ ì ê¸ˆ ì¤‘ (${lockMin}:${lockSec.toString().padStart(2,"0")})` : "ë¡œê·¸ì¸"}
        </button>

        {attempts > 0 && !locked && errorType === "default" && (
          <div className="login-attempts">ë‚¨ì€ ì‹œë„ íšŸìˆ˜: {MAX_ATTEMPTS - attempts}íšŒ</div>
        )}

        <div className="login-notice">
          <div className="login-notice-txt">
            ğŸ”’ ë³¸ í¬í„¸ì€ <strong style={{color:"#818cf8"}}>EpicStage ì„ì§ì› ì „ìš©</strong>ì…ë‹ˆë‹¤<br/>
            ê³„ì • ì‹ ì²­ Â· ìŠ¹ì¸ ë¬¸ì˜: <strong style={{color:"#818cf8"}}>kimjh@epicstage.co.kr</strong>
          </div>
        </div>
      </div>
    </div>
  );
}

/* â”€â”€ ê´€ë¦¬ì íŒ¨ë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function AdminPanel({ users, onUsersChange, priceList, onPriceListChange }) {
  const [adminTab, setAdminTab] = useState("users"); // "users" | "prices"
  const [showAdd, setShowAdd] = useState(false);
  const [newUser, setNewUser] = useState({ id:"", pw:"", name:"", role:"", producer:"", isAdmin:false });
  const [confirmRevoke, setConfirmRevoke] = useState(null);
  const [editingUser, setEditingUser] = useState(null); // { id, name, role, pw, producer, isAdmin }
  const [search, setSearch] = useState("");
  // ê¸°ì¤€ ê¸ˆì•¡ ê´€ë¦¬
  const [editingPrice, setEditingPrice] = useState(null); // { id, item, division, category, unitPrice, qty, days }
  const [newPrice, setNewPrice] = useState({division:"ê¸°íš", category:"ê¸°íš", item:"", baseAmount:"", qty:"1", days:"1"});
  const [showNewPrice, setShowNewPrice] = useState(false);
  const [priceSearch, setPriceSearch] = useState("");

  // ìŠ¹ì¸ í† ê¸€
  const toggleApprove = (userId) => {
    if (userId === "admin") return; // adminì€ í•­ìƒ ìœ ì§€
    const target = users.find(u => u.id === userId);
    const willApprove = !target.approved;
    if (!willApprove) {
      setConfirmRevoke(userId);
      return;
    }
    onUsersChange(users.map(u =>
      u.id === userId
        ? { ...u, approved: true }
        : u
    ));
    toast(`âœ… ${target.name} ê³„ì •ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, "success");
  };

  const doRevoke = () => {
    const target = users.find(u => u.id === confirmRevoke);
    onUsersChange(users.map(u =>
      u.id === confirmRevoke ? { ...u, approved: false } : u
    ));
    toast(`ğŸš« ${target.name} ê³„ì • ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.`, "warn");
    setConfirmRevoke(null);
  };

  // ì‹ ê·œ ê³„ì • ì¶”ê°€
  const addUser = () => {
    if (!newUser.id || !newUser.pw || !newUser.name || !newUser.role) {
      toast("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "error"); return;
    }
    if (users.find(u => u.id === newUser.id.trim().toLowerCase())) {
      toast("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.", "error"); return;
    }
    const idx = users.length % USER_COLORS.length;
    const u = {
      id: newUser.id.trim().toLowerCase(),
      pw: newUser.pw,
      name: newUser.name,
      role: newUser.role,
      color: USER_COLORS[idx],
      initial: newUser.name.charAt(0),
      producer: newUser.producer || null,
      isAdmin: newUser.isAdmin || false,
      approved: newUser.isAdmin ? true : false, // ê´€ë¦¬ìëŠ” ìë™ ìŠ¹ì¸
      createdAt: today,
      lastLogin: null,
    };
    onUsersChange([...users, u]);
    setNewUser({ id:"", pw:"", name:"", role:"", producer:"", isAdmin:false });
    setShowAdd(false);
    const msg = u.isAdmin
      ? `âœ… ê´€ë¦¬ì ê³„ì • "${u.name}"ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`
      : `ğŸ‘¤ "${u.name}" ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ìŠ¹ì¸ í›„ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.`;
    toast(msg, "success");
  };

  // ê³„ì • ìˆ˜ì • ì €ì¥
  const saveUserEdit = () => {
    if (!editingUser.name || !editingUser.role) { toast("ì´ë¦„ê³¼ ì§ì±…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤","error"); return; }
    onUsersChange(users.map(u => u.id === editingUser.id ? {
      ...u,
      name:     editingUser.name,
      role:     editingUser.role,
      pw:       editingUser.pw || u.pw,
      producer: editingUser.producer || null,
      isAdmin:  editingUser.isAdmin,
      initial:  editingUser.name.charAt(0),
      // ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬ ì‹œ ìë™ ìŠ¹ì¸ ì²˜ë¦¬
      approved: editingUser.isAdmin ? true : u.approved,
    } : u));
    toast(`âœ… ${editingUser.name} ê³„ì • ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤`, "success");
    setEditingUser(null);
  };

  // ê³„ì • ì‚­ì œ
  const deleteUser = (userId) => {
    if (userId === "admin") return;
    const target = users.find(u => u.id === userId);
    onUsersChange(users.filter(u => u.id !== userId));
    toast(`ğŸ—‘ï¸ "${target.name}" ê³„ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
  };

  const filtered = users.filter(u =>
    !search || u.name.includes(search) || u.id.includes(search) || u.role.includes(search)
  );
  const approved = users.filter(u => u.approved).length;
  const pending  = users.filter(u => !u.approved).length;

  // ê¸°ì¤€ ê¸ˆì•¡ í•¸ë“¤ëŸ¬ (ì‹ ê·œ êµ¬ì¡°: unitPrice ê¸°ì¤€)
  const savePriceEdit = (id) => {
    if (!editingPrice.item?.trim()) { toast("í•­ëª©ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”","error"); return; }
    const val = parseInt(String(editingPrice.unitPrice).replace(/,/g,"")) || 0;
    onPriceListChange(priceList.map(p => p.id===id ? {
      ...p,
      item:      editingPrice.item.trim(),
      division:  editingPrice.division,
      category:  editingPrice.category,
      unitPrice: val,
      qty:       parseInt(editingPrice.qty)||1,
      days:      parseInt(editingPrice.days)||1,
    } : p));
    setEditingPrice(null);
    toast("âœ… ê¸°ì¤€ í•­ëª©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤","success");
  };
  const deletePrice = (id) => {
    const target = priceList.find(p=>p.id===id);
    onPriceListChange(priceList.filter(p => p.id!==id));
    toast(`ğŸ—‘ï¸ "${target?.item}" ê¸°ì¤€ í•­ëª© ì‚­ì œë¨`);
  };
  const addPriceItem = () => {
    if (!newPrice.item.trim()) { toast("í•­ëª©ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”","error"); return; }
    const item = {
      id: Date.now(),
      division: newPrice.division||"ê¸°íš",
      category: newPrice.category,
      item: newPrice.item,
      unitPrice: parseInt(String(newPrice.baseAmount).replace(/,/g,""))||0,
      qty: parseInt(newPrice.qty)||1,
      days: parseInt(newPrice.days)||1,
    };
    onPriceListChange([...priceList, item]);
    setNewPrice({division:"ê¸°íš", category:"ê¸°íš", item:"", baseAmount:"", qty:"1", days:"1"});
    setShowNewPrice(false);
    toast(`âœ… "${item.item}" ê¸°ì¤€ í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`,"success");
  };
  const filteredPrices = priceList.filter(p =>
    !priceSearch || p.item.includes(priceSearch) || p.category.includes(priceSearch) || (p.division||"").includes(priceSearch)
  );
  const priceDivs = [...new Set(priceList.map(p=>p.division||"ê¸°íƒ€"))];
  const totalBaseAmt = priceList.reduce((s,p)=>s+(p.unitPrice||0)*(p.qty||1)*(p.days||1),0);

  return (
    <div>
      <div style={{marginBottom:20}}>
        <h1 style={{color:"var(--txt)",fontSize:20,fontWeight:800,marginBottom:4}}>âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h1>
        <div style={{color:"var(--txt4)",fontSize:13}}>ê´€ë¦¬ì ì „ìš© Â· ê¶Œí•œ ê´€ë¦¬ ë° ê¸°ì¤€ ê¸ˆì•¡ ì„¤ì •</div>
      </div>

      {/* íƒ­ */}
      <div className="tab-bar" style={{marginBottom:20}}>
        <button className={`tab-btn${adminTab==="users"?" active":""}`} onClick={()=>setAdminTab("users")}>ğŸ‘¥ ì ‘ê·¼ ê¶Œí•œ ê´€ë¦¬</button>
        <button className={`tab-btn${adminTab==="prices"?" active":""}`} onClick={()=>setAdminTab("prices")}>ğŸ’° ê¸°ì¤€ ê¸ˆì•¡ ê´€ë¦¬</button>
      </div>

      {/* â•â• ê¸°ì¤€ ê¸ˆì•¡ íƒ­ â•â• */}
      {adminTab==="prices" && (
        <div>
          {/* ìƒë‹¨ í†µê³„ */}
          <div className="grid-3" style={{marginBottom:20}}>
            <div className="stat-card"><div className="stat-label">ê¸°ì¤€ í•­ëª© ìˆ˜</div><div className="stat-value">{priceList.length}</div></div>
            <div className="stat-card"><div className="stat-label">êµ¬ë¶„ ìˆ˜</div><div className="stat-value">{priceDivs.length}</div></div>
            <div className="stat-card"><div className="stat-label">ê¸°ì¤€ ê¸ˆì•¡ í•©ê³„</div><div className="stat-value" style={{fontSize:18,color:"#f59e0b"}}>{(totalBaseAmt/10000).toLocaleString()}ë§Œì›</div></div>
          </div>

          {/* ì•ˆë‚´ ë°°ë„ˆ */}
          <div style={{
            background:"rgba(99,102,241,.06)",border:"1px solid rgba(99,102,241,.15)",
            borderRadius:10,padding:"10px 14px",marginBottom:16,
            display:"flex",alignItems:"center",gap:10,
          }}>
            <span style={{fontSize:18}}>â„¹ï¸</span>
            <span style={{color:"#94a3b8",fontSize:13,lineHeight:1.5}}>
              ì—¬ê¸°ì„œ ì„¤ì •í•œ ê¸°ì¤€ ê¸ˆì•¡ì€ <strong style={{color:"#a5b4fc"}}>ì‹ ê·œ í”„ë¡œì íŠ¸ ìƒì„± ì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸ ê¸°ë³¸ê°’</strong>ìœ¼ë¡œ ìë™ ì ìš©ë©ë‹ˆë‹¤.
              ê¸°ì¡´ í”„ë¡œì íŠ¸ í•­ëª©ì€ ë³€ê²½ë˜ì§€ ì•Šìœ¼ë©°, ê° í”„ë¡œì íŠ¸ì—ì„œ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </span>
          </div>

          {/* ë„êµ¬ë°” */}
          <div style={{display:"flex",gap:10,marginBottom:14,flexWrap:"wrap",alignItems:"center"}}>
            <input className="form-input" placeholder="ğŸ” í•­ëª©ëª…, ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰"
              value={priceSearch} onChange={e=>setPriceSearch(e.target.value)}
              style={{flex:1,minWidth:160,maxWidth:280}}/>
            <button className="btn btn-primary" onClick={()=>setShowNewPrice(v=>!v)}>
              {showNewPrice ? "âœ• ë‹«ê¸°" : "â• ê¸°ì¤€ í•­ëª© ì¶”ê°€"}
            </button>
          </div>

          {/* ì‹ ê·œ í•­ëª© ì¶”ê°€ í¼ */}
          {showNewPrice && (
            <div className="card" style={{marginBottom:16,borderColor:"rgba(245,158,11,.25)"}}>
              <div style={{color:"#fbbf24",fontWeight:700,fontSize:14,marginBottom:14}}>â• ê¸°ì¤€ í•­ëª© ì¶”ê°€</div>
              <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"flex-end"}}>
                <div className="form-group" style={{marginBottom:0,flex:"0 0 110px"}}>
                  <label className="form-label">êµ¬ë¶„</label>
                  <select className="form-input" value={newPrice.division} onChange={e=>setNewPrice({...newPrice,division:e.target.value,category:DIV_CATS[e.target.value][0]})}
                    style={{padding:"9px 10px",fontSize:13}}>
                    {DIVISIONS.map(d=><option key={d}>{d}</option>)}
                  </select>
                </div>
                <div className="form-group" style={{marginBottom:0,flex:"0 0 110px"}}>
                  <label className="form-label">ì„¸ë¶€í•­ëª©</label>
                  <select className="form-input" value={newPrice.category} onChange={e=>setNewPrice({...newPrice,category:e.target.value})}
                    style={{padding:"9px 10px",fontSize:13}}>
                    {(DIV_CATS[newPrice.division]||[]).map(c=><option key={c}>{c}</option>)}
                  </select>
                </div>
                <div className="form-group" style={{marginBottom:0,flex:2,minWidth:120}}>
                  <label className="form-label">í•­ëª©ëª… *</label>
                  <input className="form-input" placeholder="ì˜ˆ: íŠ¹ìˆ˜ ì¡°ëª… ì¥ì¹˜" value={newPrice.item}
                    onChange={e=>setNewPrice({...newPrice,item:e.target.value})}/>
                </div>
                <div className="form-group" style={{marginBottom:0,flex:"0 0 110px"}}>
                  <label className="form-label">ê¸°ì¤€ ë‹¨ê°€ (ì›)</label>
                  <input className="form-input" placeholder="ì˜ˆ: 2500000" value={newPrice.baseAmount}
                    onChange={e=>setNewPrice({...newPrice,baseAmount:e.target.value})}/>
                </div>
                <div className="form-group" style={{marginBottom:0,width:56}}>
                  <label className="form-label">ê¸°ë³¸ ìˆ˜ëŸ‰</label>
                  <input className="form-input" value={newPrice.qty} onChange={e=>setNewPrice({...newPrice,qty:e.target.value})} style={{padding:"9px 8px"}}/>
                </div>
                <div className="form-group" style={{marginBottom:0,width:56}}>
                  <label className="form-label">ê¸°ë³¸ ì¼ì</label>
                  <input className="form-input" value={newPrice.days} onChange={e=>setNewPrice({...newPrice,days:e.target.value})}
                    onKeyDown={e=>e.key==="Enter"&&addPriceItem()} style={{padding:"9px 8px"}}/>
                </div>
                <button className="btn btn-primary" onClick={addPriceItem} style={{marginBottom:0,flexShrink:0}}>ì¶”ê°€</button>
              </div>
            </div>
          )}

          {/* êµ¬ë¶„ë³„ ëª©ë¡ */}
          {DIVISIONS.map(div => {
            const divItems = filteredPrices.filter(p=>(p.division||"ê¸°íƒ€")===div);
            if (!divItems.length) return null;
            const cats = [...new Set(divItems.map(p=>p.category))];
            const divColor = DIV_COLORS[div]||"#6366f1";
            return (
              <div key={div} style={{marginBottom:20}}>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:10,paddingBottom:6,borderBottom:`1px solid ${divColor}33`}}>
                  <span style={{color:divColor,fontSize:12,fontWeight:800,textTransform:"uppercase",letterSpacing:".08em"}}>{div}</span>
                  <span style={{color:"var(--txt4)",fontSize:11}}>({divItems.length}ê°œ)</span>
                  <span style={{marginLeft:"auto",color:"var(--txt3)",fontSize:11}}>
                    ì†Œê³„: {divItems.reduce((s,p)=>s+(p.unitPrice||0)*(p.qty||1)*(p.days||1),0).toLocaleString()}ì›
                  </span>
                </div>
                {cats.map(cat => (
                  <div key={cat} style={{marginBottom:12}}>
                    <div style={{color:"var(--txt4)",fontSize:10,fontWeight:700,marginBottom:5,textTransform:"uppercase",letterSpacing:".04em",marginLeft:2}}>Â· {cat}</div>
                    {divItems.filter(p=>p.category===cat).map(price=>(
                      <div key={price.id} style={{
                        display:"flex",alignItems:"center",gap:10,padding:"9px 12px",borderRadius:8,
                        background:"rgba(255,255,255,.02)",border:"1px solid rgba(255,255,255,.05)",
                        marginBottom:4,flexWrap:"wrap",
                      }}>
                        <span style={{flex:1,color:"var(--txt)",fontSize:13,minWidth:100}}>{price.item}</span>
                        {editingPrice?.id===price.id ? (
                          <div style={{display:"flex",gap:5,alignItems:"center",flexShrink:0,flexWrap:"wrap"}}>
                            <input placeholder="í•­ëª©ëª… *" autoFocus
                              className="form-input"
                              value={editingPrice.item}
                              onChange={e=>setEditingPrice({...editingPrice,item:e.target.value})}
                              style={{width:120,padding:"5px 8px",fontSize:12}}
                            />
                            <select className="form-input"
                              value={editingPrice.division}
                              onChange={e=>setEditingPrice({...editingPrice,division:e.target.value,category:DIV_CATS[e.target.value][0]})}
                              style={{width:76,padding:"5px 6px",fontSize:11}}>
                              {DIVISIONS.map(d=><option key={d}>{d}</option>)}
                            </select>
                            <select className="form-input"
                              value={editingPrice.category}
                              onChange={e=>setEditingPrice({...editingPrice,category:e.target.value})}
                              style={{width:82,padding:"5px 6px",fontSize:11}}>
                              {(DIV_CATS[editingPrice.division]||[]).map(c=><option key={c}>{c}</option>)}
                            </select>
                            <input placeholder="ë‹¨ê°€(ì›)"
                              className="form-input"
                              value={editingPrice.unitPrice}
                              onChange={e=>setEditingPrice({...editingPrice,unitPrice:e.target.value})}
                              onKeyDown={e=>{if(e.key==="Enter")savePriceEdit(price.id);if(e.key==="Escape")setEditingPrice(null);}}
                              style={{width:100,padding:"5px 8px",fontSize:12,textAlign:"right"}}
                            />
                            <input placeholder="ìˆ˜ëŸ‰" type="number" min="1"
                              className="form-input"
                              value={editingPrice.qty}
                              onChange={e=>setEditingPrice({...editingPrice,qty:e.target.value})}
                              style={{width:50,padding:"5px 6px",fontSize:12,textAlign:"center"}}
                            />
                            <input placeholder="ì¼ì" type="number" min="1"
                              className="form-input"
                              value={editingPrice.days}
                              onChange={e=>setEditingPrice({...editingPrice,days:e.target.value})}
                              style={{width:50,padding:"5px 6px",fontSize:12,textAlign:"center"}}
                            />
                            <button className="admin-action-btn"
                              style={{background:"rgba(16,185,129,.1)",color:"#34d399",border:"1px solid rgba(16,185,129,.2)"}}
                              onClick={()=>savePriceEdit(price.id)}>ì €ì¥</button>
                            <button className="admin-action-btn"
                              style={{background:"transparent",color:"var(--txt4)",border:"1px solid var(--border)"}}
                              onClick={()=>setEditingPrice(null)}>ì·¨ì†Œ</button>
                          </div>
                        ) : (
                          <div style={{display:"flex",gap:8,alignItems:"center",flexShrink:0,flexWrap:"wrap"}}>
                            <span style={{color:"var(--txt4)",fontSize:11}}>
                              {price.qty||1}ê°œ Ã— {price.days||1}ì¼
                            </span>
                            <span style={{
                              color:(price.unitPrice||0)>0?"#fbbf24":"var(--txt4)",
                              fontSize:13,fontWeight:600,minWidth:90,textAlign:"right",
                            }}>
                              {(price.unitPrice||0)>0 ? (price.unitPrice).toLocaleString()+"ì›/ë‹¨ê°€" : "ë‹¨ê°€ ë¯¸ì„¤ì •"}
                            </span>
                            <button className="admin-action-btn"
                              style={{background:"rgba(99,102,241,.1)",color:"#a5b4fc",border:"1px solid rgba(99,102,241,.2)"}}
                              onClick={()=>setEditingPrice({id:price.id,item:price.item,division:price.division||"ê¸°íš",category:price.category,unitPrice:price.unitPrice||0,qty:price.qty||1,days:price.days||1})}>ìˆ˜ì •</button>
                            <button className="admin-action-btn"
                              style={{background:"rgba(239,68,68,.06)",color:"var(--txt4)",border:"1px solid rgba(239,68,68,.1)"}}
                              onClick={()=>deletePrice(price.id)}>ì‚­ì œ</button>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                ))}
              </div>
            );
          })}
          {filteredPrices.length===0 && (
            <div style={{textAlign:"center",color:"var(--txt4)",padding:32}}>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>
          )}
        </div>
      )}

      {/* â•â• ê¶Œí•œ ê´€ë¦¬ íƒ­ â•â• */}
      {adminTab==="users" && (<div>

      {/* í†µê³„ */}
      <div className="grid-3" style={{marginBottom:24}}>
        <div className="stat-card"><div className="stat-label">ì „ì²´ ê³„ì •</div><div className="stat-value">{users.length}</div></div>
        <div className="stat-card"><div className="stat-label">ìŠ¹ì¸ë¨</div><div className="stat-value" style={{color:"#10b981"}}>{approved}</div></div>
        <div className="stat-card"><div className="stat-label">ìŠ¹ì¸ ëŒ€ê¸°</div><div className="stat-value" style={{color:"#f59e0b"}}>{pending}</div></div>
      </div>

      {/* ë„êµ¬ë°” */}
      <div style={{display:"flex",gap:10,marginBottom:16,flexWrap:"wrap",alignItems:"center"}}>
        <input className="form-input" placeholder="ğŸ” ì´ë¦„, ì•„ì´ë””, ì—­í•  ê²€ìƒ‰"
          value={search} onChange={e=>setSearch(e.target.value)} style={{flex:1,minWidth:160,maxWidth:280}}/>
        <button className="btn btn-primary" onClick={()=>setShowAdd(v=>!v)}>
          {showAdd ? "âœ• ë‹«ê¸°" : "â• ê³„ì • ìƒì„±"}
        </button>
      </div>

      {/* ê³„ì • ìƒì„± í¼ */}
      {showAdd && (
        <div className="card" style={{marginBottom:20,borderColor:"rgba(99,102,241,.3)"}}>
          <div style={{color:"#a5b4fc",fontWeight:700,fontSize:14,marginBottom:16}}>â• ì‹ ê·œ ê³„ì • ìƒì„±</div>
          <div className="grid-2">
            {[
              {label:"ì•„ì´ë”” *",key:"id",placeholder:"ì˜ë¬¸ ì†Œë¬¸ì (ì˜ˆ: hong)"},
              {label:"ë¹„ë°€ë²ˆí˜¸ *",key:"pw",placeholder:"ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸"},
              {label:"ì´ë¦„ *",key:"name",placeholder:"ì‹¤ëª…"},
              {label:"ì§ì±… *",key:"role",placeholder:"ì˜ˆ: ê¸°íš PM"},
              {label:"í”„ë¡œë“€ì„œëª… (í”„ë¡œì íŠ¸ ì—°ë™)",key:"producer",placeholder:"ì´ë¦„ê³¼ ë™ì¼í•˜ê²Œ ì…ë ¥"},
            ].map(f=>(
              <div key={f.key} className="form-group" style={{marginBottom:10}}>
                <label className="form-label">{f.label}</label>
                <input className="form-input" placeholder={f.placeholder} value={newUser[f.key]}
                  onChange={e=>setNewUser({...newUser,[f.key]:e.target.value})}/>
              </div>
            ))}
          </div>
          {/* ê´€ë¦¬ì ê¶Œí•œ í† ê¸€ */}
          <div style={{
            background: newUser.isAdmin ? "rgba(168,85,247,.1)" : "rgba(255,255,255,.03)",
            border: `1px solid ${newUser.isAdmin ? "rgba(168,85,247,.35)" : "rgba(255,255,255,.08)"}`,
            borderRadius:8, padding:"12px 14px", marginBottom:14,
            display:"flex", alignItems:"center", gap:12, cursor:"pointer",
            transition:"all .2s",
          }} onClick={()=>setNewUser({...newUser,isAdmin:!newUser.isAdmin})}>
            <div style={{
              width:36, height:20, borderRadius:10, flexShrink:0,
              background: newUser.isAdmin ? "#a855f7" : "rgba(255,255,255,.15)",
              position:"relative", transition:"background .2s",
            }}>
              <div style={{
                position:"absolute", top:3, left: newUser.isAdmin ? 19 : 3,
                width:14, height:14, borderRadius:"50%", background:"#fff",
                transition:"left .2s",
              }}/>
            </div>
            <div>
              <div style={{color: newUser.isAdmin ? "#c084fc" : "var(--txt2)", fontWeight:600, fontSize:13}}>
                ğŸ”‘ ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬
              </div>
              <div style={{color:"var(--txt4)", fontSize:11, marginTop:2}}>
                {newUser.isAdmin ? "ê´€ë¦¬ì ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤. ìë™ ìŠ¹ì¸ ì²˜ë¦¬ë©ë‹ˆë‹¤." : "ì¼ë°˜ ì‚¬ìš©ìë¡œ ìƒì„±ë©ë‹ˆë‹¤. ìŠ¹ì¸ í›„ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤."}
              </div>
            </div>
          </div>
          {!newUser.isAdmin && (
            <div style={{background:"rgba(245,158,11,.08)",border:"1px solid rgba(245,158,11,.2)",borderRadius:8,padding:"8px 12px",marginBottom:14}}>
              <span style={{color:"#fbbf24",fontSize:12}}>âš ï¸ ìƒì„± í›„ ì•„ë˜ ëª©ë¡ì—ì„œ ì§ì ‘ <strong>ìŠ¹ì¸</strong>ì„ ëˆŒëŸ¬ì•¼ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
            </div>
          )}
          <div style={{display:"flex",gap:10,justifyContent:"flex-end"}}>
            <button className="btn btn-ghost" onClick={()=>setShowAdd(false)}>ì·¨ì†Œ</button>
            <button className="btn btn-primary" onClick={addUser}>ê³„ì • ìƒì„±</button>
          </div>
        </div>
      )}

      {/* ê³„ì • ëª©ë¡ */}
      <div>
        {filtered.map(u => {
          const statusCls = u.id==="admin" ? "approved" : u.approved ? "approved" : "pending";
          return (
            <div key={u.id} style={{marginBottom:6}}>
              <div className={`admin-user-row ${statusCls}`}>
                {/* ì•„ë°”íƒ€ */}
                <div style={{
                  width:38,height:38,borderRadius:"50%",background:u.color,
                  display:"flex",alignItems:"center",justifyContent:"center",
                  fontWeight:800,fontSize:15,color:"#fff",flexShrink:0,
                }}>{u.initial}</div>
                {/* ì •ë³´ */}
                <div style={{flex:1,minWidth:120}}>
                  <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
                    <span style={{color:"var(--txt)",fontWeight:700,fontSize:14}}>{u.name}</span>
                    {u.isAdmin && <span style={{background:"rgba(168,85,247,.15)",color:"#c084fc",fontSize:10,fontWeight:700,padding:"1px 7px",borderRadius:4}}>ê´€ë¦¬ì</span>}
                    {u.producer && <span style={{background:"rgba(99,102,241,.12)",color:"#a5b4fc",fontSize:10,padding:"1px 7px",borderRadius:4}}>í”„ë¡œë“€ì„œ</span>}
                  </div>
                  <div style={{color:"var(--txt4)",fontSize:12,marginTop:2}}>{u.role} &nbsp;Â·&nbsp; ID: {u.id}</div>
                  <div style={{color:"var(--txt4)",fontSize:11,marginTop:1}}>ìƒì„±: {u.createdAt} &nbsp;Â·&nbsp; ìµœê·¼ ë¡œê·¸ì¸: {u.lastLogin||"ì—†ìŒ"}</div>
                </div>
                {/* ìƒíƒœ */}
                <span className={`status-pill ${u.id==="admin"?"pill-approved":u.approved?"pill-approved":"pill-pending"}`}>
                  {u.id==="admin" ? "ê´€ë¦¬ì (ê³ ì •)" : u.approved ? "âœ… ìŠ¹ì¸ë¨" : "â³ ìŠ¹ì¸ ëŒ€ê¸°"}
                </span>
                {/* ì•¡ì…˜ */}
                <div style={{display:"flex",gap:6,flexShrink:0}}>
                  {/* í¸ì§‘ ë²„íŠ¼ (admin í¬í•¨ ëª¨ë“  ê³„ì •, ë‹¨ adminì€ ìê¸° ìì‹ ì´ë¯€ë¡œ ì œí•œì ) */}
                  {u.id !== "admin" && (
                    <button className="admin-action-btn"
                      style={{background:"rgba(99,102,241,.1)",color:"#a5b4fc",border:"1px solid rgba(99,102,241,.25)"}}
                      onClick={()=>setEditingUser({id:u.id,name:u.name,role:u.role,pw:"",producer:u.producer||"",isAdmin:u.isAdmin||false})}>
                      âœï¸ í¸ì§‘
                    </button>
                  )}
                  {u.id !== "admin" && (
                    <button className="admin-action-btn"
                      style={u.approved
                        ? {background:"rgba(239,68,68,.1)",color:"#fca5a5",border:"1px solid rgba(239,68,68,.2)"}
                        : {background:"rgba(16,185,129,.1)",color:"#34d399",border:"1px solid rgba(16,185,129,.2)"}}
                      onClick={() => toggleApprove(u.id)}>
                      {u.approved ? "ì°¨ë‹¨" : "ìŠ¹ì¸"}
                    </button>
                  )}
                  {u.id !== "admin" && (
                    <button className="admin-action-btn"
                      style={{background:"rgba(239,68,68,.06)",color:"var(--txt4)",border:"1px solid rgba(239,68,68,.1)"}}
                      onClick={() => deleteUser(u.id)}>
                      ì‚­ì œ
                    </button>
                  )}
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {/* ì°¨ë‹¨ í™•ì¸ ëª¨ë‹¬ */}
      {confirmRevoke && (
        <div className="modal-overlay" onClick={e=>e.target.classList.contains("modal-overlay")&&setConfirmRevoke(null)}>
          <div className="modal-box" style={{maxWidth:380}}>
            <div className="modal-title">ğŸš« ì ‘ê·¼ ì°¨ë‹¨ í™•ì¸</div>
            <div style={{color:"var(--txt2)",fontSize:14,marginBottom:18,lineHeight:1.6}}>
              <strong style={{color:"#fca5a5"}}>{users.find(u=>u.id===confirmRevoke)?.name}</strong> ë‹˜ì˜ í¬í„¸ ì ‘ê·¼ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.<br/>
              ì°¨ë‹¨ ì¦‰ì‹œ ë¡œê·¸ì¸ì´ ë¶ˆê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.
            </div>
            <div className="modal-actions">
              <button className="btn btn-ghost" onClick={()=>setConfirmRevoke(null)}>ì·¨ì†Œ</button>
              <button className="btn btn-danger" onClick={doRevoke}>ì°¨ë‹¨ í™•ì¸</button>
            </div>
          </div>
        </div>
      )}

      {/* ê³„ì • í¸ì§‘ ëª¨ë‹¬ */}
      {editingUser && (
        <div className="modal-overlay" onClick={e=>e.target.classList.contains("modal-overlay")&&setEditingUser(null)}>
          <div className="modal-box" style={{maxWidth:480}}>
            <div className="modal-title">âœï¸ ê³„ì • ì •ë³´ ìˆ˜ì •</div>
            <div style={{color:"var(--txt4)",fontSize:12,marginBottom:16}}>ID: <strong style={{color:"#a5b4fc"}}>{editingUser.id}</strong></div>
            <div className="grid-2">
              {[
                {label:"ì´ë¦„ *",key:"name",placeholder:"ì‹¤ëª…"},
                {label:"ì§ì±… *",key:"role",placeholder:"ì˜ˆ: ê¸°íš PM"},
                {label:"ìƒˆ ë¹„ë°€ë²ˆí˜¸",key:"pw",placeholder:"ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥"},
                {label:"í”„ë¡œë“€ì„œëª…",key:"producer",placeholder:"ì´ë¦„ê³¼ ë™ì¼í•˜ê²Œ ì…ë ¥"},
              ].map(f=>(
                <div key={f.key} className="form-group" style={{marginBottom:10}}>
                  <label className="form-label">{f.label}</label>
                  <input className="form-input" type={f.key==="pw"?"password":"text"}
                    placeholder={f.placeholder} value={editingUser[f.key]}
                    onChange={e=>setEditingUser({...editingUser,[f.key]:e.target.value})}/>
                </div>
              ))}
            </div>
            {/* ê´€ë¦¬ì ê¶Œí•œ í† ê¸€ */}
            <div style={{
              background: editingUser.isAdmin ? "rgba(168,85,247,.1)" : "rgba(255,255,255,.03)",
              border:`1px solid ${editingUser.isAdmin?"rgba(168,85,247,.35)":"rgba(255,255,255,.08)"}`,
              borderRadius:8,padding:"12px 14px",marginBottom:16,
              display:"flex",alignItems:"center",gap:12,cursor:"pointer",transition:"all .2s",
            }} onClick={()=>setEditingUser({...editingUser,isAdmin:!editingUser.isAdmin})}>
              <div style={{
                width:36,height:20,borderRadius:10,flexShrink:0,
                background:editingUser.isAdmin?"#a855f7":"rgba(255,255,255,.15)",
                position:"relative",transition:"background .2s",
              }}>
                <div style={{
                  position:"absolute",top:3,left:editingUser.isAdmin?19:3,
                  width:14,height:14,borderRadius:"50%",background:"#fff",
                  transition:"left .2s",
                }}/>
              </div>
              <div>
                <div style={{color:editingUser.isAdmin?"#c084fc":"var(--txt2)",fontWeight:600,fontSize:13}}>
                  ğŸ”‘ ê´€ë¦¬ì ê¶Œí•œ
                </div>
                <div style={{color:"var(--txt4)",fontSize:11,marginTop:2}}>
                  {editingUser.isAdmin ? "ì´ ê³„ì •ì€ ê´€ë¦¬ì ê¶Œí•œì„ ê°€ì§‘ë‹ˆë‹¤." : "ì¼ë°˜ ì‚¬ìš©ì ê¶Œí•œì…ë‹ˆë‹¤."}
                </div>
              </div>
            </div>
            <div style={{display:"flex",gap:10,justifyContent:"flex-end"}}>
              <button className="btn btn-ghost" onClick={()=>setEditingUser(null)}>ì·¨ì†Œ</button>
              <button className="btn btn-primary" onClick={saveUserEdit}>ì €ì¥</button>
            </div>
          </div>
        </div>
      )}
      </div>)} {/* â† ê¶Œí•œ ê´€ë¦¬ íƒ­ ë‹«ê¸° */}
    </div>
  );
}

/* â•â• ë°ì´í„° â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// êµ¬ë¶„(Division) > ì„¸ë¶€í•­ëª©(Category) êµ¬ì¡°
const DIVISIONS = ["ê¸°íš", "í…Œí¬ë‹ˆì»¬", "ì œì‘", "ê¸°íƒ€"];
const DIV_CATS = {
  "ê¸°íš":    ["ê¸°íš", "ë””ìì¸"],
  "í…Œí¬ë‹ˆì»¬": ["ìŒí–¥", "ì˜¤í¼ë ˆì´ì…˜", "ì¡°ëª…", "LED", "ë¯¸ë””ì–´", "ì˜ìƒ", "ì†¡ì¶œ"],
  "ì œì‘":    ["ì‚¬ì´ë‹ˆì§€", "íƒœê·¸", "ì—°ì¶œë¬¼", "ì˜ìƒ", "ë””ì§€í„¸"],
  "ê¸°íƒ€":    ["ì„­ì™¸", "ìš´ì†¡", "ì¸ë ¥", "ì§€ì •", "êµ¬ë§¤", "ë Œíƒˆ", "ê¸°íƒ€"],
};
const ALL_CATS = Object.values(DIV_CATS).flat();
const DIV_COLORS = { "ê¸°íš":"#6366f1", "í…Œí¬ë‹ˆì»¬":"#06b6d4", "ì œì‘":"#f59e0b", "ê¸°íƒ€":"#10b981" };

// adminì´ ê´€ë¦¬í•˜ëŠ” ê¸°ì¤€ ë‹¨ê°€ ëª©ë¡ (ë‹¨ê°€ Ã— ìˆ˜ëŸ‰ Ã— ì¼ì = ê¸ˆì•¡)
const INIT_PRICE_LIST = [
  // â”€â”€ ê¸°íš â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:101, division:"ê¸°íš", category:"ê¸°íš",    item:"ê¸°íší”„ë¡œë“€ì„œ",      unitPrice:500000,  qty:1, days:1 },
  { id:102, division:"ê¸°íš", category:"ê¸°íš",    item:"í”„ë¡œë“€ì„œ",          unitPrice:400000,  qty:1, days:1 },
  { id:103, division:"ê¸°íš", category:"ê¸°íš",    item:"í‚¥ì˜¤í”„ ë¯¸íŒ…",       unitPrice:0,       qty:1, days:1 },
  { id:104, division:"ê¸°íš", category:"ê¸°íš",    item:"ìš´ì˜ê³„íšì•ˆ ì‘ì„±",   unitPrice:500000,  qty:1, days:1 },
  { id:111, division:"ê¸°íš", category:"ë””ìì¸",  item:"í‚¤ë¹„ì£¼ì–¼",          unitPrice:1500000, qty:1, days:1 },
  { id:112, division:"ê¸°íš", category:"ë””ìì¸",  item:"ë°°ë¦¬ì—ì´ì…˜",        unitPrice:500000,  qty:1, days:1 },
  { id:113, division:"ê¸°íš", category:"ë””ìì¸",  item:"ê¸°íƒ€ ë””ìì¸",       unitPrice:300000,  qty:1, days:1 },
  // â”€â”€ í…Œí¬ë‹ˆì»¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:201, division:"í…Œí¬ë‹ˆì»¬", category:"ìŒí–¥",       item:"PAì‹œìŠ¤í…œ",          unitPrice:3000000, qty:1, days:1 },
  { id:202, division:"í…Œí¬ë‹ˆì»¬", category:"ìŒí–¥",       item:"ìŒí–¥ ì˜¤í¼ë ˆì´í„°",   unitPrice:400000,  qty:1, days:1 },
  { id:211, division:"í…Œí¬ë‹ˆì»¬", category:"ì˜¤í¼ë ˆì´ì…˜", item:"ë¬´ëŒ€ ì˜¤í¼ë ˆì´ì…˜",   unitPrice:500000,  qty:1, days:1 },
  { id:221, division:"í…Œí¬ë‹ˆì»¬", category:"ì¡°ëª…",       item:"ì¡°ëª… íŒ¨í‚¤ì§€",       unitPrice:2500000, qty:1, days:1 },
  { id:222, division:"í…Œí¬ë‹ˆì»¬", category:"ì¡°ëª…",       item:"ì¡°ëª… ì˜¤í¼ë ˆì´í„°",   unitPrice:400000,  qty:1, days:1 },
  { id:231, division:"í…Œí¬ë‹ˆì»¬", category:"LED",        item:"LED ì›”",           unitPrice:5000000, qty:1, days:1 },
  { id:241, division:"í…Œí¬ë‹ˆì»¬", category:"ë¯¸ë””ì–´",     item:"ë¯¸ë””ì–´ ì„œë²„",       unitPrice:2000000, qty:1, days:1 },
  { id:251, division:"í…Œí¬ë‹ˆì»¬", category:"ì˜ìƒ",       item:"ì˜ìƒ ì´¬ì˜",         unitPrice:1500000, qty:1, days:1 },
  { id:252, division:"í…Œí¬ë‹ˆì»¬", category:"ì˜ìƒ",       item:"ì˜ìƒ í¸ì§‘",         unitPrice:1000000, qty:1, days:1 },
  { id:261, division:"í…Œí¬ë‹ˆì»¬", category:"ì†¡ì¶œ",       item:"ì˜¨ë¼ì¸ ì†¡ì¶œ",       unitPrice:2000000, qty:1, days:1 },
  // â”€â”€ ì œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:301, division:"ì œì‘", category:"ì‚¬ì´ë‹ˆì§€", item:"ì‚¬ì´ë‹ˆì§€ ì œì‘",    unitPrice:800000,  qty:1, days:1 },
  { id:311, division:"ì œì‘", category:"íƒœê·¸",     item:"í˜„ìˆ˜ë§‰/ë°°ë„ˆ",      unitPrice:300000,  qty:1, days:1 },
  { id:321, division:"ì œì‘", category:"ì—°ì¶œë¬¼",   item:"ë¬´ëŒ€ ì—°ì¶œë¬¼",      unitPrice:5000000, qty:1, days:1 },
  { id:331, division:"ì œì‘", category:"ì˜ìƒ",     item:"í”„ë¡œëª¨ì…˜ ì˜ìƒ",    unitPrice:3000000, qty:1, days:1 },
  { id:341, division:"ì œì‘", category:"ë””ì§€í„¸",   item:"ëª¨ì…˜ê·¸ë˜í”½",       unitPrice:2000000, qty:1, days:1 },
  // â”€â”€ ê¸°íƒ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:401, division:"ê¸°íƒ€", category:"ì„­ì™¸",   item:"ì‚¬íšŒì(MC)",        unitPrice:1500000, qty:1, days:1 },
  { id:402, division:"ê¸°íƒ€", category:"ì„­ì™¸",   item:"ëª¨ë¸/ë„ìš°ë¯¸",       unitPrice:500000,  qty:1, days:1 },
  { id:411, division:"ê¸°íƒ€", category:"ìš´ì†¡",   item:"ì°¨ëŸ‰ ìš´ì†¡ë¹„",       unitPrice:300000,  qty:1, days:1 },
  { id:421, division:"ê¸°íƒ€", category:"ì¸ë ¥",   item:"í–‰ì‚¬ ìŠ¤íƒœí”„",       unitPrice:150000,  qty:5, days:1 },
  { id:422, division:"ê¸°íƒ€", category:"ì¸ë ¥",   item:"ì•ˆë‚´ìš”ì›",          unitPrice:130000,  qty:3, days:1 },
  { id:431, division:"ê¸°íƒ€", category:"ì§€ì •",   item:"ì§€ì • ì—…ì²´ë¹„",       unitPrice:1000000, qty:1, days:1 },
  { id:441, division:"ê¸°íƒ€", category:"êµ¬ë§¤",   item:"ì†Œëª¨í’ˆ êµ¬ë§¤",       unitPrice:300000,  qty:1, days:1 },
  { id:451, division:"ê¸°íƒ€", category:"ë Œíƒˆ",   item:"ì¥ë¹„ ë Œíƒˆ",         unitPrice:500000,  qty:1, days:1 },
  { id:461, division:"ê¸°íƒ€", category:"ê¸°íƒ€",   item:"ê¸°íƒ€ ë¹„ìš©",         unitPrice:0,       qty:1, days:1 },
];
const STATUS_COLORS = { ì§„í–‰ì¤‘:"#6366f1", ì¤€ë¹„ì¤‘:"#f59e0b", ì™„ë£Œ:"#10b981", ë³´ë¥˜:"#6b7280" };

const INIT_PROJECTS = [
  {
    id:1, name:"2025 í•œêµ­ì „ìì „ KES", client:"ì‚¼ì„±ì „ì", producer:"ê¹€ì§€í˜„",
    status:"ì§„í–‰ì¤‘", progress:68, budget:85000000, cost:61200000,
    startDate:"2025-09-01", eventDate:"2025-10-15", endDate:"2025-10-18",
    tags:["ì „ì‹œ","B2B"],
    checklist:[
      {id:1, division:"ê¸°íš",    category:"ê¸°íš",   item:"í‚¥ì˜¤í”„ ë¯¸íŒ…",      done:true,  unitPrice:0,        qty:1,  days:1, note:""},
      {id:2, division:"ê¸°íš",    category:"ê¸°íš",   item:"ê³¼ì—…ì§€ì‹œì„œ ìˆ˜ë ¹",  done:true,  unitPrice:0,        qty:1,  days:1, note:""},
      {id:3, division:"ê¸°íš",    category:"ê¸°íš",   item:"ìš´ì˜ê³„íšì•ˆ ì‘ì„±",  done:true,  unitPrice:500000,   qty:1,  days:1, note:""},
      {id:4, division:"ì œì‘",    category:"ì—°ì¶œë¬¼", item:"ë¶€ìŠ¤ ì„¤ê³„/ë„ë©´",   done:true,  unitPrice:3200000,  qty:1,  days:1, note:""},
      {id:5, division:"ì œì‘",    category:"ì—°ì¶œë¬¼", item:"ì‹œê³µì—…ì²´ ì„ ì •",    done:true,  unitPrice:15000000, qty:1,  days:1, note:""},
      {id:6, division:"í…Œí¬ë‹ˆì»¬",category:"ì˜ìƒ",   item:"ë©”ì¸ ì˜ìƒ ì œì‘",   done:false, unitPrice:8000000,  qty:1,  days:1, note:""},
      {id:7, division:"ê¸°íš",    category:"ë””ìì¸", item:"í™ë³´ ì½˜í…ì¸ ",      done:false, unitPrice:2500000,  qty:1,  days:1, note:""},
      {id:8, division:"ê¸°íƒ€",    category:"ì¸ë ¥",   item:"ìŠ¤íƒœí”„ ì„­ì™¸",      done:true,  unitPrice:320000,   qty:15, days:1, note:""},
      {id:9, division:"ê¸°íƒ€",    category:"ì„­ì™¸",   item:"MC/ì§„í–‰ì",        done:false, unitPrice:1500000,  qty:1,  days:1, note:""},
      {id:10,division:"í…Œí¬ë‹ˆì»¬",category:"ìŒí–¥",   item:"ìŒí–¥ ì¥ë¹„ ì„ëŒ€",   done:false, unitPrice:3200000,  qty:1,  days:1, note:""},
      {id:11,division:"í…Œí¬ë‹ˆì»¬",category:"ì¡°ëª…",   item:"ì¡°ëª… ì„¤ì¹˜",        done:false, unitPrice:2800000,  qty:1,  days:1, note:""},
      {id:12,division:"ê¸°íš",    category:"ë””ìì¸", item:"ì´ˆì²­ì¥/í™ë³´ë¬¼",    done:true,  unitPrice:800000,   qty:1,  days:1, note:""},
    ],
    logs:[
      {id:1,date:"2025-09-01",author:"ê¹€ì§€í˜„",type:"auto",content:"í”„ë¡œì íŠ¸ í‚¥ì˜¤í”„ ë¯¸íŒ… ì™„ë£Œ. ì°¸ì„ì: ì‚¼ì„±ì „ì ë§ˆì¼€íŒ…íŒ€ 5ëª…, ë‚´ë¶€ 3ëª…"},
      {id:2,date:"2025-09-05",author:"ê¹€ì§€í˜„",type:"auto",content:"ê³¼ì—…ì§€ì‹œì„œ ìˆ˜ë ¹ ë° ê²€í†  ì™„ë£Œ. ì£¼ìš” ìš”êµ¬ì‚¬í•­ ì •ë¦¬ë¨"},
      {id:3,date:"2025-09-10",author:"ê¹€ì§€í˜„",type:"comment",content:"ë¶€ìŠ¤ ì„¤ê³„ 1ì°¨ ì‹œì•ˆ í´ë¼ì´ì–¸íŠ¸ í”¼ë“œë°± ë°˜ì˜ í•„ìš”. ìƒ‰ìƒ í†¤ ë³€ê²½ ìš”ì²­ ìˆìŒ"},
      {id:4,date:"2025-09-15",author:"ì‹œìŠ¤í…œ",type:"auto",content:"ì‹œê³µì—…ì²´ ê³„ì•½ ì²´ê²° ì™„ë£Œ (ãˆœì´ë²¤íŠ¸ë¹Œë”)"},
      {id:5,date:"2025-09-20",author:"ê¹€ì§€í˜„",type:"comment",content:"ìŠ¤íƒœí”„ 15ëª… í™•ì •. ìœ ë‹ˆí¼ ì‚¬ì´ì¦ˆ ì·¨í•© ì¤‘"},
    ],
    taskOrder:{
      sender:"ì‚¼ì„±ì „ì ë§ˆì¼€íŒ…íŒ€ ì´ì¤€í˜ íŒ€ì¥",
      receivedDate:"2025-09-01",
      purpose:"2025 í•œêµ­ì „ìì „(KES) ì°¸ê°€ë¥¼ í†µí•œ ì‚¼ì„±ì „ì ë¸Œëœë“œ ê°€ì¹˜ ì œê³  ë° ì‹ ì œí’ˆ ì „ì‹œ í™ë³´",
      venue:"ì„œìš¸ ì½”ì—‘ìŠ¤ Aí™€ A12~A14 ë¶€ìŠ¤ (ì´ 150ã¡)",
      attendance:"í–‰ì‚¬ ê¸°ê°„ ì¼ í‰ê·  ì•½ 500ëª… ë°©ë¬¸ ì˜ˆìƒ",
      tasks:"1. ë¸Œëœë“œ ë¶€ìŠ¤ ì„¤ê³„ ë° ì‹œê³µ (í™˜ê²½ì¹œí™” ì†Œì¬ ì ìš©)\n2. ë©”ì¸ í™ë³´ ì˜ìƒ ì œì‘ (3ë¶„ ì´ë‚´, 4K)\n3. í˜„ì¥ ìš´ì˜ ì¸ë ¥ ì„­ì™¸ ë° êµìœ¡ (ìŠ¤íƒœí”„ 15ëª…)\n4. ìŒí–¥Â·ì¡°ëª…Â·LED ì¥ë¹„ ì„ëŒ€ ë° ì„¤ì¹˜\n5. ì´ˆì²­ì¥ ë° í™ë³´ ì½˜í…ì¸  ì œì‘\n6. í–‰ì‚¬ ë‹¹ì¼ í˜„ì¥ ìš´ì˜ ë° ì² ìˆ˜",
      requirements:"ì¹œí™˜ê²½ ì†Œì¬ ì‚¬ìš© í•„ìˆ˜ / ì‚¼ì„± CI ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜ / ì „ì‹œê¸°ê°„ 4ì¼ (10.15~10.18)",
      notes:"ì„¸ë¶€ ë””ìì¸ ê°€ì´ë“œë¼ì¸ ë³„ë„ íŒŒì¼ ì „ë‹¬ ì˜ˆì •\në¶€ìŠ¤ ì¸ì ‘ ê²½ìŸì‚¬ LGì „ì ìœ„ì¹˜ íŒŒì•… í›„ ë™ì„  ê³„íš ìˆ˜ë¦½",
    },
    customItems:[],
    quoteHistory:[],
    files:["í‚¥ì˜¤í”„ë¯¸íŒ…_íšŒì˜ë¡.pdf","ë¶€ìŠ¤ì„¤ê³„ë„ë©´_v2.png","ìš´ì˜ê³„íšì•ˆ_ì´ˆì•ˆ.pptx"],
    dateMemos:{
      "2025-09-01":"í‚¥ì˜¤í”„ ë¯¸íŒ… ì§„í–‰",
      "2025-10-14":"ë¦¬í—ˆì„¤ ë° ì¥ë¹„ ì ê²€",
      "2025-10-15":"ğŸ¯ í–‰ì‚¬ D-day (í•œêµ­ì „ìì „ KES ê°œë§‰)",
    },
    gantt:[
      {id:1, division:"ê¸°íš", task:"ê¸°íš ë° ê³¼ì—…ì •ì˜", startDate:"2025-09-01", endDate:"2025-09-14", color:"#6366f1", progress:100, subtasks:[
        {id:11, task:"í‚¥ì˜¤í”„ ë¯¸íŒ…", startDate:"2025-09-01", endDate:"2025-09-01", done:true, note:""},
        {id:12, task:"ê³¼ì—…ì§€ì‹œì„œ ê²€í† ", startDate:"2025-09-02", endDate:"2025-09-05", done:true, note:""},
        {id:13, task:"ìš´ì˜ê³„íšì•ˆ ì‘ì„±", startDate:"2025-09-06", endDate:"2025-09-14", done:true, note:""},
      ]},
      {id:2, division:"ê¸°íš", task:"ë””ìì¸ ë° í™ë³´ë¬¼", startDate:"2025-09-10", endDate:"2025-10-01", color:"#8b5cf6", progress:80, subtasks:[
        {id:21, task:"í™ë³´ ì½˜í…ì¸  ê¸°íš", startDate:"2025-09-10", endDate:"2025-09-20", done:true, note:""},
        {id:22, task:"ì´ˆì²­ì¥/í™ë³´ë¬¼ ì œì‘", startDate:"2025-09-21", endDate:"2025-10-01", done:true, note:""},
      ]},
      {id:3, division:"ì œì‘", task:"ë¶€ìŠ¤ ì„¤ê³„/ì‹œê³µ", startDate:"2025-09-15", endDate:"2025-10-13", color:"#06b6d4", progress:100, subtasks:[
        {id:31, task:"ë¶€ìŠ¤ ì„¤ê³„/ë„ë©´", startDate:"2025-09-15", endDate:"2025-09-30", done:true, note:""},
        {id:32, task:"ì‹œê³µì—…ì²´ ì„ ì • ë° ê³„ì•½", startDate:"2025-10-01", endDate:"2025-10-05", done:true, note:""},
        {id:33, task:"ë¶€ìŠ¤ ì‹œê³µ", startDate:"2025-10-06", endDate:"2025-10-13", done:true, note:""},
      ]},
      {id:4, division:"í…Œí¬ë‹ˆì»¬", task:"ì˜ìƒ ì½˜í…ì¸  ì œì‘", startDate:"2025-09-20", endDate:"2025-10-10", color:"#f59e0b", progress:60, subtasks:[
        {id:41, task:"ë©”ì¸ ì˜ìƒ ê¸°íš/ìŠ¤í¬ë¦½íŠ¸", startDate:"2025-09-20", endDate:"2025-09-30", done:true, note:""},
        {id:42, task:"ì˜ìƒ ì´¬ì˜ ë° í¸ì§‘", startDate:"2025-10-01", endDate:"2025-10-10", done:false, note:""},
      ]},
      {id:5, division:"ê¸°íƒ€", task:"ì¸ë ¥ ì„­ì™¸/êµìœ¡", startDate:"2025-09-25", endDate:"2025-10-12", color:"#10b981", progress:100, subtasks:[
        {id:51, task:"ìŠ¤íƒœí”„ ì„­ì™¸ (15ëª…)", startDate:"2025-09-25", endDate:"2025-10-05", done:true, note:""},
        {id:52, task:"MC/ì§„í–‰ì ì„­ì™¸", startDate:"2025-09-25", endDate:"2025-10-01", done:false, note:""},
        {id:53, task:"êµìœ¡ ë° ìœ ë‹ˆí¼ ë°°í¬", startDate:"2025-10-10", endDate:"2025-10-12", done:false, note:""},
      ]},
      {id:6, division:"í…Œí¬ë‹ˆì»¬", task:"ì¥ë¹„ ì„¤ì¹˜/ë¦¬í—ˆì„¤", startDate:"2025-10-13", endDate:"2025-10-14", color:"#ef4444", progress:0, subtasks:[
        {id:61, task:"ìŒí–¥/ì¡°ëª… ì¥ë¹„ ì„¤ì¹˜", startDate:"2025-10-13", endDate:"2025-10-13", done:false, note:""},
        {id:62, task:"ë¦¬í—ˆì„¤ ì§„í–‰", startDate:"2025-10-14", endDate:"2025-10-14", done:false, note:""},
      ]},
      {id:7, division:"í…Œí¬ë‹ˆì»¬", task:"í–‰ì‚¬ ìš´ì˜", startDate:"2025-10-15", endDate:"2025-10-18", color:"#ec4899", progress:0, subtasks:[]},
    ],
  },
  {
    id:2, name:"ë¡¯ë°ë°±í™”ì  íŒì—…ìŠ¤í† ì–´", client:"ë¡¯ë°ë°±í™”ì ", producer:"ë°•ì„œì¤€",
    status:"ì¤€ë¹„ì¤‘", progress:32, budget:42000000, cost:13440000,
    startDate:"2025-10-01", eventDate:"2025-11-20", endDate:"2025-11-27",
    tags:["íŒì—…","ë¦¬í…Œì¼"],
    checklist:[
      {id:1, division:"ê¸°íš",    category:"ê¸°íš",   item:"í‚¥ì˜¤í”„ ë¯¸íŒ…",     done:true,  unitPrice:0,       qty:1, days:1, note:""},
      {id:2, division:"ê¸°íš",    category:"ê¸°íš",   item:"ê³¼ì—…ì§€ì‹œì„œ ìˆ˜ë ¹", done:true,  unitPrice:0,       qty:1, days:1, note:""},
      {id:3, division:"ê¸°íš",    category:"ê¸°íš",   item:"ìš´ì˜ê³„íšì•ˆ ì‘ì„±", done:false, unitPrice:500000,  qty:1, days:1, note:""},
      {id:4, division:"ì œì‘",    category:"ì—°ì¶œë¬¼", item:"ê³µê°„ ë ˆì´ì•„ì›ƒ",   done:true,  unitPrice:1200000, qty:1, days:1, note:""},
      {id:5, division:"í…Œí¬ë‹ˆì»¬",category:"ì˜ìƒ",   item:"í”„ë¡œëª¨ì…˜ ì˜ìƒ",   done:false, unitPrice:3500000, qty:1, days:1, note:""},
      {id:6, division:"ê¸°íƒ€",    category:"ì¸ë ¥",   item:"íŒì´‰ ë„ìš°ë¯¸",     done:false, unitPrice:200000,  qty:14,days:1, note:""},
    ],
    logs:[
      {id:1,date:"2025-10-01",author:"ë°•ì„œì¤€",type:"auto",content:"í‚¥ì˜¤í”„ ë¯¸íŒ… ì™„ë£Œ. ë¡¯ë° VMíŒ€ 3ëª… ì°¸ì„"},
      {id:2,date:"2025-10-08",author:"ë°•ì„œì¤€",type:"comment",content:"ê³µê°„ ë ˆì´ì•„ì›ƒ 1ì°¨ í™•ì •. ë¡¯ë° VMíŒ€ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘"},
    ],
    taskOrder:{
      sender:"ë¡¯ë°ë°±í™”ì  VMíŒ€ ë°•ì†Œì—° ëŒ€ë¦¬",
      receivedDate:"2025-10-01",
      purpose:"ë¡¯ë°ë°±í™”ì  ë³¸ì  íŒì—…ìŠ¤í† ì–´ ìš´ì˜ì„ í†µí•œ ì‹ ê·œ ë¸Œëœë“œ ì¸ì§€ë„ í™•ì‚° ë° ë§¤ì¶œ ì œê³ ",
      venue:"ë¡¯ë°ë°±í™”ì  ë³¸ì  1ì¸µ íŒì—… ì¡´ (50ã¡)",
      attendance:"ì¼ í‰ê·  ë°©ë¬¸ê° ì•½ 200ëª… ëª©í‘œ",
      tasks:"1. íŒì—… ê³µê°„ ì¸í…Œë¦¬ì–´ ì„¤ê³„ ë° ì‹œê³µ\n2. ë¸Œëœë“œ í”„ë¡œëª¨ì…˜ ì˜ìƒ ì œì‘\n3. íŒì´‰ ë„ìš°ë¯¸ ì„­ì™¸ ë° ìš´ì˜\n4. í˜„ì¥ ì§‘ê¸°/ë””ìŠ¤í”Œë ˆì´ ì œì‘",
      requirements:"ë¡¯ë°ë°±í™”ì  ë‚´ê·œ ì¤€ìˆ˜ / ì „ì‹œê¸°ê°„ 1ì£¼ (11.20~11.27) / ì•¼ê°„ ì² ìˆ˜ í•„ìˆ˜",
      notes:"VMíŒ€ ìŠ¹ì¸ í›„ ì‹œê³µ ì°©ìˆ˜ ê°€ëŠ¥",
    },
    customItems:[],
    quoteHistory:[],
    files:["ê³µê°„ë ˆì´ì•„ì›ƒ_v1.pdf"],
    dateMemos:{
      "2025-11-19":"ì‹œê³µ ì™„ë£Œ ë° ìµœì¢… ì ê²€",
      "2025-11-20":"ğŸ¯ íŒì—…ìŠ¤í† ì–´ ì˜¤í”ˆ D-day",
    },
    gantt:[
      {id:1, division:"ê¸°íš", task:"ê¸°íš/ê³¼ì—…ì •ì˜", startDate:"2025-10-01", endDate:"2025-10-10", color:"#6366f1", progress:100, subtasks:[
        {id:11, task:"í‚¥ì˜¤í”„ ë¯¸íŒ…", startDate:"2025-10-01", endDate:"2025-10-01", done:true, note:""},
        {id:12, task:"ìš´ì˜ê³„íšì•ˆ ì‘ì„±", startDate:"2025-10-03", endDate:"2025-10-10", done:false, note:""},
      ]},
      {id:2, division:"ì œì‘", task:"ê³µê°„ ë””ìì¸/ì‹œê³µ", startDate:"2025-10-08", endDate:"2025-11-19", color:"#06b6d4", progress:40, subtasks:[
        {id:21, task:"ê³µê°„ ë ˆì´ì•„ì›ƒ ì„¤ê³„", startDate:"2025-10-08", endDate:"2025-10-20", done:true, note:""},
        {id:22, task:"ì œì‘/ì‹œê³µ ë°œì£¼", startDate:"2025-10-21", endDate:"2025-11-05", done:false, note:""},
        {id:23, task:"í˜„ì¥ ì‹œê³µ", startDate:"2025-11-10", endDate:"2025-11-19", done:false, note:""},
      ]},
      {id:3, division:"í…Œí¬ë‹ˆì»¬", task:"í”„ë¡œëª¨ì…˜ ì˜ìƒ ì œì‘", startDate:"2025-10-15", endDate:"2025-11-10", color:"#f59e0b", progress:20, subtasks:[
        {id:31, task:"ì˜ìƒ ê¸°íš", startDate:"2025-10-15", endDate:"2025-10-25", done:false, note:""},
        {id:32, task:"ì´¬ì˜/í¸ì§‘", startDate:"2025-10-26", endDate:"2025-11-10", done:false, note:""},
      ]},
      {id:4, division:"ê¸°íƒ€", task:"ì¸ë ¥ ì„­ì™¸", startDate:"2025-10-20", endDate:"2025-11-15", color:"#10b981", progress:0, subtasks:[
        {id:41, task:"íŒì´‰ ë„ìš°ë¯¸ ì„­ì™¸ (14ëª…)", startDate:"2025-10-20", endDate:"2025-11-01", done:false, note:""},
        {id:42, task:"êµìœ¡ ì§„í–‰", startDate:"2025-11-10", endDate:"2025-11-15", done:false, note:""},
      ]},
      {id:5, division:"í…Œí¬ë‹ˆì»¬", task:"í–‰ì‚¬ ìš´ì˜", startDate:"2025-11-20", endDate:"2025-11-27", color:"#ec4899", progress:0, subtasks:[]},
    ],
  },
  {
    id:3, name:"í˜„ëŒ€ì°¨ ì‹ ì°¨ ë°œí‘œíšŒ", client:"í˜„ëŒ€ìë™ì°¨", producer:"ì´ìˆ˜ë¯¼",
    status:"ì™„ë£Œ", progress:100, budget:120000000, cost:108000000,
    startDate:"2025-07-01", eventDate:"2025-08-20", endDate:"2025-08-20",
    tags:["ë°œí‘œíšŒ","ìë™ì°¨"],
    checklist:[
      {id:1, division:"ê¸°íš",    category:"ê¸°íš",   item:"í‚¥ì˜¤í”„ ë¯¸íŒ…",    done:true, unitPrice:0,        qty:1, days:1, note:""},
      {id:2, division:"ì œì‘",    category:"ì—°ì¶œë¬¼", item:"ë¬´ëŒ€ ì„¤ê³„/ì‹œê³µ", done:true, unitPrice:18000000, qty:1, days:1, note:""},
      {id:3, division:"í…Œí¬ë‹ˆì»¬",category:"ì˜ìƒ",   item:"ì‹ ì°¨ ë¡ ì¹­ ì˜ìƒ", done:true, unitPrice:22000000, qty:1, days:1, note:""},
      {id:4, division:"ê¸°íƒ€",    category:"ì„­ì™¸",   item:"ì‚¬íšŒì/ëª¨ë¸",    done:true, unitPrice:8000000,  qty:1, days:1, note:""},
    ],
    logs:[
      {id:1,date:"2025-08-20",author:"ì‹œìŠ¤í…œ",type:"auto",content:"í–‰ì‚¬ ì™„ë£Œ. ì°¸ì„ì ì•½ 450ëª…. ëª¨ë“  ì¼ì • ì •ìƒ ì§„í–‰"},
      {id:2,date:"2025-08-22",author:"ì´ìˆ˜ë¯¼",type:"comment",content:"ê²°ê³¼ë³´ê³ ì„œ ì´ˆì•ˆ ì‘ì„± ì™„ë£Œ. í´ë¼ì´ì–¸íŠ¸ ê²€í†  ìš”ì²­ ë°œì†¡"},
    ],
    taskOrder:{
      sender:"í˜„ëŒ€ìë™ì°¨ í™ë³´íŒ€ ê¹€íƒœí˜„ ì°¨ì¥",
      receivedDate:"2025-07-01",
      purpose:"2025 ì‹ ì°¨ ë°œí‘œíšŒë¥¼ í†µí•œ ë¸Œëœë“œ í”„ë¦¬ë¯¸ì—„ ì´ë¯¸ì§€ ê°•í™” ë° ë¯¸ë””ì–´ ë…¸ì¶œ ê·¹ëŒ€í™”",
      venue:"ì„œìš¸ ë“œë˜ê³¤ì‹œí‹° í˜¸í…” ê·¸ëœë“œë³¼ë£¸ (600ëª… ìˆ˜ìš©)",
      attendance:"ì´ˆì²­ ë¯¸ë””ì–´Â·ë”œëŸ¬ ì•½ 450ëª…",
      tasks:"1. ë¬´ëŒ€ ì„¤ê³„ ë° ì‹œê³µ (ì‹ ì°¨ íšŒì „ ì „ì‹œëŒ€ í¬í•¨)\n2. ì‹ ì°¨ ë¡ ì¹­ í™ë³´ ì˜ìƒ ì œì‘ (5ë¶„, 4K HDR)\n3. ì‚¬íšŒì ë° ëª¨ë¸ ì„­ì™¸\n4. ìŒí–¥Â·ì¡°ëª…Â·LED ì‹œìŠ¤í…œ êµ¬ì¶•\n5. ë¯¸ë””ì–´ ë¸Œë¦¬í•‘ ìë£Œ ì œì‘",
      requirements:"ì‹ ì°¨ ë””ìì¸ ë³´ì•ˆ ìœ ì§€ / í–‰ì‚¬ ì¢…ë£Œ í›„ 12ì‹œê°„ ë‚´ ì² ìˆ˜ / í˜„ëŒ€ì°¨ CI ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜",
      notes:"ì™„ë£Œëœ í”„ë¡œì íŠ¸ Â· ê²°ê³¼ë³´ê³ ì„œ ì‘ì„± ì™„ë£Œ",
    },
    customItems:[],
    quoteHistory:[],
    files:["ê²°ê³¼ë³´ê³ ì„œ_ìµœì¢….pdf","í˜„ì¥ì‚¬ì§„_ëª¨ìŒ.zip"],
    dateMemos:{
      "2025-08-20":"ğŸ¯ ì‹ ì°¨ ë°œí‘œíšŒ D-day (ì„œìš¸ ë“œë˜ê³¤ì‹œí‹° í˜¸í…”)",
      "2025-08-22":"ê²°ê³¼ë³´ê³ ì„œ ì‘ì„± ì™„ë£Œ",
    },
    gantt:[
      {id:1, division:"ê¸°íš", task:"ê¸°íš ë° ê³¼ì—…ì •ì˜", startDate:"2025-07-01", endDate:"2025-07-14", color:"#6366f1", progress:100, subtasks:[
        {id:11, task:"í‚¥ì˜¤í”„ ë¯¸íŒ…", startDate:"2025-07-01", endDate:"2025-07-01", done:true, note:""},
        {id:12, task:"ê³¼ì—…ì§€ì‹œì„œ ê²€í† ", startDate:"2025-07-02", endDate:"2025-07-07", done:true, note:""},
      ]},
      {id:2, division:"ì œì‘", task:"ë¬´ëŒ€ ì„¤ê³„/ì‹œê³µ", startDate:"2025-07-10", endDate:"2025-08-15", color:"#06b6d4", progress:100, subtasks:[
        {id:21, task:"ë¬´ëŒ€ ì„¤ê³„/ë„ë©´", startDate:"2025-07-10", endDate:"2025-07-25", done:true, note:""},
        {id:22, task:"ì‹ ì°¨ íšŒì „ ì „ì‹œëŒ€ ì œì‘", startDate:"2025-07-26", endDate:"2025-08-10", done:true, note:""},
        {id:23, task:"í˜„ì¥ ì‹œê³µ", startDate:"2025-08-11", endDate:"2025-08-15", done:true, note:""},
      ]},
      {id:3, division:"í…Œí¬ë‹ˆì»¬", task:"ì‹ ì°¨ ë¡ ì¹­ ì˜ìƒ ì œì‘", startDate:"2025-07-15", endDate:"2025-08-10", color:"#f59e0b", progress:100, subtasks:[
        {id:31, task:"ì˜ìƒ ê¸°íš/ìŠ¤í¬ë¦½íŠ¸", startDate:"2025-07-15", endDate:"2025-07-31", done:true, note:""},
        {id:32, task:"ì´¬ì˜ ë° í¸ì§‘ (5ë¶„ 4K HDR)", startDate:"2025-08-01", endDate:"2025-08-10", done:true, note:""},
      ]},
      {id:4, division:"ê¸°íƒ€", task:"ì‚¬íšŒì/ëª¨ë¸ ì„­ì™¸", startDate:"2025-07-20", endDate:"2025-08-05", color:"#10b981", progress:100, subtasks:[
        {id:41, task:"ì‚¬íšŒì ì„­ì™¸", startDate:"2025-07-20", endDate:"2025-07-31", done:true, note:""},
        {id:42, task:"ëª¨ë¸ ì„­ì™¸ ë° ë¦¬í—ˆì„¤", startDate:"2025-08-01", endDate:"2025-08-05", done:true, note:""},
      ]},
      {id:5, division:"í…Œí¬ë‹ˆì»¬", task:"ìŒí–¥/ì¡°ëª…/LED ì„¤ì¹˜", startDate:"2025-08-16", endDate:"2025-08-19", color:"#ef4444", progress:100, subtasks:[]},
      {id:6, division:"í…Œí¬ë‹ˆì»¬", task:"í–‰ì‚¬ ìš´ì˜", startDate:"2025-08-20", endDate:"2025-08-20", color:"#ec4899", progress:100, subtasks:[]},
    ],
  },
];

/* â•â• í—¬í¼ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const fmt = n => n?.toLocaleString("ko-KR")+"ì›";
const profitRate = (b,c) => b > 0 ? (((b-c)/b)*100).toFixed(1) : "0.0";
const today = new Date().toISOString().slice(0,10);

function toast(msg, type="default") {
  const c = document.getElementById("toasts");
  const t = document.createElement("div");
  t.className = "toast";
  t.style.borderLeftColor = type==="success"?"#10b981":type==="error"?"#ef4444":type==="warn"?"#f59e0b":"transparent";
  t.style.borderLeftWidth = "3px";
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(()=>{t.style.opacity="0";t.style.transform="translateY(8px)";t.style.transition=".3s";setTimeout(()=>t.remove(),300)},2500);
}

/* â•â• ì»´í¬ë„ŒíŠ¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€ Topbar â”€
function Topbar({page, setPage, user, onLogout}) {
  const pages = [
    {id:"dashboard",label:"ëŒ€ì‹œë³´ë“œ"},
    {id:"projects",label:"í”„ë¡œì íŠ¸"},
    {id:"mywork",label:"ë‚´ ì—…ë¬´"},
    {id:"expense",label:"ğŸ’³ ì§€ì¶œê²°ì˜"},
    {id:"labor",label:"ğŸ‘¤ ì¸ê±´ë¹„"},
    {id:"purchase",label:"ğŸ›’ êµ¬ë§¤ìš”ì²­"},
    {id:"files",label:"íŒŒì¼"},
    ...(user?.isAdmin ? [{id:"admin",label:"âš™ï¸ ê¶Œí•œê´€ë¦¬"}] : []),
  ];
  return (
    <div id="topbar">
      <div className="logo">
        <div className="logo-icon">E</div>
        <div className="logo-text">EventOS</div>
      </div>
      <nav>
        {pages.map(p=>(
          <button key={p.id} className={page===p.id?"active":""} onClick={()=>setPage(p.id)}
            style={p.id==="admin"?{color:"#c084fc"}:{}}>
            {p.label}
          </button>
        ))}
      </nav>
      <div className="user">
        <SyncStatusBar/>
        <div style={{width:8,height:8,borderRadius:"50%",background:"#10b981",boxShadow:"0 0 6px #10b981"}}/>
        <span className="user-name">{user?.name} {user?.role}</span>
        <div className="user-badge" style={{background:user?.color||"linear-gradient(135deg,#6366f1,#ec4899)"}}>{user?.initial||"?"}</div>
        <button onClick={onLogout} title="ë¡œê·¸ì•„ì›ƒ" style={{
          background:"rgba(239,68,68,.1)",border:"1px solid rgba(239,68,68,.2)",
          color:"#fca5a5",borderRadius:7,padding:"4px 10px",fontSize:11,fontWeight:600,
          cursor:"pointer",transition:"all .15s",whiteSpace:"nowrap",
        }}>ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  );
}

// â”€ Bottom Nav â”€
function BottomNav({page, setPage, user}) {
  const items = [
    {id:"dashboard",icon:"ğŸ ",label:"í™ˆ"},
    {id:"projects",icon:"ğŸ“‹",label:"í”„ë¡œì íŠ¸"},
    {id:"mywork",icon:"âœ…",label:"ë‚´ ì—…ë¬´"},
    {id:"expense",icon:"ğŸ’³",label:"ì§€ì¶œ"},
    {id:"labor",icon:"ğŸ‘¤",label:"ì¸ê±´ë¹„"},
    {id:"purchase",icon:"ğŸ›’",label:"êµ¬ë§¤"},
    {id:"files",icon:"ğŸ“",label:"íŒŒì¼"},
    ...(user?.isAdmin ? [{id:"admin",icon:"âš™ï¸",label:"ê¶Œí•œ"}] : []),
  ];
  return (
    <div id="bottom-nav">
      {items.map(i=>(
        <button key={i.id} className={page===i.id?"active":""} onClick={()=>setPage(i.id)}>
          <span className="icon">{i.icon}</span>
          <span className="label">{i.label}</span>
        </button>
      ))}
    </div>
  );
}

// â”€ StatCard â”€
function StatCard({label,value,sub,accent}) {
  return (
    <div className="stat-card">
      <div className="stat-label">{label}</div>
      <div className="stat-value" style={accent?{color:accent}:{}}>{value}</div>
      {sub && <div className="stat-sub">{sub}</div>}
    </div>
  );
}

// â”€ ProjectCard â”€
function ProjectCard({project, onClick}) {
  const profit = profitRate(project.budget, project.cost);
  const sc = STATUS_COLORS[project.status]||"#6b7280";
  return (
    <div className="proj-card" onClick={onClick}>
      <div className="flex-between" style={{marginBottom:12}}>
        <div>
          <div style={{color:"var(--txt)",fontWeight:700,fontSize:15,marginBottom:3}}>{project.name}</div>
          <div style={{color:"var(--txt3)",fontSize:12}}>{project.client} Â· {project.producer}</div>
        </div>
        <span className="badge" style={{background:`${sc}22`,color:sc,border:`1px solid ${sc}44`}}>{project.status}</span>
      </div>
      <div style={{marginBottom:12}}>
        <div className="flex-between" style={{marginBottom:5}}>
          <span style={{color:"var(--txt3)",fontSize:12}}>ì§„í–‰ë¥ </span>
          <span style={{color:"#a5b4fc",fontSize:12,fontWeight:700}}>{project.progress}%</span>
        </div>
        <div className="prog-track"><div className="prog-fill" style={{width:`${project.progress}%`}}/></div>
      </div>
      <div className="flex-between">
        <div style={{color:"var(--txt3)",fontSize:12}}>
          ìˆ˜ìµë¥  <span style={{color:profit>20?"#10b981":"#f59e0b",fontWeight:700}}>{profit}%</span>
        </div>
        <div style={{color:"var(--txt3)",fontSize:12}}>
          {project.eventDate}
        </div>
      </div>
      <div style={{display:"flex",gap:4,marginTop:10,flexWrap:"wrap"}}>
        {project.tags.map(t=>(
          <span key={t} style={{background:"rgba(99,102,241,.1)",color:"#818cf8",padding:"2px 8px",borderRadius:4,fontSize:11}}>{t}</span>
        ))}
      </div>
    </div>
  );
}

// â”€ Gantt â”€
function GanttChart({project, onUpdate}) {
  const [tasks, setTasks]           = useState(project.gantt || []);
  const [dateMemos, setDateMemos]   = useState(project.dateMemos || {});
  const [expanded, setExpanded]     = useState({});
  const [showAddTask, setShowAddTask]       = useState(false);
  const [showAddSubtask, setShowAddSubtask] = useState(null);
  const [showMemoModal, setShowMemoModal]   = useState(null);
  const [newTask, setNewTask] = useState({division:"ê¸°íš", task:"", startDate:"", endDate:"", color:"#6366f1", progress:0});
  const [newSub,  setNewSub]  = useState({task:"", startDate:"", endDate:"", done:false, note:""});
  const [memoText, setMemoText] = useState("");

  const eventDate = project.eventDate || today;
  const COL_W = 28;
  const LEFT_W = 190;

  const {dates, dateIdx, months} = useMemo(()=>{
    let minD = eventDate, maxD = eventDate;
    tasks.forEach(t=>{
      if(t.startDate && t.startDate < minD) minD = t.startDate;
      if(t.endDate   && t.endDate   > maxD) maxD = t.endDate;
      (t.subtasks||[]).forEach(s=>{
        if(s.startDate && s.startDate < minD) minD = s.startDate;
        if(s.endDate   && s.endDate   > maxD) maxD = s.endDate;
      });
    });
    const s0 = new Date(minD); s0.setDate(s0.getDate()-7);
    const e0 = new Date(maxD); e0.setDate(e0.getDate()+14);
    const dates=[], dateIdx={};
    let cur=new Date(s0);
    while(cur<=e0){
      const ds=cur.toISOString().slice(0,10);
      dateIdx[ds]=dates.length;
      dates.push(ds);
      cur.setDate(cur.getDate()+1);
    }
    const months=[];
    let curM=null;
    dates.forEach((d,i)=>{
      const m=d.slice(0,7);
      if(m!==curM){months.push({label:d.slice(0,4)+"."+d.slice(5,7),start:i,count:0});curM=m;}
      months[months.length-1].count++;
    });
    return {dates,dateIdx,months};
  },[tasks,eventDate]);

  const totalW = dates.length * COL_W;

  const getDday = ds => {
    const diff = Math.round((new Date(ds)-new Date(eventDate))/86400000);
    if(diff===0) return "D-day";
    return diff<0 ? `D${diff}` : `D+${diff}`;
  };
  const isToday   = ds => ds===today;
  const isDday    = ds => ds===eventDate;
  const isWeekend = ds => { const d=new Date(ds); return d.getDay()===0||d.getDay()===6; };
  const hasMemo   = ds => !!dateMemos[ds];

  const save = (t,m) => {
    onUpdate({...project, gantt:t||tasks, dateMemos:m||dateMemos});
  };

  const addTask = () => {
    if(!newTask.task||!newTask.startDate||!newTask.endDate){toast("ê³¼ì—…ëª…, ì‹œì‘ì¼, ì¢…ë£Œì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤","error");return;}
    const updated=[...tasks,{...newTask,id:Date.now(),subtasks:[]}];
    setTasks(updated); save(updated,dateMemos);
    setNewTask({division:"ê¸°íš",task:"",startDate:"",endDate:"",color:"#6366f1",progress:0});
    setShowAddTask(false); toast("âœ… ê³¼ì—… ì¶”ê°€ë¨","success");
  };

  const addSub = pid => {
    if(!newSub.task){toast("ì„¸ë¶€í•­ëª©ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤","error");return;}
    const updated=tasks.map(t=>t.id===pid?{...t,subtasks:[...(t.subtasks||[]),{...newSub,id:Date.now()}]}:t);
    setTasks(updated); save(updated,dateMemos);
    setNewSub({task:"",startDate:"",endDate:"",done:false,note:""});
    setShowAddSubtask(null); toast("âœ… ì„¸ë¶€í•­ëª© ì¶”ê°€ë¨","success");
  };

  const toggleSub = (pid,sid) => {
    const updated=tasks.map(t=>t.id===pid?{...t,subtasks:(t.subtasks||[]).map(s=>s.id===sid?{...s,done:!s.done}:s)}:t);
    setTasks(updated); save(updated,dateMemos);
  };

  const saveMemo = () => {
    const nm={...dateMemos};
    if(memoText) nm[showMemoModal]=memoText; else delete nm[showMemoModal];
    setDateMemos(nm); save(tasks,nm);
    setShowMemoModal(null); toast("ğŸ“ ë©”ëª¨ ì €ì¥ë¨","success");
  };

  const importChecklist = () => {
    const existing=new Set(tasks.map(t=>t.task));
    const added=[];
    DIVISIONS.forEach(div=>{
      const items=project.checklist.filter(c=>(c.division||"ê¸°íƒ€")===div);
      if(items.length>0){
        added.push({
          id:Date.now()+Math.random(),division:div,
          task:div+" ê³¼ì—…",
          startDate:project.startDate||today,endDate:project.eventDate||today,
          color:DIV_COLORS[div]||"#6366f1",progress:0,
          subtasks:items.map((c,i)=>({
            id:Date.now()+i+Math.random(),task:c.item,
            startDate:project.startDate||today,endDate:project.eventDate||today,
            done:c.done,note:c.note||""
          }))
        });
      }
    });
    const updated=[...tasks,...added.filter(a=>!existing.has(a.task))];
    setTasks(updated); save(updated,dateMemos);
    toast(`âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ì—ì„œ ${added.length}ê°œ êµ¬ë¶„ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤`,"success");
  };

  const renderBar = (startDate,endDate,color,progress,label) => {
    const si=dateIdx[startDate], ei=dateIdx[endDate];
    if(si===undefined||ei===undefined) return null;
    const w=(ei-si+1)*COL_W;
    return (
      <div style={{position:"absolute",left:si*COL_W,top:5,height:22,width:w,
        background:`${color}2a`,border:`1px solid ${color}88`,borderRadius:4,overflow:"hidden",
        display:"flex",alignItems:"center"}}>
        <div style={{position:"absolute",left:0,top:0,bottom:0,width:`${progress}%`,background:`${color}55`}}/>
        <span style={{position:"relative",fontSize:10,color:"#fff",padding:"0 6px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",maxWidth:"100%"}}>{label}</span>
      </div>
    );
  };

  if(!dates.length) return <div style={{color:"var(--txt4)",padding:20,textAlign:"center"}}>ë‚ ì§œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>;

  return (
    <div style={{background:"var(--card)",border:"1px solid var(--border)",borderRadius:"var(--radius)",overflow:"hidden"}}>
      {/* íˆ´ë°” */}
      <div style={{display:"flex",alignItems:"center",gap:10,padding:"12px 16px",borderBottom:"1px solid var(--border)",flexWrap:"wrap"}}>
        <span style={{fontWeight:700,fontSize:14,color:"var(--txt)"}}>ğŸ“… ê°„íŠ¸ì°¨íŠ¸ Â· ì—…ë¬´ íŒ”ë¡œìš°ì—…</span>
        <div style={{display:"flex",alignItems:"center",gap:6,marginLeft:"auto",flexWrap:"wrap"}}>
          <span style={{fontSize:11,color:"var(--txt4)"}}>
            <span style={{display:"inline-block",width:8,height:8,borderRadius:"50%",background:"#3b82f6",marginRight:4}}/>ì˜¤ëŠ˜
            <span style={{display:"inline-block",width:8,height:8,borderRadius:"50%",background:"#ef4444",marginRight:4,marginLeft:8}}/>D-day
            <span style={{display:"inline-block",width:8,height:8,borderRadius:"50%",background:"#f59e0b",marginRight:4,marginLeft:8}}/>ë©”ëª¨
          </span>
          <button onClick={importChecklist}
            style={{background:"var(--surface)",border:"1px solid var(--border)",color:"var(--txt2)",borderRadius:6,padding:"5px 12px",fontSize:12}}>
            ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
          </button>
          <button onClick={()=>setShowAddTask(true)}
            style={{background:"var(--primary-dim)",border:"1px solid var(--primary-border)",color:"#a5b4fc",borderRadius:6,padding:"5px 12px",fontSize:12}}>
            + ê³¼ì—… ì¶”ê°€
          </button>
        </div>
      </div>

      {/* ê°„íŠ¸ ê·¸ë¦¬ë“œ */}
      <div style={{overflowX:"auto"}}>
        <div style={{display:"flex",flexDirection:"column",width:LEFT_W+totalW}}>

          {/* ì›” í—¤ë” */}
          <div style={{display:"flex",borderBottom:"1px solid var(--border)",background:"rgba(0,0,0,0.3)",flexShrink:0}}>
            <div style={{width:LEFT_W,flexShrink:0,borderRight:"1px solid var(--border)",padding:"5px 12px",fontSize:11,color:"var(--txt3)",fontWeight:700,position:"sticky",left:0,background:"rgba(8,11,20,0.95)",zIndex:10}}>ê³¼ì—… / ì„¸ë¶€í•­ëª©</div>
            <div style={{position:"relative",width:totalW,flexShrink:0,height:26}}>
              {months.map((m,i)=>(
                <div key={i} style={{position:"absolute",left:m.start*COL_W,width:m.count*COL_W,
                  padding:"5px 6px",fontSize:11,color:"var(--txt2)",fontWeight:700,
                  borderRight:"1px solid rgba(255,255,255,0.08)",textAlign:"center",
                  overflow:"hidden",whiteSpace:"nowrap"}}>{m.label}</div>
              ))}
            </div>
          </div>

          {/* D-day í—¤ë” */}
          <div style={{display:"flex",borderBottom:"1px solid rgba(255,255,255,0.04)",background:"rgba(0,0,0,0.2)",flexShrink:0}}>
            <div style={{width:LEFT_W,flexShrink:0,borderRight:"1px solid var(--border)",padding:"3px 12px",fontSize:10,color:"var(--txt4)",position:"sticky",left:0,background:"rgba(8,11,20,0.95)",zIndex:10}}></div>
            <div style={{position:"relative",width:totalW,flexShrink:0,height:20}}>
              {dates.map((d,i)=>{
                const dd=getDday(d);
                const show=(i===0||i%7===0||isToday(d)||isDday(d));
                return (
                  <div key={d} style={{position:"absolute",left:i*COL_W,width:COL_W,height:"100%",
                    display:"flex",alignItems:"center",justifyContent:"center",
                    background:isDday(d)?"rgba(239,68,68,0.18)":isToday(d)?"rgba(59,130,246,0.15)":"transparent"}}>
                    {show&&<span style={{fontSize:8,color:isDday(d)?"#ef4444":isToday(d)?"#60a5fa":"var(--txt4)",fontWeight:(isDday(d)||isToday(d))?700:400,whiteSpace:"nowrap"}}>{dd}</span>}
                  </div>
                );
              })}
            </div>
          </div>

          {/* ë‚ ì§œ ìˆ«ì í—¤ë” */}
          <div style={{display:"flex",borderBottom:"2px solid var(--border)",background:"rgba(0,0,0,0.25)",flexShrink:0}}>
            <div style={{width:LEFT_W,flexShrink:0,borderRight:"1px solid var(--border)",padding:"3px 12px",fontSize:9,color:"var(--txt4)",position:"sticky",left:0,background:"rgba(8,11,20,0.95)",zIndex:10}}>ë‚ ì§œ (í´ë¦­ = ë©”ëª¨)</div>
            <div style={{position:"relative",width:totalW,flexShrink:0,height:24}}>
              {dates.map((d,i)=>{
                const day=parseInt(d.slice(8));
                const wknd=isWeekend(d), tdy=isToday(d), dday=isDday(d);
                return (
                  <div key={d} onClick={()=>{setShowMemoModal(d);setMemoText(dateMemos[d]||"");}}
                    style={{position:"absolute",left:i*COL_W,width:COL_W,height:"100%",cursor:"pointer",
                      display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",
                      background:dday?"rgba(239,68,68,0.18)":tdy?"rgba(59,130,246,0.18)":wknd?"rgba(255,255,255,0.02)":"transparent",
                      borderRight:"1px solid rgba(255,255,255,0.03)"}}>
                    <span style={{fontSize:9,color:dday?"#ef4444":tdy?"#60a5fa":wknd?"var(--txt4)":"var(--txt3)",fontWeight:(dday||tdy)?700:400}}>{day}</span>
                    {hasMemo(d)&&<div style={{width:4,height:4,borderRadius:"50%",background:"#f59e0b",marginTop:1}}/>}
                  </div>
                );
              })}
            </div>
          </div>

          {/* ê³¼ì—… í–‰ë“¤ */}
          {tasks.length===0&&(
            <div style={{padding:"40px 16px",textAlign:"center",color:"var(--txt4)",fontSize:13}}>
              ê³¼ì—…ì´ ì—†ìŠµë‹ˆë‹¤. ì²´í¬ë¦¬ìŠ¤íŠ¸ì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ ì§ì ‘ ì¶”ê°€í•˜ì„¸ìš”.
            </div>
          )}

          {tasks.map(task=>{
            const isExp=expanded[task.id];
            const subs=task.subtasks||[];
            const taskColor=task.color||DIV_COLORS[task.division]||"#6366f1";
            return (
              <React.Fragment key={task.id}>
                {/* ë©”ì¸ ê³¼ì—… í–‰ */}
                <div style={{display:"flex",borderBottom:"1px solid rgba(255,255,255,0.05)",minHeight:34,background:"rgba(255,255,255,0.015)"}}>
                  <div style={{width:LEFT_W,flexShrink:0,borderRight:"1px solid var(--border)",
                    padding:"5px 8px 5px 10px",display:"flex",alignItems:"center",gap:5,
                    position:"sticky",left:0,background:"rgba(14,20,36,0.98)",zIndex:6}}>
                    <span style={{width:3,height:18,borderRadius:2,flexShrink:0,background:taskColor,display:"inline-block"}}/>
                    {subs.length>0&&(
                      <button onClick={()=>setExpanded(e=>({...e,[task.id]:!e[task.id]}))}
                        style={{background:"none",border:"none",color:"var(--txt3)",padding:"0 2px",fontSize:10,lineHeight:1,flexShrink:0}}>
                        {isExp?"â–¼":"â–¶"}
                      </button>
                    )}
                    <span style={{fontSize:12,color:"var(--txt)",fontWeight:600,flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{task.task}</span>
                    <span style={{fontSize:10,color:"var(--txt4)",flexShrink:0}}>{task.progress||0}%</span>
                    <button onClick={()=>setShowAddSubtask(task.id)} title="ì„¸ë¶€í•­ëª© ì¶”ê°€"
                      style={{background:"none",border:"none",color:"var(--txt4)",fontSize:12,padding:0,flexShrink:0,lineHeight:1}}>ï¼‹</button>
                  </div>
                  <div style={{position:"relative",width:totalW,flexShrink:0,height:34}}>
                    {dates.map((d,i)=>(isWeekend(d)&&<div key={d} style={{position:"absolute",left:i*COL_W,width:COL_W,top:0,bottom:0,background:"rgba(255,255,255,0.012)"}}/>))}
                    {dateIdx[today]!==undefined&&<div style={{position:"absolute",left:dateIdx[today]*COL_W+COL_W/2,top:0,bottom:0,width:1,background:"rgba(59,130,246,0.45)",zIndex:2}}/>}
                    {dateIdx[eventDate]!==undefined&&eventDate!==today&&<div style={{position:"absolute",left:dateIdx[eventDate]*COL_W+COL_W/2,top:0,bottom:0,width:1,background:"rgba(239,68,68,0.45)",zIndex:2}}/>}
                    {task.startDate&&task.endDate&&renderBar(task.startDate,task.endDate,taskColor,task.progress||0,task.task)}
                  </div>
                </div>

                {/* ì„¸ë¶€í•­ëª© í–‰ë“¤ */}
                {isExp&&subs.map(sub=>(
                  <div key={sub.id} style={{display:"flex",borderBottom:"1px solid rgba(255,255,255,0.03)",minHeight:26,background:"rgba(0,0,0,0.15)"}}>
                    <div style={{width:LEFT_W,flexShrink:0,borderRight:"1px solid var(--border)",
                      padding:"4px 8px 4px 22px",display:"flex",alignItems:"center",gap:5,
                      position:"sticky",left:0,background:"rgba(8,12,22,0.98)",zIndex:6}}>
                      <input type="checkbox" checked={sub.done}
                        onChange={()=>toggleSub(task.id,sub.id)}
                        style={{width:11,height:11,cursor:"pointer",flexShrink:0,accentColor:taskColor}}/>
                      <span style={{fontSize:11,color:sub.done?"var(--txt4)":"var(--txt2)",
                        textDecoration:sub.done?"line-through":"none",
                        overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{sub.task}</span>
                    </div>
                    <div style={{position:"relative",width:totalW,flexShrink:0,height:26}}>
                      {dateIdx[today]!==undefined&&<div style={{position:"absolute",left:dateIdx[today]*COL_W+COL_W/2,top:0,bottom:0,width:1,background:"rgba(59,130,246,0.35)",zIndex:2}}/>}
                      {dateIdx[eventDate]!==undefined&&eventDate!==today&&<div style={{position:"absolute",left:dateIdx[eventDate]*COL_W+COL_W/2,top:0,bottom:0,width:1,background:"rgba(239,68,68,0.35)",zIndex:2}}/>}
                      {sub.startDate&&sub.endDate&&(()=>{
                        const si=dateIdx[sub.startDate],ei=dateIdx[sub.endDate];
                        if(si===undefined||ei===undefined) return null;
                        return (
                          <div style={{position:"absolute",left:si*COL_W,top:5,height:16,width:(ei-si+1)*COL_W,
                            background:sub.done?"rgba(16,185,129,0.2)":"rgba(148,163,184,0.12)",
                            border:`1px solid ${sub.done?"rgba(16,185,129,0.4)":"rgba(148,163,184,0.25)"}`,
                            borderRadius:3,display:"flex",alignItems:"center",overflow:"hidden"}}>
                            <span style={{fontSize:9,color:"var(--txt3)",padding:"0 4px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{sub.task}</span>
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                ))}

                {/* ì„¸ë¶€í•­ëª© ì¶”ê°€ ì¸ë¼ì¸ í¼ */}
                {showAddSubtask===task.id&&(
                  <div style={{display:"flex",borderBottom:"1px solid rgba(255,255,255,0.05)",background:"rgba(99,102,241,0.06)"}}>
                    <div style={{width:LEFT_W,flexShrink:0,borderRight:"1px solid var(--border)",
                      padding:"6px 8px 6px 20px",display:"flex",alignItems:"center",gap:4,
                      position:"sticky",left:0,background:"rgba(8,11,20,0.98)",zIndex:6}}>
                      <input placeholder="ì„¸ë¶€í•­ëª©ëª…" value={newSub.task}
                        onChange={e=>setNewSub(s=>({...s,task:e.target.value}))}
                        style={{flex:1,background:"var(--surface)",border:"1px solid var(--border)",borderRadius:4,padding:"3px 6px",color:"var(--txt)",fontSize:11,minWidth:0}}/>
                    </div>
                    <div style={{flex:1,padding:"5px 10px",display:"flex",gap:6,alignItems:"center",flexWrap:"wrap"}}>
                      <input type="date" value={newSub.startDate}
                        onChange={e=>setNewSub(s=>({...s,startDate:e.target.value}))}
                        style={{background:"var(--surface)",border:"1px solid var(--border)",borderRadius:4,padding:"3px 6px",color:"var(--txt)",fontSize:11}}/>
                      <span style={{color:"var(--txt4)",fontSize:11}}>~</span>
                      <input type="date" value={newSub.endDate}
                        onChange={e=>setNewSub(s=>({...s,endDate:e.target.value}))}
                        style={{background:"var(--surface)",border:"1px solid var(--border)",borderRadius:4,padding:"3px 6px",color:"var(--txt)",fontSize:11}}/>
                      <button onClick={()=>addSub(task.id)}
                        style={{background:"var(--primary)",border:"none",color:"#fff",borderRadius:4,padding:"4px 12px",fontSize:11}}>ì¶”ê°€</button>
                      <button onClick={()=>setShowAddSubtask(null)}
                        style={{background:"var(--surface)",border:"1px solid var(--border)",color:"var(--txt3)",borderRadius:4,padding:"4px 8px",fontSize:11}}>ì·¨ì†Œ</button>
                    </div>
                  </div>
                )}
              </React.Fragment>
            );
          })}
        </div>
      </div>

      {/* ê³¼ì—… ì¶”ê°€ ëª¨ë‹¬ */}
      {showAddTask&&(
        <div className="modal-overlay" onClick={e=>e.target.classList.contains("modal-overlay")&&setShowAddTask(false)}>
          <div className="modal-box">
            <div className="modal-title">ğŸ“Œ ìƒˆ ê³¼ì—… ì¶”ê°€</div>
            {[
              {label:"ê³¼ì—…ëª… *",key:"task",type:"text",placeholder:"ì˜ˆ: ë¬´ëŒ€ ì„¤ê³„"},
              {label:"ì‹œì‘ì¼ *",key:"startDate",type:"date"},
              {label:"ì¢…ë£Œì¼ *",key:"endDate",type:"date"},
            ].map(f=>(
              <div key={f.key} className="form-group">
                <label className="form-label">{f.label}</label>
                <input className="form-input" type={f.type} placeholder={f.placeholder||""}
                  value={newTask[f.key]} onChange={e=>setNewTask(t=>({...t,[f.key]:e.target.value}))}/>
              </div>
            ))}
            <div className="form-group">
              <label className="form-label">êµ¬ë¶„</label>
              <select className="form-input" value={newTask.division}
                onChange={e=>setNewTask(t=>({...t,division:e.target.value,color:DIV_COLORS[e.target.value]||"#6366f1"}))}>
                {DIVISIONS.map(d=><option key={d} value={d}>{d}</option>)}
              </select>
            </div>
            <div className="form-group">
              <label className="form-label">ì§„í–‰ë¥  ({newTask.progress}%)</label>
              <input type="range" min={0} max={100} value={newTask.progress}
                onChange={e=>setNewTask(t=>({...t,progress:+e.target.value}))} style={{width:"100%"}}/>
            </div>
            <div className="form-group">
              <label className="form-label">ìƒ‰ìƒ</label>
              <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
                {["#6366f1","#06b6d4","#f59e0b","#10b981","#ef4444","#ec4899","#8b5cf6","#84cc16"].map(c=>(
                  <button key={c} onClick={()=>setNewTask(t=>({...t,color:c}))}
                    style={{width:24,height:24,borderRadius:"50%",background:c,
                      border:newTask.color===c?"3px solid #fff":"2px solid transparent",cursor:"pointer"}}/>
                ))}
              </div>
            </div>
            <div style={{display:"flex",gap:10,justifyContent:"flex-end",marginTop:16}}>
              <button className="btn-ghost" onClick={()=>setShowAddTask(false)}>ì·¨ì†Œ</button>
              <button className="btn-primary" onClick={addTask}>ì¶”ê°€</button>
            </div>
          </div>
        </div>
      )}

      {/* ë‚ ì§œ ë©”ëª¨ ëª¨ë‹¬ */}
      {showMemoModal&&(
        <div className="modal-overlay" onClick={e=>e.target.classList.contains("modal-overlay")&&setShowMemoModal(null)}>
          <div className="modal-box" style={{maxWidth:380}}>
            <div className="modal-title">ğŸ“ ë‚ ì§œ ë©”ëª¨</div>
            <div style={{background:"var(--surface)",borderRadius:8,padding:"10px 14px",marginBottom:14}}>
              <div style={{fontSize:13,color:"var(--txt2)",fontWeight:600}}>{showMemoModal}
                <span style={{color:"var(--txt4)",fontSize:11,fontWeight:400,marginLeft:8}}>({getDday(showMemoModal)})</span>
              </div>
              {isDday(showMemoModal)&&<div style={{color:"#ef4444",fontSize:12,marginTop:4}}>ğŸ¯ í–‰ì‚¬ D-day</div>}
              {isToday(showMemoModal)&&<div style={{color:"#60a5fa",fontSize:12,marginTop:4}}>ğŸ“ ì˜¤ëŠ˜</div>}
            </div>
            <div className="form-group">
              <label className="form-label">ë©”ëª¨</label>
              <textarea className="form-input" rows={4} placeholder="ì´ ë‚ ì§œì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                value={memoText} onChange={e=>setMemoText(e.target.value)} style={{resize:"vertical"}}/>
            </div>
            <div style={{display:"flex",gap:10,justifyContent:"flex-end"}}>
              <button className="btn-ghost" onClick={()=>setShowMemoModal(null)}>ì·¨ì†Œ</button>
              {dateMemos[showMemoModal]&&(
                <button onClick={()=>{const nm={...dateMemos};delete nm[showMemoModal];setDateMemos(nm);save(tasks,nm);setShowMemoModal(null);toast("ğŸ—‘ï¸ ë©”ëª¨ ì‚­ì œë¨");}}
                  style={{background:"rgba(239,68,68,0.1)",border:"1px solid rgba(239,68,68,0.3)",color:"#ef4444",borderRadius:6,padding:"6px 14px",fontSize:13}}>ì‚­ì œ</button>
              )}
              <button className="btn-primary" onClick={saveMemo}>ì €ì¥</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// â”€ Checklist & Quote â”€
function ChecklistPanel({project, onUpdate, currentUser}) {
  const [quoteType, setQuoteType] = useState("ì¼ë°˜ê¸°ì—…"); // "ì¼ë°˜ê¸°ì—…" | "ê³µê³µê¸°ê´€"
  const [newCL, setNewCL] = useState({division:"ê¸°íš", category:"ê¸°íš", item:"", unitPrice:"", qty:"1", days:"1", note:""});
  const [showAddForm, setShowAddForm] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const [editValues, setEditValues] = useState({});
  const [newCustom, setNewCustom] = useState({division:"ê¸°íƒ€", category:"ì„­ì™¸", item:"", unitPrice:"", qty:"1", days:"1", note:""});
  const [editingCustom, setEditingCustom] = useState(null);
  const [showCustomForm, setShowCustomForm] = useState(false);
  const [showHistory, setShowHistory] = useState(false);
  const [historyNote, setHistoryNote] = useState("");

  const customItems = project.customItems || [];
  const priceMult = quoteType === "ì¼ë°˜ê¸°ì—…" ? 1.1 : 1.0;

  // ê¸ˆì•¡ ê³„ì‚°: ë‹¨ê°€ Ã— ìˆ˜ëŸ‰ Ã— ì¼ì (ì¼ë°˜ê¸°ì—…ì´ë©´ ë‹¨ê°€ Ã—1.1)
  const calcAmt = (item) => Math.round((item.unitPrice||0) * priceMult * (item.qty||1) * (item.days||1));

  // êµ¬ë¶„ë³„ ê²¬ì  ë°ì´í„°
  const quoteByDiv = DIVISIONS.map(div => {
    const clItems  = project.checklist.filter(c => (c.division||"ê¸°íƒ€")===div && (c.unitPrice||0) > 0);
    const custItems= customItems.filter(c => (c.division||"ê¸°íƒ€")===div);
    const subtotal = [...clItems,...custItems].reduce((s,c) => s + calcAmt(c), 0);
    return { div, clItems, custItems, subtotal };
  });
  const custOther = customItems.filter(c => !DIVISIONS.includes(c.division));

  // ê²¬ì ì´ì•¡ A (ì²´í¬ë¦¬ìŠ¤íŠ¸ + ì¶”ê°€í•­ëª© ì „ì²´)
  const A = quoteByDiv.reduce((s,d)=>s+d.subtotal,0) + custOther.reduce((s,c)=>s+calcAmt(c),0);
  const B = quoteType==="ê³µê³µê¸°ê´€" ? Math.round(A*0.08) : 0;
  const C = quoteType==="ê³µê³µê¸°ê´€" ? Math.round((A+B)*0.10) : 0;
  const D = Math.round(A*0.10);
  const total = A + B + C + D;
  const totalFinal = Math.floor(total/10)*10; // 10ì› ë‹¨ìœ„ ì ˆì‚¬

  // ì²´í¬ë¦¬ìŠ¤íŠ¸ í† ê¸€
  const toggle = (id) => {
    const updated = project.checklist.map(c => c.id===id ? {...c,done:!c.done} : c);
    const done = updated.filter(c=>c.done).length;
    onUpdate({...project, checklist:updated, progress:Math.round((done/updated.length)*100),
      logs:[...project.logs,{id:Date.now(),date:today,author:"ì‹œìŠ¤í…œ",type:"auto",
        content:`ì²´í¬ë¦¬ìŠ¤íŠ¸ "${project.checklist.find(c=>c.id===id)?.item}" ì™„ë£Œ ìƒíƒœ ë³€ê²½`}]
    });
    toast("âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ë¨","success");
  };

  // ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì¶”ê°€
  const addCLItem = () => {
    if (!newCL.item.trim()) return;
    const item = {
      id:Date.now(), division:newCL.division, category:newCL.category,
      item:newCL.item, done:false,
      unitPrice:parseInt(newCL.unitPrice)||0,
      qty:parseInt(newCL.qty)||1, days:parseInt(newCL.days)||1, note:newCL.note||"",
    };
    onUpdate({...project, checklist:[...project.checklist, item],
      logs:[...project.logs,{id:Date.now()+1,date:today,author:currentUser?.name||"ì‚¬ìš©ì",type:"auto",
        content:`ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì¶”ê°€: [${newCL.division}] ${newCL.category} - ${newCL.item}`}]
    });
    setNewCL({division:"ê¸°íš",category:"ê¸°íš",item:"",unitPrice:"",qty:"1",days:"1",note:""});
    setShowAddForm(false);
    toast("í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤","success");
  };

  // ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì‚­ì œ
  const deleteCLItem = (id) => {
    const target = project.checklist.find(c=>c.id===id);
    onUpdate({...project, checklist:project.checklist.filter(c=>c.id!==id),
      logs:[...project.logs,{id:Date.now(),date:today,author:currentUser?.name||"ì‚¬ìš©ì",type:"auto",
        content:`ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì‚­ì œ: "${target?.item}"`}]
    });
    toast("í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤");
  };

  // ì¸ë¼ì¸ í¸ì§‘ ì‹œì‘
  const startEdit = (item) => {
    setEditingItem(item.id);
    setEditValues({unitPrice:item.unitPrice||0, qty:item.qty||1, days:item.days||1, note:item.note||""});
  };
  const saveEdit = (id) => {
    const updated = project.checklist.map(c => c.id===id ? {
      ...c, unitPrice:parseInt(editValues.unitPrice)||0,
      qty:parseInt(editValues.qty)||1, days:parseInt(editValues.days)||1, note:editValues.note||"",
    } : c);
    onUpdate({...project, checklist:updated});
    setEditingItem(null);
    toast("âœ… í•­ëª© ìˆ˜ì •ë¨","success");
  };

  // ì¶”ê°€ í•­ëª© ì €ì¥
  const saveCustomItem = () => {
    if (!newCustom.item.trim()) { toast("í•­ëª©ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤","error"); return; }
    const item = {
      id:editingCustom||Date.now(), division:newCustom.division, category:newCustom.category,
      item:newCustom.item, unitPrice:parseInt(newCustom.unitPrice)||0,
      qty:parseInt(newCustom.qty)||1, days:parseInt(newCustom.days)||1, note:newCustom.note||"",
    };
    const upd = editingCustom
      ? customItems.map(c=>c.id===editingCustom?item:c)
      : [...customItems, {...item,id:Date.now()}];
    onUpdate({...project, customItems:upd,
      logs:[...project.logs,{id:Date.now()+1,date:today,author:currentUser?.name||"ì‚¬ìš©ì",type:"auto",
        content:`ê²¬ì  ${editingCustom?"ìˆ˜ì •":"ì¶”ê°€í•­ëª© ë“±ë¡"}: "${newCustom.item}"`}]
    });
    setNewCustom({division:"ê¸°íƒ€",category:"ì„­ì™¸",item:"",unitPrice:"",qty:"1",days:"1",note:""});
    setEditingCustom(null); setShowCustomForm(false);
    toast(editingCustom?"âœï¸ ìˆ˜ì •ë¨":"â• ì¶”ê°€ í•­ëª© ë“±ë¡ë¨","success");
  };
  const startEditCustom = (item) => {
    setNewCustom({division:item.division||"ê¸°íƒ€",category:item.category||"ì„­ì™¸",item:item.item,
      unitPrice:item.unitPrice||0,qty:item.qty||1,days:item.days||1,note:item.note||""});
    setEditingCustom(item.id); setShowCustomForm(true);
  };
  const deleteCustomItem = (id) => {
    const target = customItems.find(c=>c.id===id);
    onUpdate({...project, customItems:customItems.filter(c=>c.id!==id),
      logs:[...project.logs,{id:Date.now(),date:today,author:currentUser?.name||"ì‚¬ìš©ì",type:"auto",
        content:`ê²¬ì  í•­ëª© ì‚­ì œ: "${target?.item}"`}]
    });
    toast("ê²¬ì  í•­ëª© ì‚­ì œë¨");
  };

  // ê²¬ì  í–‰ ê³µí†µ ì»´í¬ë„ŒíŠ¸
  const QuoteRow = ({item, isCustom}) => (
    <div style={{
      display:"grid",gridTemplateColumns:"88px 1fr 70px 38px 38px 80px",
      padding:"5px 10px",gap:4,borderBottom:"1px solid rgba(255,255,255,.03)",alignItems:"center",
      transition:"background .1s",
    }}
      onMouseEnter={e=>e.currentTarget.style.background="rgba(255,255,255,.025)"}
      onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
      <div style={{color:isCustom?"#f59e0b":"var(--txt4)",fontSize:11,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{item.category}</div>
      <div style={{color:isCustom?"#fbbf24":"var(--txt)",fontSize:12,overflow:"hidden"}}>
        {item.item}
        {item.note&&<span style={{color:"var(--txt4)",fontSize:10,marginLeft:4}}>({item.note})</span>}
      </div>
      <div style={{color:"var(--txt3)",fontSize:11,textAlign:"right"}}>{Math.round((item.unitPrice||0)*priceMult).toLocaleString()}</div>
      <div style={{color:"var(--txt3)",fontSize:11,textAlign:"center"}}>{item.qty||1}</div>
      <div style={{color:"var(--txt3)",fontSize:11,textAlign:"center"}}>{item.days||1}</div>
      <div style={{display:"flex",alignItems:"center",justifyContent:"flex-end",gap:3}}>
        <span style={{color:isCustom?"#fbbf24":"var(--txt)",fontSize:12,fontWeight:600}}>{calcAmt(item).toLocaleString()}</span>
        {!isCustom && <button onClick={()=>startEdit(item)} style={{background:"transparent",border:"none",color:"var(--txt4)",fontSize:10,cursor:"pointer",padding:0,lineHeight:1}}>âœï¸</button>}
        {isCustom && <button onClick={()=>startEditCustom(item)} style={{background:"transparent",border:"none",color:"var(--txt4)",fontSize:10,cursor:"pointer",padding:0}}>âœï¸</button>}
        {isCustom && <button onClick={()=>deleteCustomItem(item.id)} style={{background:"transparent",border:"none",color:"#fca5a5",fontSize:11,cursor:"pointer",padding:0}}>Ã—</button>}
      </div>
    </div>
  );

  // ê²¬ì  ì´ë ¥ ì €ì¥
  const saveQuoteSnapshot = () => {
    const snapshot = {
      id: Date.now(),
      date: today,
      author: currentUser?.name || "ì‚¬ìš©ì",
      quoteType,
      A, B, C, D, totalFinal,
      note: historyNote,
      items: [
        ...project.checklist.map(c=>({...c})),
        ...(project.customItems||[]).map(c=>({...c})),
      ],
    };
    onUpdate({
      ...project,
      quoteHistory: [...(project.quoteHistory||[]), snapshot],
      logs: [...project.logs, {
        id: Date.now()+1, date: today,
        author: currentUser?.name || "ì‚¬ìš©ì", type:"auto",
        content: `ğŸ’¾ ê²¬ì  ì´ë ¥ ì €ì¥: [${quoteType}] ì´ ${totalFinal.toLocaleString()}ì›${historyNote?" Â· "+historyNote:""}`,
      }],
    });
    setHistoryNote("");
    toast("ğŸ’¾ ê²¬ì ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤","success");
  };

  // ê²¬ì ì„œ PDF ì¶œë ¥
  const printQuote = () => {
    const divRows = quoteByDiv.map(({div, clItems, custItems}) => {
      const allItems = [...clItems, ...custItems];
      if (!allItems.length) return "";
      return allItems.map((item,i) => `
        <tr>
          ${i===0 ? `<td rowspan="${allItems.length}" style="background:#f0f4ff;font-weight:700;color:#3730a3;text-align:center;vertical-align:middle;border:1px solid #cbd5e1;padding:6px 8px;">${div}</td>` : ""}
          <td style="border:1px solid #cbd5e1;padding:5px 8px;">${item.category}<br/><span style="font-size:11px;color:#64748b">${item.item}</span></td>
          <td style="border:1px solid #cbd5e1;padding:5px 8px;text-align:right;">${Math.round((item.unitPrice||0)*priceMult).toLocaleString()}</td>
          <td style="border:1px solid #cbd5e1;padding:5px 8px;text-align:center;">${item.qty||1}</td>
          <td style="border:1px solid #cbd5e1;padding:5px 8px;text-align:center;">${item.days||1}</td>
          <td style="border:1px solid #cbd5e1;padding:5px 8px;text-align:right;font-weight:600;">${calcAmt(item).toLocaleString()}</td>
          <td style="border:1px solid #cbd5e1;padding:5px 8px;text-align:right;color:#64748b;">${Math.round(calcAmt(item)*0.1).toLocaleString()}</td>
        </tr>`).join("");
    }).join("");
    const adjustment = totalFinal - total;
    const html = `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8">
<title>ê²¬ì ì„œ - ${project.name}</title>
<style>
  body { font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; font-size:13px; color:#1e293b; margin:30px; }
  h1 { text-align:center; font-size:24px; letter-spacing:.2em; color:#1e293b; margin-bottom:6px; }
  .subtitle { text-align:center; color:#64748b; font-size:12px; margin-bottom:20px; }
  .header-box { display:flex; justify-content:space-between; margin-bottom:16px; gap:20px; }
  .info-left { flex:1; }
  .info-left table { width:100%; border-collapse:collapse; }
  .info-left td { border:1px solid #cbd5e1; padding:5px 10px; font-size:12px; }
  .info-left td:first-child { background:#f8fafc; font-weight:700; color:#475569; width:90px; }
  .supplier-box { border:2px solid #3730a3; border-radius:6px; padding:12px 16px; min-width:220px; }
  .supplier-box .title { font-size:11px; color:#6366f1; font-weight:700; margin-bottom:8px; letter-spacing:.05em; }
  .supplier-box table { width:100%; border-collapse:collapse; }
  .supplier-box td { font-size:11px; padding:2px 4px; color:#1e293b; }
  .supplier-box td:first-child { color:#64748b; font-weight:600; width:70px; }
  .total-box { background:#f0f4ff; border:2px solid #6366f1; border-radius:6px; padding:12px 20px; text-align:center; margin-bottom:16px; }
  .total-box .label { font-size:12px; color:#6366f1; font-weight:600; margin-bottom:4px; }
  .total-box .amount { font-size:22px; font-weight:800; color:#1e293b; }
  table.main { width:100%; border-collapse:collapse; margin-bottom:14px; }
  table.main th { background:#3730a3; color:#fff; padding:7px 8px; font-size:12px; border:1px solid #4338ca; text-align:center; }
  .summary { width:320px; margin-left:auto; border-collapse:collapse; }
  .summary td { border:1px solid #cbd5e1; padding:5px 12px; font-size:12px; }
  .summary td:first-child { background:#f8fafc; font-weight:600; color:#475569; }
  .summary td:last-child { text-align:right; font-weight:700; }
  .summary tr.total td { background:#f0f4ff; color:#3730a3; font-size:14px; font-weight:800; }
  .footer { margin-top:20px; font-size:11px; color:#94a3b8; text-align:center; border-top:1px solid #e2e8f0; padding-top:10px; }
  @media print { body { margin:15px; } }
</style></head><body>
<h1>ê²¬ ì  ì„œ</h1>
<p class="subtitle">${today} ê¸°ì¤€ Â· ${quoteType}</p>
<div class="header-box">
  <div class="info-left">
    <table>
      <tr><td>ë°œì£¼ê¸°ê´€</td><td>${project.client||""}</td></tr>
      <tr><td>í–‰ì‚¬ëª…</td><td>${project.name||""}</td></tr>
      <tr><td>í–‰ì‚¬ì¼ì</td><td>${project.eventDate||""}</td></tr>
      <tr><td>ê²¬ì ì¼ì</td><td>${today}</td></tr>
      <tr><td>ë‹´ë‹¹ PD</td><td>${project.producer||""}</td></tr>
    </table>
  </div>
  <div>
    <div class="supplier-box">
      <div class="title">â–¶ ê³µ ê¸‰ ì</div>
      <table>
        <tr><td>ìƒí˜¸</td><td>(ì£¼)ì—í”½ìŠ¤í…Œì´ì§€</td></tr>
        <tr><td>ëŒ€í‘œì</td><td>ê°•ìƒì² </td></tr>
        <tr><td>ë“±ë¡ë²ˆí˜¸</td><td>393-86-03150</td></tr>
        <tr><td>ì£¼ì†Œ</td><td>ê²½ê¸°ë„ ê¹€í¬ì‹œ ê¸ˆí¬í•œê°•ë¡œ<br/>420ë²ˆê¸¸ 30, B321í˜¸</td></tr>
        <tr><td>ì „í™”</td><td>010-2957-3747</td></tr>
        <tr><td>ì´ë©”ì¼</td><td>pd@epicstage.co.kr</td></tr>
      </table>
    </div>
  </div>
</div>
<div class="total-box">
  <div class="label">ì´ ê²¬ì ê¸ˆì•¡ (ë¶€ê°€ì„¸ í¬í•¨)</div>
  <div class="amount">â‚© ${totalFinal.toLocaleString()} ì›</div>
</div>
<table class="main">
  <thead><tr>
    <th style="width:70px">êµ¬ë¶„</th><th>ì„¸ë¶€í•­ëª©</th>
    <th style="width:90px">ë‹¨ê°€(ì›)</th>
    <th style="width:50px">ìˆ˜ëŸ‰</th>
    <th style="width:50px">ì¼ì</th>
    <th style="width:100px">ê³µê¸‰ê°€ì•¡</th>
    <th style="width:90px">ì„¸ì•¡(10%)</th>
  </tr></thead>
  <tbody>${divRows}</tbody>
</table>
<table class="summary">
  <tr><td>ê³µê¸‰ê°€ì•¡ (A)</td><td>${A.toLocaleString()} ì›</td></tr>
  ${quoteType==="ê³µê³µê¸°ê´€" ? `
  <tr><td>ì¼ë°˜ê´€ë¦¬ë¹„ (B = A Ã— 8%)</td><td>${B.toLocaleString()} ì›</td></tr>
  <tr><td>ìˆ˜ìµ (C = (A+B) Ã— 10%)</td><td>${C.toLocaleString()} ì›</td></tr>
  ` : ""}
  <tr><td>ë¶€ê°€ì„¸ (D = A Ã— 10%)</td><td>${D.toLocaleString()} ì›</td></tr>
  <tr><td>í•©ê³„ (A${quoteType==="ê³µê³µê¸°ê´€"?"+B+C":""} + D)</td><td>${total.toLocaleString()} ì›</td></tr>
  ${adjustment!==0 ? `<tr><td>ì¡°ì •</td><td>${adjustment.toLocaleString()} ì›</td></tr>` : ""}
  <tr class="total"><td>ìµœì¢… ê²¬ì ê¸ˆì•¡</td><td>â‚© ${totalFinal.toLocaleString()} ì›</td></tr>
</table>
<p class="footer">ë³¸ ê²¬ì ì„œëŠ” ${today} ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìœ¼ë©°, ì„¸ë¶€ ì‚¬í•­ì€ í˜‘ì˜ í›„ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. | (ì£¼)ì—í”½ìŠ¤í…Œì´ì§€</p>
</body></html>`;
    const win = window.open("","_blank","width=950,height=750");
    win.document.write(html);
    win.document.close();
    setTimeout(()=>win.print(), 600);
  };

  return (
    <div>
      {/* â”€â”€ ê²¬ì  ìœ í˜• í† ê¸€ â”€â”€ */}
      <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:20,flexWrap:"wrap"}}>
        <span style={{color:"var(--txt3)",fontSize:13,fontWeight:700}}>ê²¬ì  ìœ í˜•:</span>
        {[["ì¼ë°˜ê¸°ì—…","ğŸ¢"],["ê³µê³µê¸°ê´€","ğŸ›ï¸"]].map(([t,ic])=>(
          <button key={t} onClick={()=>setQuoteType(t)} style={{
            padding:"6px 16px",borderRadius:8,fontSize:13,fontWeight:700,border:"none",cursor:"pointer",
            background:quoteType===t?(t==="ê³µê³µê¸°ê´€"?"linear-gradient(135deg,#6366f1,#8b5cf6)":"linear-gradient(135deg,#06b6d4,#0ea5e9)"):"rgba(255,255,255,.05)",
            color:quoteType===t?"#fff":"var(--txt3)",transition:"all .2s",
          }}>{ic} {t}</button>
        ))}
        {quoteType==="ì¼ë°˜ê¸°ì—…" && (
          <span style={{background:"rgba(6,182,212,.1)",border:"1px solid rgba(6,182,212,.25)",color:"#38bdf8",borderRadius:6,padding:"3px 10px",fontSize:11,fontWeight:600}}>
            ë‹¨ê°€ ìë™ +10% ì ìš©
          </span>
        )}
        {quoteType==="ê³µê³µê¸°ê´€" && (
          <span style={{background:"rgba(99,102,241,.1)",border:"1px solid rgba(99,102,241,.25)",color:"#a5b4fc",borderRadius:6,padding:"3px 10px",fontSize:11,fontWeight:600}}>
            ì¼ë°˜ê´€ë¦¬ë¹„(8%) Â· ìˆ˜ìµ((A+B)Ã—10%) í¬í•¨
          </span>
        )}
      </div>

      <div className="grid-2">
        {/* â”€â”€ ì¢Œì¸¡: ì²´í¬ë¦¬ìŠ¤íŠ¸ â”€â”€ */}
        <div>
          <div style={{color:"var(--txt)",fontWeight:700,marginBottom:14,fontSize:14}}>ğŸ“‹ í”„ë¡œì íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
          {DIVISIONS.map(div => {
            const divItems = project.checklist.filter(c=>(c.division||"ê¸°íƒ€")===div);
            if (!divItems.length) return null;
            const cats = [...new Set(divItems.map(c=>c.category))];
            return (
              <div key={div} style={{marginBottom:14}}>
                <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:7,paddingBottom:4,borderBottom:`1px solid ${DIV_COLORS[div]}44`}}>
                  <span style={{color:DIV_COLORS[div],fontSize:11,fontWeight:800,textTransform:"uppercase",letterSpacing:".06em"}}>{div}</span>
                </div>
                {cats.map(cat=>(
                  <div key={cat} style={{marginBottom:8}}>
                    <div style={{color:"var(--txt4)",fontSize:10,fontWeight:700,marginBottom:4,marginLeft:2,textTransform:"uppercase",letterSpacing:".04em"}}>Â· {cat}</div>
                    {divItems.filter(c=>c.category===cat).map(item=>(
                      <div key={item.id}>
                        {editingItem===item.id ? (
                          <div style={{background:"rgba(99,102,241,.07)",border:"1px solid rgba(99,102,241,.2)",borderRadius:8,padding:"8px 10px",marginBottom:4}}>
                            <div style={{color:"var(--txt2)",fontSize:12,fontWeight:600,marginBottom:6}}>{item.item}</div>
                            <div style={{display:"flex",gap:5,flexWrap:"wrap",alignItems:"center",marginBottom:5}}>
                              <div style={{display:"flex",alignItems:"center",gap:3}}>
                                <span style={{color:"var(--txt4)",fontSize:10}}>ë‹¨ê°€</span>
                                <input value={editValues.unitPrice} onChange={e=>setEditValues({...editValues,unitPrice:e.target.value})}
                                  style={{width:80,background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:5,padding:"3px 6px",fontSize:12}}/>
                              </div>
                              <span style={{color:"var(--txt4)",fontSize:11}}>Ã—</span>
                              <div style={{display:"flex",alignItems:"center",gap:3}}>
                                <span style={{color:"var(--txt4)",fontSize:10}}>ìˆ˜ëŸ‰</span>
                                <input value={editValues.qty} onChange={e=>setEditValues({...editValues,qty:e.target.value})}
                                  style={{width:44,background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:5,padding:"3px 6px",fontSize:12}}/>
                              </div>
                              <span style={{color:"var(--txt4)",fontSize:11}}>Ã—</span>
                              <div style={{display:"flex",alignItems:"center",gap:3}}>
                                <span style={{color:"var(--txt4)",fontSize:10}}>ì¼ì</span>
                                <input value={editValues.days} onChange={e=>setEditValues({...editValues,days:e.target.value})}
                                  style={{width:44,background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:5,padding:"3px 6px",fontSize:12}}/>
                              </div>
                              <span style={{color:"var(--txt3)",fontSize:12,fontWeight:600}}>= {((parseInt(editValues.unitPrice)||0)*(parseInt(editValues.qty)||1)*(parseInt(editValues.days)||1)).toLocaleString()}ì›</span>
                            </div>
                            <div style={{display:"flex",gap:5,alignItems:"center"}}>
                              <input value={editValues.note} onChange={e=>setEditValues({...editValues,note:e.target.value})}
                                placeholder="ë¹„ê³ " style={{flex:1,background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:5,padding:"3px 6px",fontSize:12}}/>
                              <button onClick={()=>saveEdit(item.id)} style={{background:"rgba(16,185,129,.1)",border:"1px solid rgba(16,185,129,.25)",color:"#34d399",borderRadius:5,padding:"3px 10px",fontSize:11,cursor:"pointer"}}>ì €ì¥</button>
                              <button onClick={()=>setEditingItem(null)} style={{background:"transparent",border:"1px solid var(--border)",color:"var(--txt4)",borderRadius:5,padding:"3px 8px",fontSize:11,cursor:"pointer"}}>ì·¨ì†Œ</button>
                            </div>
                          </div>
                        ) : (
                          <div className={`cl-item ${item.done?"cl-done":"cl-undone"}`}
                            style={{cursor:"pointer",gap:8}} onClick={()=>toggle(item.id)}>
                            <div style={{
                              width:18,height:18,borderRadius:4,border:`1.5px solid ${item.done?"#10b981":"#334155"}`,
                              background:item.done?"#10b981":"transparent",flexShrink:0,
                              display:"flex",alignItems:"center",justifyContent:"center",transition:"all .15s",
                            }}>
                              {item.done&&<span style={{color:"#fff",fontSize:11}}>âœ“</span>}
                            </div>
                            <span style={{flex:1,color:item.done?"var(--txt3)":"var(--txt)",fontSize:13,textDecoration:item.done?"line-through":"none"}}>{item.item}</span>
                            {(item.unitPrice||0)>0 && <span style={{color:"var(--txt3)",fontSize:11,flexShrink:0}}>{Math.round((item.unitPrice||0)*(item.qty||1)*(item.days||1)/10000)}ë§Œ</span>}
                            <button onClick={e=>{e.stopPropagation();startEdit(item);}} style={{background:"transparent",border:"none",color:"var(--txt4)",fontSize:11,cursor:"pointer",padding:"0 2px",flexShrink:0}} title="ìˆ˜ì •">âœï¸</button>
                            <button onClick={e=>{e.stopPropagation();deleteCLItem(item.id);}} style={{background:"transparent",border:"none",color:"var(--txt4)",fontSize:13,cursor:"pointer",padding:"0 2px",flexShrink:0}} title="ì‚­ì œ">Ã—</button>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                ))}
              </div>
            );
          })}

          {/* í•­ëª© ì¶”ê°€ ë²„íŠ¼/í¼ */}
          <div style={{borderTop:"1px dashed rgba(99,102,241,.2)",paddingTop:10,marginTop:4}}>
            <button onClick={()=>setShowAddForm(v=>!v)} style={{
              background:showAddForm?"rgba(99,102,241,.12)":"transparent",
              border:"1px dashed rgba(99,102,241,.35)",color:"#a5b4fc",
              borderRadius:8,padding:"6px 14px",fontSize:12,cursor:"pointer",fontWeight:600,width:"100%",
            }}>
              {showAddForm?"âœ• ë‹«ê¸°":"ï¼‹ ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì¶”ê°€"}
            </button>
            {showAddForm && (
              <div style={{background:"rgba(99,102,241,.04)",border:"1px solid rgba(99,102,241,.15)",borderRadius:8,padding:12,marginTop:8}}>
                <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:6}}>
                  <select value={newCL.division} onChange={e=>setNewCL({...newCL,division:e.target.value,category:DIV_CATS[e.target.value][0]})}
                    style={{background:"#1e293b",border:"1px solid #334155",color:"var(--txt2)",borderRadius:6,padding:"7px 8px",fontSize:12}}>
                    {DIVISIONS.map(d=><option key={d}>{d}</option>)}
                  </select>
                  <select value={newCL.category} onChange={e=>setNewCL({...newCL,category:e.target.value})}
                    style={{background:"#1e293b",border:"1px solid #334155",color:"var(--txt2)",borderRadius:6,padding:"7px 8px",fontSize:12}}>
                    {(DIV_CATS[newCL.division]||[]).map(c=><option key={c}>{c}</option>)}
                  </select>
                  <input className="form-input" placeholder="í•­ëª©ëª…" value={newCL.item}
                    onChange={e=>setNewCL({...newCL,item:e.target.value})}
                    style={{flex:1,minWidth:80,padding:"7px 10px",fontSize:12}}/>
                </div>
                <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
                  <input className="form-input" placeholder="ë‹¨ê°€(ì›)" value={newCL.unitPrice}
                    onChange={e=>setNewCL({...newCL,unitPrice:e.target.value})}
                    style={{flex:1,minWidth:70,padding:"7px 8px",fontSize:12}}/>
                  <input className="form-input" placeholder="ìˆ˜ëŸ‰" value={newCL.qty}
                    onChange={e=>setNewCL({...newCL,qty:e.target.value})}
                    style={{width:56,padding:"7px 8px",fontSize:12}}/>
                  <input className="form-input" placeholder="ì¼ì" value={newCL.days}
                    onChange={e=>setNewCL({...newCL,days:e.target.value})}
                    style={{width:56,padding:"7px 8px",fontSize:12}}/>
                  <input className="form-input" placeholder="ë¹„ê³ " value={newCL.note}
                    onChange={e=>setNewCL({...newCL,note:e.target.value})}
                    style={{flex:1,minWidth:70,padding:"7px 8px",fontSize:12}}/>
                  <button className="btn btn-primary" onClick={addCLItem} style={{padding:"7px 12px",fontSize:12}}>ì¶”ê°€</button>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* â”€â”€ ìš°ì¸¡: ê²¬ì ì„œ â”€â”€ */}
        <div>
          <div style={{color:"var(--txt)",fontWeight:700,marginBottom:10,fontSize:14}}>
            ğŸ’° ê²¬ì ì„œ Â· <span style={{color:quoteType==="ê³µê³µê¸°ê´€"?"#a5b4fc":"#38bdf8"}}>{quoteType==="ê³µê³µê¸°ê´€"?"ğŸ›ï¸ ê³µê³µê¸°ê´€ìš©":"ğŸ¢ ì¼ë°˜ê¸°ì—…ìš©"}</span>
          </div>

          {/* í…Œì´ë¸” (ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš©) */}
          <div className="card-sm" style={{padding:0,overflow:"hidden"}}>
            <div style={{overflowX:"auto"}}>
              {/* í—¤ë” */}
              <div style={{display:"grid",gridTemplateColumns:"88px 1fr 70px 38px 38px 80px",background:"rgba(99,102,241,.12)",padding:"7px 10px",gap:4,minWidth:420}}>
                {["ì„¸ë¶€í•­ëª©","ë‚´ìš©","ë‹¨ê°€","ìˆ˜ëŸ‰","ì¼ì","ê¸ˆì•¡"].map(h=>(
                  <div key={h} style={{color:"#a5b4fc",fontSize:10,fontWeight:700,textAlign:h==="ê¸ˆì•¡"?"right":h==="ìˆ˜ëŸ‰"||h==="ì¼ì"?"center":"left"}}>{h}</div>
                ))}
              </div>

              {/* êµ¬ë¶„ë³„ í•­ëª© */}
              <div style={{minWidth:420}}>
                {DIVISIONS.map(div => {
                  const dData = quoteByDiv.find(d=>d.div===div);
                  if (!dData || (dData.clItems.length===0 && dData.custItems.length===0)) return null;
                  return (
                    <div key={div}>
                      <div style={{padding:"5px 10px",background:`${DIV_COLORS[div]}1a`,borderTop:`1px solid ${DIV_COLORS[div]}44`,
                        color:DIV_COLORS[div],fontSize:10,fontWeight:800,textTransform:"uppercase",letterSpacing:".08em"}}>
                        â–¶ {div}
                      </div>
                      {dData.clItems.map(item => <QuoteRow key={item.id} item={item} isCustom={false}/>)}
                      {dData.custItems.map(item => <QuoteRow key={item.id} item={item} isCustom={true}/>)}
                      <div style={{display:"flex",justifyContent:"flex-end",gap:8,padding:"4px 10px",background:`${DIV_COLORS[div]}0d`,borderBottom:`1px solid ${DIV_COLORS[div]}33`}}>
                        <span style={{color:"var(--txt4)",fontSize:11}}>{div} ì†Œê³„</span>
                        <span style={{color:DIV_COLORS[div],fontSize:12,fontWeight:700}}>{dData.subtotal.toLocaleString()}ì›</span>
                      </div>
                    </div>
                  );
                })}
                {/* êµ¬ë¶„ ë¯¸ë¶„ë¥˜ ì¶”ê°€í•­ëª© */}
                {custOther.length > 0 && (
                  <div>
                    <div style={{padding:"5px 10px",background:"rgba(245,158,11,.1)",color:"#f59e0b",fontSize:10,fontWeight:800}}>â–¶ ê¸°íƒ€ ì¶”ê°€í•­ëª©</div>
                    {custOther.map(item => <QuoteRow key={item.id} item={item} isCustom={true}/>)}
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* ì¶”ê°€ í•­ëª© ë“±ë¡ ë²„íŠ¼ */}
          <div style={{marginTop:8}}>
            <button onClick={()=>{setShowCustomForm(v=>!v);setEditingCustom(null);setNewCustom({division:"ê¸°íƒ€",category:"ì„­ì™¸",item:"",unitPrice:"",qty:"1",days:"1",note:""}); }}
              style={{background:showCustomForm&&!editingCustom?"rgba(245,158,11,.12)":"transparent",border:"1px dashed rgba(245,158,11,.4)",
                color:"#fbbf24",borderRadius:8,padding:"6px 14px",fontSize:12,cursor:"pointer",fontWeight:600,width:"100%"}}>
              {showCustomForm&&!editingCustom?"âœ• ë‹«ê¸°":"â• ì¶”ê°€ í•­ëª© ë“±ë¡ (ì—…ì²´ ìš”ì²­ ë“±)"}
            </button>
            {showCustomForm && (
              <div style={{background:"rgba(245,158,11,.05)",border:"1px solid rgba(245,158,11,.2)",borderRadius:8,padding:12,marginTop:6}}>
                <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:6}}>
                  <select value={newCustom.division} onChange={e=>setNewCustom({...newCustom,division:e.target.value,category:DIV_CATS[e.target.value]?.[0]||"ì„­ì™¸"})}
                    style={{background:"#1e293b",border:"1px solid #334155",color:"var(--txt2)",borderRadius:6,padding:"7px 8px",fontSize:12}}>
                    {DIVISIONS.map(d=><option key={d}>{d}</option>)}
                  </select>
                  <select value={newCustom.category} onChange={e=>setNewCustom({...newCustom,category:e.target.value})}
                    style={{background:"#1e293b",border:"1px solid #334155",color:"var(--txt2)",borderRadius:6,padding:"7px 8px",fontSize:12}}>
                    {(DIV_CATS[newCustom.division]||["ê¸°íƒ€"]).map(c=><option key={c}>{c}</option>)}
                  </select>
                  <input className="form-input" placeholder="í•­ëª©ëª…" value={newCustom.item}
                    onChange={e=>setNewCustom({...newCustom,item:e.target.value})}
                    style={{flex:1,minWidth:80,padding:"7px 10px",fontSize:12}}/>
                </div>
                <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
                  <input className="form-input" placeholder="ë‹¨ê°€(ì›)" value={newCustom.unitPrice}
                    onChange={e=>setNewCustom({...newCustom,unitPrice:e.target.value})}
                    style={{flex:1,minWidth:80,padding:"7px 8px",fontSize:12}}/>
                  <input className="form-input" placeholder="ìˆ˜ëŸ‰" value={newCustom.qty}
                    onChange={e=>setNewCustom({...newCustom,qty:e.target.value})}
                    style={{width:56,padding:"7px 8px",fontSize:12}}/>
                  <input className="form-input" placeholder="ì¼ì" value={newCustom.days}
                    onChange={e=>setNewCustom({...newCustom,days:e.target.value})}
                    style={{width:56,padding:"7px 8px",fontSize:12}}/>
                  <input className="form-input" placeholder="ë¹„ê³ " value={newCustom.note}
                    onChange={e=>setNewCustom({...newCustom,note:e.target.value})}
                    onKeyDown={e=>e.key==="Enter"&&saveCustomItem()}
                    style={{flex:1,minWidth:80,padding:"7px 8px",fontSize:12}}/>
                  <button className="btn btn-primary" onClick={saveCustomItem} style={{padding:"7px 14px",fontSize:12,flexShrink:0}}>
                    {editingCustom?"ìˆ˜ì •":"ì¶”ê°€"}
                  </button>
                </div>
              </div>
            )}
          </div>

          {/* â”€â”€ ê²¬ì  í•©ê³„ â”€â”€ */}
          <div className="card-sm" style={{marginTop:10}}>
            <div style={{color:"var(--txt3)",fontSize:11,marginBottom:8,fontWeight:600}}>ê²¬ì  ê³„ì‚°</div>
            {[
              ["ê²¬ì  ì´ì•¡ (A)", A.toLocaleString()+"ì›", "var(--txt)"],
              ...(quoteType==="ê³µê³µê¸°ê´€" ? [
                ["ì¼ë°˜ê´€ë¦¬ë¹„ (B = A Ã— 8%)", B.toLocaleString()+"ì›", "var(--txt2)"],
                ["ìˆ˜ìµ (C = (A+B) Ã— 10%)", C.toLocaleString()+"ì›", "#10b981"],
              ] : []),
              ["ë¶€ê°€ì„¸ (D = A Ã— 10%)", D.toLocaleString()+"ì›", "var(--txt2)"],
            ].map(([l,v,c])=>(
              <div key={l} className="flex-between" style={{marginBottom:6}}>
                <span style={{color:"var(--txt3)",fontSize:13}}>{l}</span>
                <span style={{color:c,fontWeight:600,fontSize:13}}>{v}</span>
              </div>
            ))}
            <div className="flex-between" style={{paddingTop:8,borderTop:"2px solid rgba(99,102,241,.3)",marginTop:4}}>
              <span style={{color:"#a5b4fc",fontSize:14,fontWeight:800}}>ìµœì¢… í•©ê³„ (10ì› ì ˆì‚¬)</span>
              <span style={{color:"#a5b4fc",fontSize:16,fontWeight:800}}>{totalFinal.toLocaleString()}ì›</span>
            </div>
            <div style={{marginTop:10,background:"rgba(255,255,255,.02)",borderRadius:6,padding:"8px 10px",display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:8}}>
              <div>
                <div style={{color:"var(--txt4)",fontSize:11}}>ê³„ì•½ê¸ˆì•¡</div>
                <div style={{color:"#a5b4fc",fontWeight:700,fontSize:13}}>{(project.budget||0).toLocaleString()}ì›</div>
              </div>
              <div style={{textAlign:"right"}}>
                <div style={{color:"var(--txt4)",fontSize:11}}>ì›ê°€ ëŒ€ë¹„ ì˜ˆìƒ ìˆ˜ìµ</div>
                <div style={{color:(project.budget-A)>=0?"#10b981":"#ef4444",fontWeight:700,fontSize:13}}>
                  {((project.budget||0)-A).toLocaleString()}ì›
                  {project.budget>0 && <span style={{fontSize:11,marginLeft:4}}>({(((project.budget-A)/project.budget)*100).toFixed(1)}%)</span>}
                </div>
              </div>
            </div>
            {/* ê²¬ì  ì €ì¥ ì˜ì—­ */}
            <div style={{marginTop:10,display:"flex",gap:6,alignItems:"center"}}>
              <input value={historyNote} onChange={e=>setHistoryNote(e.target.value)}
                placeholder="ê²¬ì  ì €ì¥ ë©”ëª¨ (ì˜ˆ: 1ì°¨ ê²¬ì , ìˆ˜ì •ë³¸ ë“±)"
                style={{flex:1,background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:6,padding:"6px 10px",fontSize:12}}/>
              <button className="btn" onClick={saveQuoteSnapshot}
                style={{background:"rgba(16,185,129,.1)",border:"1px solid rgba(16,185,129,.25)",color:"#34d399",padding:"6px 12px",fontSize:12,flexShrink:0,borderRadius:6,cursor:"pointer"}}>
                ğŸ’¾ ê²¬ì  ì €ì¥
              </button>
            </div>
            <button className="btn btn-primary" style={{width:"100%",marginTop:8,justifyContent:"center"}}
              onClick={printQuote}>
              ğŸ“„ ê²¬ì ì„œ PDF ì¶œë ¥ ({quoteType})
            </button>
          </div>

          {/* â”€â”€ ê²¬ì  ì´ë ¥ â”€â”€ */}
          <div className="card-sm" style={{marginTop:10}}>
            <div className="flex-between" style={{cursor:"pointer"}} onClick={()=>setShowHistory(h=>!h)}>
              <span style={{color:"var(--txt3)",fontSize:11,fontWeight:600}}>ğŸ“‹ ê²¬ì  ì´ë ¥
                <span style={{marginLeft:6,background:"rgba(99,102,241,.15)",color:"#a5b4fc",borderRadius:9,padding:"1px 7px",fontSize:10,fontWeight:700}}>
                  {(project.quoteHistory||[]).length}
                </span>
              </span>
              <span style={{color:"var(--txt4)",fontSize:12}}>{showHistory?"â–²":"â–¼"}</span>
            </div>
            {showHistory && (
              <div style={{marginTop:10}}>
                {!(project.quoteHistory||[]).length && (
                  <div style={{color:"var(--txt4)",fontSize:12,textAlign:"center",padding:"12px 0"}}>ì €ì¥ëœ ê²¬ì  ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>
                )}
                {[...(project.quoteHistory||[])].reverse().map((snap,idx)=>(
                  <div key={snap.id} style={{
                    background:"rgba(255,255,255,.02)",border:"1px solid rgba(255,255,255,.06)",
                    borderRadius:7,padding:"8px 12px",marginBottom:6,
                  }}>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}>
                      <span style={{color:"var(--txt3)",fontSize:11}}>
                        <span style={{color:"#a5b4fc",fontWeight:700}}>#{(project.quoteHistory||[]).length - idx}</span>
                        &nbsp;Â·&nbsp;{snap.date}&nbsp;Â·&nbsp;{snap.author}&nbsp;Â·&nbsp;
                        <span style={{color:snap.quoteType==="ê³µê³µê¸°ê´€"?"#a5b4fc":"#38bdf8"}}>{snap.quoteType}</span>
                      </span>
                      <span style={{color:"#a5b4fc",fontWeight:700,fontSize:13}}>
                        {snap.totalFinal.toLocaleString()}ì›
                      </span>
                    </div>
                    {snap.note&&<div style={{color:"var(--txt4)",fontSize:11,marginBottom:4}}>ğŸ“ {snap.note}</div>}
                    <div style={{display:"flex",gap:10,flexWrap:"wrap"}}>
                      <span style={{color:"var(--txt4)",fontSize:11}}>A:{snap.A.toLocaleString()}</span>
                      {snap.B>0&&<span style={{color:"var(--txt4)",fontSize:11}}>B:{snap.B.toLocaleString()}</span>}
                      {snap.C>0&&<span style={{color:"var(--txt4)",fontSize:11}}>C:{snap.C.toLocaleString()}</span>}
                      <span style={{color:"var(--txt4)",fontSize:11}}>D:{snap.D.toLocaleString()}</span>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

// â”€ Task Order Panel (ê³¼ì—…ì§€ì‹œì„œ) â”€
function TaskOrderPanel({project, onUpdate}) {
  const to = project.taskOrder || {};
  const [editing, setEditing] = useState(false);
  const [form, setForm] = useState({});

  const EMPTY_TO = {sender:"",receivedDate:"",purpose:"",venue:"",attendance:"",tasks:"",requirements:"",notes:""};

  const startEdit = () => {
    setForm({...EMPTY_TO, ...to});
    setEditing(true);
  };
  const cancel = () => setEditing(false);
  const save = () => {
    onUpdate({...project,
      taskOrder: {...form},
      logs:[...project.logs,{id:Date.now(),date:today,author:"ì‚¬ìš©ì",type:"auto",content:"ê³¼ì—…ì§€ì‹œì„œ ë‚´ìš©ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."}]
    });
    setEditing(false);
    toast("ğŸ“‹ ê³¼ì—…ì§€ì‹œì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤","success");
  };

  const isEmpty = !to.purpose && !to.tasks && !to.sender;

  const FIELDS = [
    {key:"sender",    label:"ë°œì‹ ì¸",       icon:"ğŸ‘¤", type:"text",     placeholder:"ì˜ˆ: ì‚¼ì„±ì „ì ë§ˆì¼€íŒ…íŒ€ í™ê¸¸ë™ íŒ€ì¥"},
    {key:"receivedDate",label:"ìˆ˜ì‹ ì¼",     icon:"ğŸ“…", type:"date",     placeholder:""},
    {key:"venue",     label:"í–‰ì‚¬ ì¥ì†Œ",    icon:"ğŸ“", type:"text",     placeholder:"ì˜ˆ: ì½”ì—‘ìŠ¤ Aí™€ A12 ë¶€ìŠ¤ (150ã¡)"},
    {key:"attendance",label:"ì°¸ì„ ê·œëª¨",    icon:"ğŸ‘¥", type:"text",     placeholder:"ì˜ˆ: ì¼ í‰ê·  ì•½ 500ëª…"},
    {key:"purpose",   label:"í–‰ì‚¬ ëª©ì /ë°°ê²½",icon:"ğŸ¯", type:"textarea", placeholder:"í–‰ì‚¬ì˜ ëª©ì ê³¼ ë°°ê²½ì„ ì…ë ¥í•˜ì„¸ìš”"},
    {key:"tasks",     label:"ì£¼ìš” ê³¼ì—… ì‚¬í•­",icon:"ğŸ“Œ", type:"textarea", placeholder:"ìˆ˜í–‰í•´ì•¼ í•  ì£¼ìš” ê³¼ì—…ì„ ë²ˆí˜¸ ëª©ë¡ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”\nì˜ˆ: 1. ë¶€ìŠ¤ ì„¤ê³„ ë° ì‹œê³µ\n2. ì˜ìƒ ì œì‘\n..."},
    {key:"requirements",label:"íŠ¹ì´ì‚¬í•­/ìš”êµ¬ì‚¬í•­",icon:"âš ï¸",type:"textarea",placeholder:"í´ë¼ì´ì–¸íŠ¸ íŠ¹ë³„ ìš”êµ¬ì‚¬í•­ ë˜ëŠ” ì œì•½ì¡°ê±´"},
    {key:"notes",     label:"ì°¸ê³ ì‚¬í•­",     icon:"ğŸ“", type:"textarea", placeholder:"ê¸°íƒ€ ì°¸ê³ ì‚¬í•­"},
  ];

  return (
    <div style={{
      background:"rgba(99,102,241,.04)",border:"1px solid rgba(99,102,241,.2)",
      borderRadius:"var(--radius)",overflow:"hidden",
    }}>
      {/* í—¤ë” */}
      <div style={{
        display:"flex",alignItems:"center",justifyContent:"space-between",
        padding:"14px 18px",borderBottom:"1px solid rgba(99,102,241,.15)",
        background:"rgba(99,102,241,.06)",
      }}>
        <div style={{display:"flex",alignItems:"center",gap:10}}>
          <span style={{fontSize:18}}>ğŸ“‹</span>
          <div>
            <div style={{color:"#a5b4fc",fontWeight:800,fontSize:14}}>ê³¼ì—…ì§€ì‹œì„œ</div>
            <div style={{color:"var(--txt4)",fontSize:11,marginTop:1}}>
              {to.sender ? `${to.sender}${to.receivedDate ? "  Â·  ìˆ˜ì‹  "+to.receivedDate : ""}` : "í´ë¼ì´ì–¸íŠ¸/ì£¼ìµœì‚¬ ê³¼ì—… ì§€ì‹œ ë‚´ìš©"}
            </div>
          </div>
        </div>
        {!editing ? (
          <button onClick={startEdit} className="btn btn-ghost" style={{fontSize:12,padding:"5px 14px",borderColor:"rgba(99,102,241,.3)",color:"#a5b4fc"}}>
            âœï¸ {isEmpty ? "ê³¼ì—…ì§€ì‹œì„œ ë“±ë¡" : "ìˆ˜ì •"}
          </button>
        ) : (
          <div style={{display:"flex",gap:8}}>
            <button onClick={save} className="btn btn-primary" style={{fontSize:12,padding:"5px 14px"}}>ğŸ’¾ ì €ì¥</button>
            <button onClick={cancel} className="btn btn-ghost" style={{fontSize:12,padding:"5px 12px"}}>ì·¨ì†Œ</button>
          </div>
        )}
      </div>

      {/* ë‚´ìš© */}
      {isEmpty && !editing ? (
        <div style={{padding:"32px 20px",textAlign:"center"}}>
          <div style={{fontSize:36,marginBottom:10}}>ğŸ“„</div>
          <div style={{color:"var(--txt3)",fontSize:14,marginBottom:6}}>ê³¼ì—…ì§€ì‹œì„œê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>
          <div style={{color:"var(--txt4)",fontSize:12,marginBottom:16}}>í´ë¼ì´ì–¸íŠ¸/ì£¼ìµœì‚¬ë¡œë¶€í„° ì „ë‹¬ë°›ì€ ê³¼ì—…ì§€ì‹œ ë‚´ìš©ì„ ë“±ë¡í•˜ì„¸ìš”</div>
          <button onClick={startEdit} className="btn btn-primary" style={{fontSize:13}}>+ ê³¼ì—…ì§€ì‹œì„œ ë“±ë¡</button>
        </div>
      ) : editing ? (
        /* â”€â”€ í¸ì§‘ ëª¨ë“œ â”€â”€ */
        <div style={{padding:"18px 18px 8px"}}>
          <div className="grid-2" style={{gap:12,marginBottom:12}}>
            {FIELDS.filter(f=>f.type==="text"||f.type==="date").map(f=>(
              <div key={f.key} className="form-group" style={{marginBottom:0}}>
                <label className="form-label">{f.icon} {f.label}</label>
                <input className="form-input" type={f.type} placeholder={f.placeholder}
                  value={form[f.key]||""} onChange={e=>setForm({...form,[f.key]:e.target.value})}
                  style={{fontSize:13}}/>
              </div>
            ))}
          </div>
          {FIELDS.filter(f=>f.type==="textarea").map(f=>(
            <div key={f.key} className="form-group">
              <label className="form-label">{f.icon} {f.label}</label>
              <textarea className="form-input" placeholder={f.placeholder}
                value={form[f.key]||""} onChange={e=>setForm({...form,[f.key]:e.target.value})}
                rows={f.key==="tasks"?6:3}
                style={{fontSize:13,resize:"vertical",lineHeight:1.7}}/>
            </div>
          ))}
          <div style={{display:"flex",gap:10,justifyContent:"flex-end",paddingBottom:12}}>
            <button onClick={save} className="btn btn-primary">ğŸ’¾ ì €ì¥</button>
            <button onClick={cancel} className="btn btn-ghost">ì·¨ì†Œ</button>
          </div>
        </div>
      ) : (
        /* â”€â”€ ì¡°íšŒ ëª¨ë“œ â”€â”€ */
        <div style={{padding:"16px 18px"}}>
          {/* ìƒë‹¨ ë©”íƒ€ ì •ë³´ */}
          <div className="grid-2" style={{gap:12,marginBottom:16}}>
            {[
              {icon:"ğŸ‘¤",label:"ë°œì‹ ì¸",val:to.sender},
              {icon:"ğŸ“…",label:"ìˆ˜ì‹ ì¼",val:to.receivedDate},
              {icon:"ğŸ“",label:"í–‰ì‚¬ ì¥ì†Œ",val:to.venue},
              {icon:"ğŸ‘¥",label:"ì°¸ì„ ê·œëª¨",val:to.attendance},
            ].map(({icon,label,val})=> val ? (
              <div key={label} style={{background:"rgba(255,255,255,.03)",border:"1px solid rgba(255,255,255,.05)",borderRadius:8,padding:"10px 14px"}}>
                <div style={{color:"var(--txt4)",fontSize:10,fontWeight:700,textTransform:"uppercase",letterSpacing:".05em",marginBottom:4}}>{icon} {label}</div>
                <div style={{color:"var(--txt)",fontSize:13,fontWeight:500}}>{val}</div>
              </div>
            ) : null)}
          </div>

          {/* ë³¸ë¬¸ ì„¹ì…˜ */}
          {[
            {icon:"ğŸ¯",label:"í–‰ì‚¬ ëª©ì  / ë°°ê²½",key:"purpose"},
            {icon:"ğŸ“Œ",label:"ì£¼ìš” ê³¼ì—… ì‚¬í•­",key:"tasks"},
            {icon:"âš ï¸",label:"íŠ¹ì´ì‚¬í•­ / ìš”êµ¬ì‚¬í•­",key:"requirements"},
            {icon:"ğŸ“",label:"ì°¸ê³ ì‚¬í•­",key:"notes"},
          ].filter(s=>to[s.key]).map(s=>(
            <div key={s.key} style={{marginBottom:14,borderRadius:8,overflow:"hidden"}}>
              <div style={{
                background:"rgba(99,102,241,.08)",borderLeft:"3px solid #6366f1",
                padding:"6px 12px",color:"#a5b4fc",fontSize:11,fontWeight:700,
                textTransform:"uppercase",letterSpacing:".05em",
              }}>{s.icon} {s.label}</div>
              <div style={{
                background:"rgba(255,255,255,.02)",border:"1px solid rgba(255,255,255,.05)",
                borderTop:"none",padding:"12px 14px",
                color:"var(--txt2)",fontSize:13,lineHeight:1.8,
                whiteSpace:"pre-wrap",
              }}>{to[s.key]}</div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

// â”€ WorkLog â”€
function WorkLog({project, onUpdate, users, currentUser}) {
  const [mode, setMode]               = useState("comment"); // "comment" | "delegation"
  const [newLog, setNewLog]           = useState("");
  const [delegateTask, setDelegateTask] = useState("");
  const [delegateTo, setDelegateTo]   = useState("");

  // ìœ„ì„ ê°€ëŠ¥í•œ ë©¤ë²„ (ìŠ¹ì¸ëœ ê³„ì • ì¤‘ ë³¸ì¸ ì œì™¸)
  const assignableUsers = (users||[]).filter(u =>
    u.approved && u.id !== (currentUser?.id)
  );

  const addComment = () => {
    if (!newLog.trim()) return;
    onUpdate({...project, logs:[...project.logs,{
      id:Date.now(), date:today,
      author: currentUser?.name || "ì‚¬ìš©ì",
      type:"comment", content:newLog,
    }]});
    setNewLog("");
    toast("ğŸ’¬ ì½”ë©˜íŠ¸ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤","success");
  };

  const addDelegation = () => {
    if (!delegateTask.trim() || !delegateTo) {
      toast("ê³¼ì—…ëª…ê³¼ ìœ„ì„ ëŒ€ìƒì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”","error"); return;
    }
    const target = (users||[]).find(u => u.id === delegateTo);
    onUpdate({...project, logs:[...project.logs,{
      id:Date.now(), date:today,
      author: currentUser?.name || "ì‚¬ìš©ì",
      type: "delegation",
      content: newLog.trim() || `[${delegateTask}] ê³¼ì—…ì„ ìœ„ì„í•©ë‹ˆë‹¤.`,
      taskName: delegateTask,
      delegateTo:   target?.name || delegateTo,
      delegateToId: delegateTo,
    }]});
    setDelegateTask(""); setDelegateTo(""); setNewLog("");
    toast(`ğŸ“‹ ${target?.name}ì—ê²Œ ê³¼ì—…ì´ ìœ„ì„ë˜ì—ˆìŠµë‹ˆë‹¤`,"success");
  };

  return (
    <div>
      <div style={{color:"var(--txt)",fontWeight:700,marginBottom:14,fontSize:14}}>ğŸ“ ì—…ë¬´ ë¡œê·¸</div>

      {/* ë¡œê·¸ ëª©ë¡ */}
      <div style={{maxHeight:300,overflowY:"auto",display:"flex",flexDirection:"column",gap:6,marginBottom:14}}>
        {[...project.logs].reverse().map(log=>{
          const isDel  = log.type==="delegation";
          const isAuto = log.type==="auto";
          return (
            <div key={log.id} className={`log-item ${isAuto?"log-auto":"log-comment"}`}
              style={isDel?{borderLeft:"3px solid #f59e0b",background:"rgba(245,158,11,.04)"}:{}}>
              <div className="log-avatar" style={{
                background:isDel?"rgba(245,158,11,.2)":isAuto?"rgba(99,102,241,.2)":"rgba(16,185,129,.2)",
              }}>
                {isDel?"ğŸ“‹":isAuto?"ğŸ¤–":"ğŸ’¬"}
              </div>
              <div style={{flex:1,minWidth:0}}>
                <div className="flex-row" style={{marginBottom:3,gap:6,flexWrap:"wrap",alignItems:"center"}}>
                  <span style={{color:"#818cf8",fontSize:12,fontWeight:600}}>{log.author}</span>
                  <span style={{color:"var(--txt4)",fontSize:11}}>{log.date}</span>
                  {isDel ? (
                    <>
                      <span style={{background:"rgba(245,158,11,.15)",color:"#fbbf24",padding:"1px 6px",borderRadius:4,fontSize:10,fontWeight:700}}>ğŸ“‹ ê³¼ì—…ìœ„ì„</span>
                      <span style={{display:"flex",alignItems:"center",gap:4}}>
                        <span style={{color:"var(--txt4)",fontSize:12}}>â†’</span>
                        <span style={{background:"rgba(99,102,241,.18)",color:"#a5b4fc",padding:"2px 10px",borderRadius:12,fontSize:11,fontWeight:700}}>{log.delegateTo}</span>
                      </span>
                    </>
                  ) : isAuto ? (
                    <span style={{background:"rgba(99,102,241,.1)",color:"#818cf8",padding:"1px 6px",borderRadius:4,fontSize:10,fontWeight:600}}>ìë™ê¸°ë¡</span>
                  ) : (
                    <span style={{background:"rgba(16,185,129,.1)",color:"#34d399",padding:"1px 6px",borderRadius:4,fontSize:10,fontWeight:600}}>ì½”ë©˜íŠ¸</span>
                  )}
                </div>
                {isDel && log.taskName && (
                  <div style={{color:"#fbbf24",fontSize:12,fontWeight:700,marginBottom:4}}>ğŸ“Œ {log.taskName}</div>
                )}
                <div style={{color:"var(--txt2)",fontSize:13,lineHeight:1.5}}>{log.content}</div>
              </div>
            </div>
          );
        })}
      </div>

      {/* ëª¨ë“œ í† ê¸€ */}
      <div style={{display:"flex",gap:6,marginBottom:10}}>
        <button onClick={()=>setMode("comment")} style={{
          padding:"5px 14px",borderRadius:6,fontSize:12,fontWeight:600,border:"none",cursor:"pointer",
          background:mode==="comment"?"rgba(16,185,129,.15)":"rgba(255,255,255,.05)",
          color:mode==="comment"?"#34d399":"var(--txt4)",
        }}>ğŸ’¬ ì½”ë©˜íŠ¸</button>
        <button onClick={()=>setMode("delegation")} style={{
          padding:"5px 14px",borderRadius:6,fontSize:12,fontWeight:600,border:"none",cursor:"pointer",
          background:mode==="delegation"?"rgba(245,158,11,.15)":"rgba(255,255,255,.05)",
          color:mode==="delegation"?"#fbbf24":"var(--txt4)",
        }}>ğŸ“‹ ê³¼ì—… ìœ„ì„</button>
      </div>

      {/* ì½”ë©˜íŠ¸ ì…ë ¥ */}
      {mode==="comment" && (
        <div style={{display:"flex",gap:8}}>
          <input className="form-input" value={newLog} onChange={e=>setNewLog(e.target.value)}
            placeholder="ì—…ë¬´ ì½”ë©˜íŠ¸ ì…ë ¥ (Enter)" onKeyDown={e=>e.key==="Enter"&&addComment()}
            style={{flex:1}}/>
          <button className="btn btn-primary" onClick={addComment}>ê¸°ë¡</button>
        </div>
      )}

      {/* ê³¼ì—… ìœ„ì„ ì…ë ¥ */}
      {mode==="delegation" && (
        <div style={{background:"rgba(245,158,11,.06)",border:"1px solid rgba(245,158,11,.2)",borderRadius:10,padding:14}}>
          <div style={{display:"flex",gap:8,marginBottom:8,flexWrap:"wrap"}}>
            <input className="form-input" placeholder="ğŸ“Œ ê³¼ì—…ëª… *" value={delegateTask}
              onChange={e=>setDelegateTask(e.target.value)}
              style={{flex:2,minWidth:150}}/>
            <select className="form-input" value={delegateTo} onChange={e=>setDelegateTo(e.target.value)}
              style={{flex:1,minWidth:130}}>
              <option value="">ğŸ‘¤ ìœ„ì„ ëŒ€ìƒ ì„ íƒ *</option>
              {assignableUsers.map(u=>(
                <option key={u.id} value={u.id}>{u.name} Â· {u.role}</option>
              ))}
            </select>
          </div>
          <div style={{display:"flex",gap:8}}>
            <input className="form-input" value={newLog} onChange={e=>setNewLog(e.target.value)}
              placeholder="ìœ„ì„ ë‚´ìš© / ì „ë‹¬ì‚¬í•­ (ì„ íƒì‚¬í•­)" style={{flex:1}}
              onKeyDown={e=>e.key==="Enter"&&addDelegation()}/>
            <button onClick={addDelegation} style={{
              background:"rgba(245,158,11,.2)",border:"1px solid rgba(245,158,11,.4)",
              color:"#fbbf24",borderRadius:8,padding:"8px 16px",fontSize:13,fontWeight:700,cursor:"pointer",flexShrink:0,
            }}>ğŸ“‹ ìœ„ì„</button>
          </div>
          {assignableUsers.length===0 && (
            <div style={{color:"var(--txt4)",fontSize:12,marginTop:8}}>âš ï¸ ìœ„ì„ ê°€ëŠ¥í•œ ìŠ¹ì¸ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>
          )}
        </div>
      )}
    </div>
  );
}

// â”€ AI Summary â”€
function AISummaryPanel({project}) {
  const [summary, setSummary] = useState(null);
  const [loading, setLoading] = useState(false);
  const generate = async () => {
    setLoading(true);
    await new Promise(r=>setTimeout(r,1200));
    const done = project.checklist.filter(c=>c.done).length;
    const total = project.checklist.length;
    const profit = profitRate(project.budget, project.cost);
    setSummary(`[AI ë¶„ì„ ìš”ì•½] ${project.name} í”„ë¡œì íŠ¸ëŠ” í˜„ì¬ ${project.progress}% ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì²´í¬ë¦¬ìŠ¤íŠ¸ ${total}ê°œ í•­ëª© ì¤‘ ${done}ê°œ ì™„ë£Œ(${Math.round(done/total*100)}%)ë˜ì—ˆìœ¼ë©°, ì˜ˆìƒ ìˆ˜ìµë¥ ì€ ${profit}%ì…ë‹ˆë‹¤. ${project.status==="ì§„í–‰ì¤‘"?"ì£¼ìš” ë¯¸ì™„ë£Œ í•­ëª©ìœ¼ë¡œ "+project.checklist.filter(c=>!c.done).slice(0,2).map(c=>c.item).join(", ")+" ë“±ì´ ë‚¨ì•„ ìˆì–´ ì¡°ì†í•œ ì§„í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤.":project.status==="ì™„ë£Œ"?"í–‰ì‚¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë³´ê³ ì„œ ì‘ì„± ë° ìµœì¢… ì •ì‚°ì„ ì§„í–‰í•˜ì„¸ìš”.":"ì¤€ë¹„ ë‹¨ê³„ë¡œ í‚¥ì˜¤í”„ ì´í›„ ì£¼ìš” ê³¼ì—… ì°©ìˆ˜ê°€ í•„ìš”í•©ë‹ˆë‹¤."}`);
    setLoading(false);
  };
  return (
    <div className="ai-panel">
      <div className="flex-between" style={{marginBottom:12}}>
        <div style={{color:"#a5b4fc",fontWeight:700,fontSize:14}}>ğŸ¤– AI í”„ë¡œì íŠ¸ ìë™ ìš”ì•½</div>
        <button onClick={generate} disabled={loading} className="btn btn-ghost" style={{fontSize:12,padding:"5px 12px"}}>
          {loading?"ìƒì„± ì¤‘...":"ìš”ì•½ ìƒì„±"}
        </button>
      </div>
      {summary
        ? <div style={{color:"var(--txt2)",fontSize:13,lineHeight:1.7}}>{summary}</div>
        : <div style={{color:"var(--txt4)",fontSize:13}}>ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ AIê°€ í”„ë¡œì íŠ¸ í˜„í™©ì„ ìë™ ìš”ì•½í•©ë‹ˆë‹¤.</div>
      }
    </div>
  );
}

// â”€ Report Panel â”€
function ReportPanel({project}) {
  const [type, setType] = useState("ìš´ì˜ê³„íšì•ˆ");
  const [gen, setGen] = useState(false);
  const [report, setReport] = useState(null);
  const generate = async () => {
    setGen(true);
    await new Promise(r=>setTimeout(r,1500));
    const items = project.checklist.map(c=>{const amt=(c.unitPrice||0)*(c.qty||1)*(c.days||1);return `  - [${c.division||c.category}] ${c.item}${amt>0?" (ì˜ˆì‚°: "+amt.toLocaleString()+"ì›)":""}`;}).join("\n");
    if (type==="ìš´ì˜ê³„íšì•ˆ") {
      setReport(`# ${project.name} ìš´ì˜ê³„íšì•ˆ\n\n## 1. í–‰ì‚¬ ê°œìš”\n- í–‰ì‚¬ëª…: ${project.name}\n- í´ë¼ì´ì–¸íŠ¸: ${project.client}\n- í–‰ì‚¬ì¼: ${project.eventDate}\n- ì¥ì†Œ: í˜‘ì˜ ì™„ë£Œ\n- ì˜ˆìƒ ì¸ì›: ì¶”í›„ í™•ì •\n\n## 2. ìš´ì˜ ëª©ì \nê³ ê°ì‚¬ì˜ ë¸Œëœë“œ ê°€ì¹˜ ì œê³  ë° ë¹„ì¦ˆë‹ˆìŠ¤ ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ì „ë¬¸ì ì¸ í–‰ì‚¬ ìš´ì˜\n\n## 3. ê³¼ì—… ìˆ˜í–‰ ê³„íš\n${items}\n\n## 4. ì¸ë ¥ ìš´ì˜ ê³„íš\n- ì´ê´„ í”„ë¡œë“€ì„œ: ${project.producer}\n- í˜„ì¥ ë§¤ë‹ˆì €: ë°°ì • ì˜ˆì •\n- ì§€ì› ìŠ¤íƒœí”„: í–‰ì‚¬ ê·œëª¨ì— ë”°ë¼ í™•ì •\n\n## 5. ìš´ì˜ íƒ€ì„ë¼ì¸\n${project.gantt.map(g=>`  - D+${g.start}: ${g.task} (${g.duration}ì¼)`).join("\n")}\n\n## 6. ì˜ˆì‚° ê³„íš\n- ì´ ê³„ì•½ê¸ˆì•¡: ${fmt(project.budget)}\n- ì˜ˆìƒ ì›ê°€: ${fmt(project.cost)}\n\n---\nì‘ì„±ì¼: ${today}  |  ë‹´ë‹¹: ${project.producer}`);
    } else {
      setReport(`# ${project.name} ê²°ê³¼ë³´ê³ ì„œ\n\n## 1. í–‰ì‚¬ ê°œìš”\n- í–‰ì‚¬ëª…: ${project.name}\n- í´ë¼ì´ì–¸íŠ¸: ${project.client}\n- í–‰ì‚¬ì¼: ${project.eventDate}\n- ë‹´ë‹¹ í”„ë¡œë“€ì„œ: ${project.producer}\n\n## 2. í–‰ì‚¬ ì§„í–‰ ê²°ê³¼\n${project.logs.map(l=>`  [${l.date}] ${l.content}`).join("\n")}\n\n## 3. ì²´í¬ë¦¬ìŠ¤íŠ¸ ì´í–‰ í˜„í™©\n- ì´ í•­ëª©: ${project.checklist.length}ê°œ\n- ì™„ë£Œ: ${project.checklist.filter(c=>c.done).length}ê°œ\n- ì™„ë£Œìœ¨: ${Math.round(project.checklist.filter(c=>c.done).length/project.checklist.length*100)}%\n\n## 4. ì˜ˆì‚° ì§‘í–‰ ê²°ê³¼\n- ê³„ì•½ê¸ˆì•¡: ${fmt(project.budget)}\n- ì§‘í–‰ê¸ˆì•¡: ${fmt(project.cost)}\n- ìˆ˜ìµë¥ : ${profitRate(project.budget,project.cost)}%\n\n## 5. ì„±ê³¼ ë° í”¼ë“œë°±\n- ì „ë°˜ì ì¸ í–‰ì‚¬ ì§„í–‰ì€ ê³„íšì— ë”°ë¼ ì›í™œíˆ ì´ë£¨ì–´ì¡ŒìŠµë‹ˆë‹¤.\n- í´ë¼ì´ì–¸íŠ¸ ë§Œì¡±ë„ ì¡°ì‚¬ ê²°ê³¼ í›„ê¸° ì²¨ë¶€ ì˜ˆì •\n\n## 6. ê°œì„ ì‚¬í•­\n- ì°¨ê¸° í–‰ì‚¬ ì¤€ë¹„ ì‹œ ì„ ë°˜ì˜ ì˜ˆì • ì‚¬í•­ ì •ë¦¬ í•„ìš”\n\n---\nì‘ì„±ì¼: ${today}  |  ë‹´ë‹¹: ${project.producer}`);
    }
    setGen(false);
  };
  return (
    <div>
      <div style={{color:"var(--txt)",fontWeight:700,marginBottom:14,fontSize:14}}>ğŸ“Š ë³´ê³ ì„œ ìë™ ìƒì„±</div>
      <div className="flex-row" style={{marginBottom:14,flexWrap:"wrap",gap:8}}>
        {["ìš´ì˜ê³„íšì•ˆ","ê²°ê³¼ë³´ê³ ì„œ"].map(t=>(
          <button key={t} onClick={()=>{setType(t);setReport(null);}} className="btn btn-ghost"
            style={type===t?{borderColor:var_("primary-border"),color:"#a5b4fc",background:var_("primary-dim")}:{}}>
            {t}
          </button>
        ))}
        <button onClick={generate} disabled={gen} className="btn btn-primary" style={{marginLeft:"auto"}}>
          {gen?"ìƒì„± ì¤‘...":type+" ìƒì„±"}
        </button>
      </div>
      {report && (
        <div className="report-preview">
          <pre>{report}</pre>
          <button className="btn btn-ghost" style={{marginTop:12,fontSize:12,width:"100%",justifyContent:"center"}}
            onClick={()=>toast("ğŸ“¥ ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ì—°ë™ ì˜ˆì •ì…ë‹ˆë‹¤","warn")}>
            ğŸ“¥ Word/PDFë¡œ ë‚´ë³´ë‚´ê¸°
          </button>
        </div>
      )}
      {!report && <div style={{color:"var(--txt4)",fontSize:13,padding:20,textAlign:"center",border:"1px dashed rgba(255,255,255,.07)",borderRadius:10}}>ë³´ê³ ì„œ ìœ í˜• ì„ íƒ í›„ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>}
    </div>
  );
}

// â”€ Reports Tab Wrapper (ë³´ê³ ì„œ íƒ­ ë‚´ ì„œë¸Œ íƒ­) â”€
function ReportsTabWrapper({project}) {
  const [subTab, setSubTab] = React.useState("plan");
  const SUB_TABS = [
    {id:"plan",   icon:"ğŸ“‹", label:"ìš´ì˜ê³„íšì•ˆ", color:"#6366f1"},
    {id:"report", icon:"ğŸ“Š", label:"ê²°ê³¼ë³´ê³ ì„œ", color:"#10b981"},
  ];
  return (
    <div>
      {/* ì„œë¸Œ íƒ­ í—¤ë” */}
      <div style={{display:"flex",gap:6,marginBottom:20,padding:"4px",background:"rgba(255,255,255,.03)",borderRadius:10,border:"1px solid var(--border)",width:"fit-content"}}>
        {SUB_TABS.map(t=>(
          <button key={t.id} onClick={()=>setSubTab(t.id)} style={{
            background: subTab===t.id ? (t.id==="plan" ? "linear-gradient(135deg,#6366f1,#8b5cf6)" : "linear-gradient(135deg,#10b981,#059669)") : "transparent",
            border:"none",borderRadius:8,padding:"8px 18px",cursor:"pointer",
            color: subTab===t.id ? "#fff" : "var(--txt3)",
            fontWeight: subTab===t.id ? 700 : 500,
            fontSize:13,display:"flex",alignItems:"center",gap:6,transition:"all .15s",
          }}>
            {t.icon} {t.label}
          </button>
        ))}
      </div>
      {/* ì„œë¸Œ íƒ­ ì½˜í…ì¸  */}
      {subTab==="plan"  && <DocEditorPanel docType="plan"   project={project}/>}
      {subTab==="report"&& <DocEditorPanel docType="report" project={project}/>}
    </div>
  );
}

// helper to use CSS vars in inline styles
function var_(name) { return `var(--${name})`; }

// â”€ File Manager (Google Drive ì—°ë™ íŒŒì¼ ê´€ë¦¬) â”€
function FileManager({project, onUpdate}) {
  const [uploading, setUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState("");
  const [driveFiles, setDriveFiles] = useState([]);
  const [loadingFiles, setLoadingFiles] = useState(false);
  const fileInputRef = useRef(null);

  // Driveì—ì„œ íŒŒì¼ ëª©ë¡ ë¡œë“œ
  useEffect(() => {
    if (!DRIVE_CONFIG.ENABLED) return;
    setLoadingFiles(true);
    SyncManager.listFiles(project.name).then(files => {
      setDriveFiles(files);
      setLoadingFiles(false);
    });
  }, [project.name]);

  // íŒŒì¼ ì„ íƒ/ë“œë¡­ í•¸ë“¤ëŸ¬
  const handleFiles = async (fileList) => {
    if (!fileList || !fileList.length) return;

    for (let i = 0; i < fileList.length; i++) {
      const file = fileList[i];
      if (file.size > 50 * 1024 * 1024) {
        toast(`âš ï¸ "${file.name}" íŒŒì¼ì´ 50MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`, "error");
        continue;
      }

      setUploading(true);
      setUploadProgress(`"${file.name}" ì—…ë¡œë“œ ì¤‘... (${(file.size/1024/1024).toFixed(1)}MB)`);

      // base64 ë³€í™˜
      const base64 = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(",")[1]);
        reader.readAsDataURL(file);
      });

      if (DRIVE_CONFIG.ENABLED) {
        // Google Driveì— ì—…ë¡œë“œ
        const result = await SyncManager.uploadFile(project.name, file.name, base64, file.type);
        if (result && result.ok) {
          // í”„ë¡œì íŠ¸ files ë°°ì—´ ì—…ë°ì´íŠ¸
          const fileEntry = { name: file.name, driveFileId: result.fileId, mimeType: file.type, size: file.size, uploadedAt: new Date().toISOString(), url: result.url };
          const updatedFiles = [...(project.files||[]).filter(f => (typeof f==="string" ? f : f.name) !== file.name), fileEntry];
          onUpdate({...project, files: updatedFiles});
          setDriveFiles(prev => [...prev.filter(f=>f.name!==file.name), { fileId: result.fileId, name: file.name, mimeType: file.type, size: file.size, url: result.url, lastUpdated: new Date().toISOString() }]);
          toast(`âœ… "${file.name}" ì—…ë¡œë“œ ì™„ë£Œ`, "success");
        } else {
          toast(`âŒ "${file.name}" ì—…ë¡œë“œ ì‹¤íŒ¨`, "error");
        }
      } else {
        // Drive ë¯¸ì—°ê²°: íŒŒì¼ëª…ë§Œ ì €ì¥
        const fileEntry = { name: file.name, mimeType: file.type, size: file.size, uploadedAt: new Date().toISOString() };
        const updatedFiles = [...(project.files||[]).filter(f => (typeof f==="string" ? f : f.name) !== file.name), fileEntry];
        onUpdate({...project, files: updatedFiles});
        toast(`ğŸ“ "${file.name}" ë“±ë¡ë¨ (Drive ì—°ê²° ì‹œ ìë™ ì—…ë¡œë“œ)`, "warn");
      }
    }
    setUploading(false);
    setUploadProgress("");
    if (fileInputRef.current) fileInputRef.current.value = "";
  };

  const handleDrop = (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); };
  const handleDragOver = (e) => { e.preventDefault(); };

  // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
  const handleDownload = async (file) => {
    if (file.url) {
      window.open(file.url, "_blank");
    } else if (file.driveFileId && DRIVE_CONFIG.ENABLED) {
      try {
        const res = await fetch(`${DRIVE_CONFIG.GAS_URL}?action=downloadFile&fileId=${file.driveFileId}`, {redirect:"follow"});
        const data = await res.json();
        if (data.webViewLink) window.open(data.webViewLink, "_blank");
      } catch { toast("ë‹¤ìš´ë¡œë“œ ë§í¬ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤", "error"); }
    } else {
      toast("Google Drive ì—°ê²° í›„ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤", "warn");
    }
  };

  // íŒŒì¼ ì‚­ì œ
  const handleDelete = async (file) => {
    const fileName = typeof file === "string" ? file : file.name;
    // í”„ë¡œì íŠ¸ì—ì„œ ì œê±°
    const updatedFiles = (project.files||[]).filter(f => (typeof f==="string" ? f : f.name) !== fileName);
    onUpdate({...project, files: updatedFiles});
    // Driveì—ì„œë„ ì‚­ì œ
    if (file.driveFileId && DRIVE_CONFIG.ENABLED) {
      try {
        await fetch(DRIVE_CONFIG.GAS_URL, {
          method:"POST", headers:{"Content-Type":"text/plain"},
          body: JSON.stringify({action:"deleteFile", fileId: file.driveFileId}), redirect:"follow",
        });
      } catch {}
    }
    setDriveFiles(prev => prev.filter(f=>f.name!==fileName));
    toast(`ğŸ—‘ï¸ "${fileName}" ì‚­ì œë¨`);
  };

  // files ë°°ì—´ í†µí•© (ê¸°ì¡´ string[] + ìƒˆ object[])
  const allFiles = useMemo(() => {
    const projectFiles = (project.files||[]).map(f => typeof f === "string" ? { name: f, legacy: true } : f);
    // driveFilesì—ë§Œ ìˆëŠ” íŒŒì¼ ì¶”ê°€
    const projNames = new Set(projectFiles.map(f=>f.name));
    const extra = driveFiles.filter(df => !projNames.has(df.name));
    return [...projectFiles, ...extra];
  }, [project.files, driveFiles]);

  const fmtSize = (s) => s ? (s > 1048576 ? (s/1048576).toFixed(1)+"MB" : (s/1024).toFixed(0)+"KB") : "";

  return (
    <div>
      <div style={{color:"var(--txt)",fontWeight:700,marginBottom:14,fontSize:14}}>ğŸ“ íŒŒì¼ & ê³µìœ  ë“œë¼ì´ë¸Œ</div>

      {/* ì—…ë¡œë“œ ë“œë¡­ì¡´ */}
      <input ref={fileInputRef} type="file" multiple style={{display:"none"}} onChange={e=>handleFiles(e.target.files)}/>
      <div className="drop-zone" onClick={()=>fileInputRef.current?.click()} onDrop={handleDrop} onDragOver={handleDragOver}
        style={uploading?{borderColor:"#6366f1",background:"rgba(99,102,241,.06)"}:{}}>
        {uploading ? (
          <>
            <div style={{fontSize:32,marginBottom:10,animation:"spin 1s linear infinite"}}>ğŸ”„</div>
            <div style={{color:"#a5b4fc",marginBottom:6}}>{uploadProgress}</div>
          </>
        ) : (
          <>
            <div style={{fontSize:32,marginBottom:10}}>â˜ï¸</div>
            <div style={{color:"#94a3b8",marginBottom:6}}>íŒŒì¼ ë“œë˜ê·¸ ë˜ëŠ” í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
            <div style={{color:"var(--txt4)",fontSize:12}}>
              {DRIVE_CONFIG.ENABLED ? "ì—…ë¡œë“œ íŒŒì¼ì€ Google Driveì— ìë™ ì €ì¥ë©ë‹ˆë‹¤" : "Google Drive ì—°ê²° í›„ í´ë¼ìš°ë“œ ë™ê¸°í™” ê°€ëŠ¥"}
            </div>
          </>
        )}
      </div>

      {/* íŒŒì¼ ëª©ë¡ */}
      <div className="card-sm" style={{marginTop:14}}>
        <div className="flex-between" style={{marginBottom:10}}>
          <span style={{color:"var(--txt3)",fontSize:12}}>ğŸ“‚ Google Drive: /{project.name}</span>
          {loadingFiles && <span style={{color:"var(--txt4)",fontSize:11}}>ë¡œë”© ì¤‘...</span>}
          {DRIVE_CONFIG.ENABLED && !loadingFiles && (
            <button className="btn btn-ghost" style={{padding:"2px 8px",fontSize:10}}
              onClick={()=>{setLoadingFiles(true);SyncManager.listFiles(project.name).then(f=>{setDriveFiles(f);setLoadingFiles(false)})}}>
              ğŸ”„ ìƒˆë¡œê³ ì¹¨
            </button>
          )}
        </div>

        {allFiles.length === 0 && (
          <div style={{textAlign:"center",color:"var(--txt4)",padding:20,fontSize:13}}>ë“±ë¡ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
        )}

        {allFiles.map((f, i) => (
          <div key={f.name+i} className="flex-between" style={{padding:"8px 0",borderBottom:"1px solid rgba(255,255,255,.04)",flexWrap:"wrap",gap:6}}>
            <div style={{display:"flex",alignItems:"center",gap:8,flex:1,minWidth:0}}>
              <span style={{fontSize:16,flexShrink:0}}>{
                f.mimeType?.includes("pdf") ? "ğŸ“„" :
                f.mimeType?.includes("image") ? "ğŸ–¼ï¸" :
                f.mimeType?.includes("video") ? "ğŸ¬" :
                f.mimeType?.includes("zip") || f.mimeType?.includes("compressed") ? "ğŸ“¦" :
                f.mimeType?.includes("presentation") || f.name?.endsWith(".pptx") ? "ğŸ“Š" : "ğŸ“"
              }</span>
              <div style={{minWidth:0}}>
                <div style={{color:"var(--txt2)",fontSize:13,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{f.name}</div>
                {(f.size || f.uploadedAt) && (
                  <div style={{color:"var(--txt4)",fontSize:10}}>
                    {fmtSize(f.size)} {f.uploadedAt ? ` Â· ${f.uploadedAt.slice(0,10)}` : ""}
                  </div>
                )}
              </div>
            </div>
            <div style={{display:"flex",gap:6,alignItems:"center",flexShrink:0}}>
              {(f.driveFileId || f.url) && <span style={{color:"#10b981",fontSize:11}}>Drive âœ“</span>}
              {f.legacy && !f.driveFileId && <span style={{color:"var(--txt4)",fontSize:10}}>ë¡œì»¬</span>}
              <button className="btn btn-ghost" style={{padding:"3px 10px",fontSize:11}}
                onClick={()=>handleDownload(f)}>
                {f.driveFileId || f.url ? "ì—´ê¸°" : "ë‹¤ìš´ë¡œë“œ"}
              </button>
              <button className="btn btn-ghost" style={{padding:"3px 8px",fontSize:11,color:"#fca5a5",borderColor:"rgba(239,68,68,.2)"}}
                onClick={()=>handleDelete(f)}>ì‚­ì œ</button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// â”€ Project Detail â”€
function ProjectDetail({project, onBack, onUpdate, currentUser, users}) {
  const [tab, setTab] = useState("overview");
  const sc = STATUS_COLORS[project.status]||"#6b7280";
  const profit = profitRate(project.budget, project.cost);
  const tabs = [
    {id:"overview",label:"ê°œìš”"},
    {id:"checklist",label:"ì²´í¬/ê²¬ì "},
    {id:"gantt",label:"ê°„íŠ¸ì°¨íŠ¸"},
    {id:"logs",label:"ì—…ë¬´ ë¡œê·¸"},
    {id:"reports",label:"ë³´ê³ ì„œ"},
    {id:"files",label:"íŒŒì¼"},
  ];

  return (
    <div>
      <button onClick={onBack} style={{background:"transparent",border:"none",color:"#6366f1",fontSize:13,marginBottom:20,cursor:"pointer",display:"flex",alignItems:"center",gap:6}}>
        â† í”„ë¡œì íŠ¸ ëª©ë¡
      </button>
      {/* í—¤ë” */}
      <div style={{marginBottom:24}}>
        <div className="flex-row" style={{marginBottom:6,flexWrap:"wrap",gap:8}}>
          <h2 style={{color:"var(--txt)",fontSize:20,fontWeight:800}}>{project.name}</h2>
          <span className="badge" style={{background:`${sc}22`,color:sc,border:`1px solid ${sc}44`}}>{project.status}</span>
        </div>
        <div style={{color:"var(--txt3)",fontSize:13}}>{project.client} Â· í”„ë¡œë“€ì„œ {project.producer} Â· í–‰ì‚¬ì¼ {project.eventDate}</div>
      </div>
      {/* KPI */}
      <div className="grid-3" style={{marginBottom:24}}>
        {[
          {label:"ì§„í–‰ë¥ ",value:`${project.progress}%`,color:"#a5b4fc"},
          {label:"ìˆ˜ìµë¥ ",value:`${profit}%`,color:profit>20?"#10b981":"#f59e0b"},
          {label:"ê³„ì•½ê¸ˆì•¡",value:`${(project.budget/10000000).toFixed(1)}ì–µ`,color:"#f59e0b"},
        ].map(k=>(
          <div key={k.label} style={{background:"rgba(255,255,255,.03)",border:"1px solid var(--border)",borderRadius:10,padding:"14px 16px",textAlign:"center"}}>
            <div style={{color:"var(--txt3)",fontSize:11,marginBottom:6}}>{k.label}</div>
            <div style={{color:k.color,fontSize:22,fontWeight:800}}>{k.value}</div>
          </div>
        ))}
      </div>
      {/* íƒ­ */}
      <div className="tab-bar">
        {tabs.map(t=>(
          <button key={t.id} className={`tab-btn${tab===t.id?" active":""}`} onClick={()=>setTab(t.id)}>{t.label}</button>
        ))}
      </div>
      {/* íƒ­ ì½˜í…ì¸  */}
      {tab==="overview"&&(
        <div style={{display:"flex",flexDirection:"column",gap:20}}>
          {/* ê³¼ì—…ì§€ì‹œì„œ â€” ìƒë‹¨ ë°°ì¹˜ */}
          <TaskOrderPanel project={project} onUpdate={onUpdate}/>

          <AISummaryPanel project={project}/>
          <div className="grid-2">
            <div className="card-sm">
              <div style={{color:"var(--txt3)",fontSize:12,marginBottom:10}}>ğŸ“… ì¼ì • í˜„í™©</div>
              {[["ì‹œì‘ì¼",project.startDate],["í–‰ì‚¬ì¼",project.eventDate],["ì¢…ë£Œì¼",project.endDate]].map(([l,v])=>(
                <div key={l} className="flex-between" style={{marginBottom:8}}>
                  <span style={{color:"var(--txt3)",fontSize:13}}>{l}</span>
                  <span style={{color:"var(--txt)",fontSize:13,fontWeight:600}}>{v}</span>
                </div>
              ))}
            </div>
            <div className="card-sm">
              <div style={{color:"var(--txt3)",fontSize:12,marginBottom:10}}>ğŸ’µ ì˜ˆì‚° í˜„í™©</div>
              {[
                ["ê³„ì•½ê¸ˆì•¡",fmt(project.budget),"#a5b4fc"],
                ["ì˜ˆìƒì›ê°€",fmt(project.cost),"var(--txt)"],
                ["ì˜ˆìƒìˆ˜ìµ",fmt(project.budget-project.cost),profit>0?"#10b981":"#ef4444"],
              ].map(([l,v,c])=>(
                <div key={l} className="flex-between" style={{marginBottom:8}}>
                  <span style={{color:"var(--txt3)",fontSize:13}}>{l}</span>
                  <span style={{color:c,fontSize:13,fontWeight:600}}>{v}</span>
                </div>
              ))}
            </div>
          </div>
          <WorkLog project={project} onUpdate={onUpdate} users={users} currentUser={currentUser}/>
        </div>
      )}
      {tab==="checklist"&&<ChecklistPanel project={project} onUpdate={onUpdate} currentUser={currentUser}/>}
      {tab==="gantt"&&<GanttChart project={project} onUpdate={onUpdate}/>}
      {tab==="logs"&&<WorkLog project={project} onUpdate={onUpdate} users={users} currentUser={currentUser}/>}
      {tab==="reports"&&<ReportsTabWrapper project={project}/>}
      {tab==="files"&&(
        <FileManager project={project} onUpdate={onUpdate}/>
      )}
    </div>
  );
}

// â”€ New Project Modal â”€
function NewProjectModal({onClose, onSave, priceList}) {
  const [form, setForm] = useState({
    name:"",client:"",producer:"ê¹€ì§€í˜„",budget:"",eventDate:"",
    status:"ì¤€ë¹„ì¤‘",tags:"",
  });
  const save = () => {
    if (!form.name||!form.client) { toast("í”„ë¡œì íŠ¸ëª…ê³¼ í´ë¼ì´ì–¸íŠ¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤","error"); return; }
    const budget = parseInt(form.budget)||0;
    const proj = {
      id:Date.now(), name:form.name, client:form.client, producer:form.producer,
      status:form.status, progress:0, budget:budget, cost:0,
      startDate:today, eventDate:form.eventDate||today, endDate:form.eventDate||today,
      tags:form.tags?form.tags.split(",").map(t=>t.trim()).filter(Boolean):[],
      taskOrder:{sender:"",receivedDate:today,purpose:"",venue:"",attendance:"",tasks:"",requirements:"",notes:""},
      checklist: (priceList||INIT_PRICE_LIST).map((t,i)=>({id:i+1, division:t.division||"ê¸°íš", category:t.category, item:t.item, done:false, unitPrice:t.unitPrice||0, qty:t.qty||1, days:t.days||1, note:""})),
      logs:[{id:1,date:today,author:"ì‹œìŠ¤í…œ",type:"auto",content:`í”„ë¡œì íŠ¸ "${form.name}" ìƒì„±ë¨. í´ë¼ì´ì–¸íŠ¸: ${form.client}, ë‹´ë‹¹: ${form.producer}`}],
      customItems:[],
      quoteHistory:[],
      files:[],
      dateMemos:{},
      gantt:[
        {id:1, division:"ê¸°íš", task:"ê¸°íš/ê³¼ì—…ì •ì˜", startDate:today, endDate:form.eventDate||today, color:"#6366f1", progress:0, subtasks:[]},
        {id:2, division:"ì œì‘", task:"ì œì‘/ì‹œê³µ", startDate:today, endDate:form.eventDate||today, color:"#06b6d4", progress:0, subtasks:[]},
        {id:3, division:"í…Œí¬ë‹ˆì»¬", task:"í–‰ì‚¬ ìš´ì˜", startDate:form.eventDate||today, endDate:form.eventDate||today, color:"#ec4899", progress:0, subtasks:[]},
      ],
    };
    onSave(proj);
    onClose();
    toast(`âœ… "${form.name}" í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤`,"success");
  };
  return (
    <div className="modal-overlay" onClick={e=>e.target.classList.contains("modal-overlay")&&onClose()}>
      <div className="modal-box">
        <div className="modal-title">ğŸª ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</div>
        {[
          {label:"í”„ë¡œì íŠ¸ëª… *",key:"name",placeholder:"ì˜ˆ: 2026 ì‚¼ì„±ì „ì ëŸ°ì¹­ ì´ë²¤íŠ¸"},
          {label:"í´ë¼ì´ì–¸íŠ¸ *",key:"client",placeholder:"ê³ ê°ì‚¬ëª…"},
          {label:"ë‹´ë‹¹ í”„ë¡œë“€ì„œ",key:"producer",placeholder:""},
          {label:"ê³„ì•½ ê¸ˆì•¡ (ì›)",key:"budget",placeholder:"ì˜ˆ: 50000000",type:"number"},
          {label:"í–‰ì‚¬ì¼",key:"eventDate",type:"date"},
          {label:"íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)",key:"tags",placeholder:"ì˜ˆ: ì „ì‹œ, B2B"},
        ].map(f=>(
          <div key={f.key} className="form-group">
            <label className="form-label">{f.label}</label>
            <input className="form-input" type={f.type||"text"} placeholder={f.placeholder} value={form[f.key]}
              onChange={e=>setForm({...form,[f.key]:e.target.value})}/>
          </div>
        ))}
        <div className="form-group">
          <label className="form-label">ìƒíƒœ</label>
          <select className="form-input" value={form.status} onChange={e=>setForm({...form,status:e.target.value})}>
            {["ì¤€ë¹„ì¤‘","ì§„í–‰ì¤‘","ë³´ë¥˜"].map(s=><option key={s}>{s}</option>)}
          </select>
        </div>
        <div className="modal-actions">
          <button className="btn btn-ghost" onClick={onClose}>ì·¨ì†Œ</button>
          <button className="btn btn-primary" onClick={save}>ìƒì„±í•˜ê¸°</button>
        </div>
      </div>
    </div>
  );
}

// â”€ Dashboard â”€
function Dashboard({projects, setPage, setDetail}) {
  const totalBudget = projects.reduce((s,p)=>s+p.budget,0);
  const totalCost = projects.reduce((s,p)=>s+p.cost,0);
  const avgProfit = totalBudget>0?((totalBudget-totalCost)/totalBudget*100).toFixed(1):"0.0";
  const allLogs = projects.flatMap(p=>p.logs.map(l=>({...l,projectName:p.name})))
    .sort((a,b)=>b.date.localeCompare(a.date)).slice(0,6);

  return (
    <div>
      <div style={{marginBottom:24}}>
        <h1 style={{color:"var(--txt)",fontSize:22,fontWeight:800,marginBottom:4}}>ëŒ€ì‹œë³´ë“œ</h1>
        <div style={{color:"var(--txt4)",fontSize:13}}>ì „ì²´ í”„ë¡œì íŠ¸ í˜„í™© Â· {today}</div>
      </div>
      {/* KPI */}
      <div className="grid-4" style={{marginBottom:24}}>
        <StatCard label="ì „ì²´ í”„ë¡œì íŠ¸" value={projects.length} sub={`ì§„í–‰ì¤‘ ${projects.filter(p=>p.status==="ì§„í–‰ì¤‘").length}ê±´`}/>
        <StatCard label="ì´ ê³„ì•½ê¸ˆì•¡" value={`${(totalBudget/100000000).toFixed(1)}ì–µ`} sub={totalBudget.toLocaleString()+"ì›"} accent="#a5b4fc"/>
        <StatCard label="í‰ê·  ìˆ˜ìµë¥ " value={`${avgProfit}%`} sub="ëª©í‘œ: 30%" accent="#10b981"/>
        <StatCard label="ì™„ë£Œ í”„ë¡œì íŠ¸" value={projects.filter(p=>p.status==="ì™„ë£Œ").length} sub="ì´ë²ˆ ì‹œì¦Œ" accent="#f59e0b"/>
      </div>
      {/* ì§„í–‰ì¤‘ */}
      <div style={{marginBottom:24}}>
        <div className="flex-between" style={{marginBottom:14}}>
          <span style={{color:"var(--txt2)",fontSize:13,fontWeight:700}}>ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸</span>
          <button onClick={()=>setPage("projects")} style={{background:"transparent",border:"none",color:"#6366f1",fontSize:12,cursor:"pointer"}}>ì „ì²´ ë³´ê¸° â†’</button>
        </div>
        <div className="grid-3">
          {projects.filter(p=>p.status!=="ì™„ë£Œ").map(p=>(
            <ProjectCard key={p.id} project={p} onClick={()=>{setDetail(p);setPage("detail");}}/>
          ))}
        </div>
      </div>
      {/* ìµœê·¼ ë¡œê·¸ */}
      <div>
        <div style={{color:"var(--txt2)",fontSize:13,fontWeight:700,marginBottom:14}}>ğŸ¤– ìµœê·¼ ì—…ë¬´ ìë™ ê¸°ë¡</div>
        <div style={{display:"flex",flexDirection:"column",gap:5}}>
          {allLogs.map((log,i)=>(
            <div key={i} style={{
              display:"flex",alignItems:"center",gap:12,padding:"10px 14px",
              background:"rgba(255,255,255,.02)",border:"1px solid rgba(255,255,255,.05)",borderRadius:8,
              flexWrap:"wrap",gap:8,
            }}>
              <span style={{fontSize:15}}>{log.type==="auto"?"ğŸ¤–":"ğŸ’¬"}</span>
              <span style={{color:"#6366f1",fontSize:12,fontWeight:600,minWidth:120}}>{log.projectName}</span>
              <span style={{color:"var(--txt2)",fontSize:12,flex:1,minWidth:100}}>{log.content.slice(0,60)}{log.content.length>60?"...":""}</span>
              <span style={{color:"var(--txt4)",fontSize:11,flexShrink:0}}>{log.date}</span>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// â”€ Projects Page â”€
function ProjectsPage({projects, setDetail, setPage, onAddProject, priceList}) {
  const [search, setSearch] = useState("");
  const [status, setStatus] = useState("ì „ì²´");
  const [showModal, setShowModal] = useState(false);
  const filtered = projects
    .filter(p=>status==="ì „ì²´"||p.status===status)
    .filter(p=>!search||p.name.includes(search)||p.client.includes(search)||p.producer.includes(search));
  return (
    <div>
      <div className="flex-between" style={{marginBottom:20,flexWrap:"wrap",gap:10}}>
        <div>
          <h1 style={{color:"var(--txt)",fontSize:20,fontWeight:800}}>ì „ì²´ í”„ë¡œì íŠ¸</h1>
          <div style={{color:"var(--txt4)",fontSize:13}}>ì´ {projects.length}ê±´</div>
        </div>
        <button className="btn btn-primary" onClick={()=>setShowModal(true)}>â• ìƒˆ í”„ë¡œì íŠ¸</button>
      </div>
      {/* í•„í„° */}
      <div className="flex-row" style={{marginBottom:18,flexWrap:"wrap",gap:8}}>
        <input className="form-input" placeholder="ğŸ” í”„ë¡œì íŠ¸ëª…, í´ë¼ì´ì–¸íŠ¸ ê²€ìƒ‰"
          value={search} onChange={e=>setSearch(e.target.value)} style={{flex:1,minWidth:160,maxWidth:300}}/>
        {["ì „ì²´","ì§„í–‰ì¤‘","ì¤€ë¹„ì¤‘","ì™„ë£Œ","ë³´ë¥˜"].map(s=>(
          <button key={s} onClick={()=>setStatus(s)} className="btn btn-ghost"
            style={status===s?{background:"var(--primary-dim)",borderColor:"var(--primary-border)",color:"#a5b4fc"}:{}}>
            {s}
          </button>
        ))}
      </div>
      <div className="grid-3">
        {filtered.map(p=>(
          <ProjectCard key={p.id} project={p} onClick={()=>{setDetail(p);setPage("detail");}}/>
        ))}
        {filtered.length===0&&(
          <div style={{gridColumn:"1/-1",textAlign:"center",color:"var(--txt4)",padding:40}}>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        )}
      </div>
      {showModal&&<NewProjectModal onClose={()=>setShowModal(false)} onSave={onAddProject} priceList={priceList}/>}
    </div>
  );
}

// â”€ My Work â”€
function MyWork({projects, user, users, setDetail, setPage, expenses=[], laborCosts=[], purchases=[]}) {
  const myProjects = user?.producer
    ? projects.filter(p=>p.producer===user.producer)
    : projects; // ê´€ë¦¬ìëŠ” ì „ì²´ ë³´ê¸°
  const myTasks = myProjects.flatMap(p=>
    p.checklist.filter(c=>!c.done).map(c=>({...c,projectName:p.name,projectId:p.id}))
  ).slice(0,10);

  // ë‚˜ì—ê²Œ ìœ„ì„ëœ ê³¼ì—…: ëª¨ë“  í”„ë¡œì íŠ¸ì˜ logsì—ì„œ delegation + delegateToId === user.id
  const delegatedToMe = projects.flatMap(p=>
    (p.logs||[])
      .filter(l => l.type==="delegation" && l.delegateToId === user?.id)
      .map(l => ({...l, projectName:p.name, projectId:p.id}))
  ).sort((a,b)=> b.date.localeCompare(a.date));

  // ë‚´ê°€ ìŠ¹ì¸í•´ì•¼ í•  ì§€ì¶œê²°ì˜/ì¸ê±´ë¹„
  const myPendingExpenses = expenses.filter(e=>e.approverId===user?.id && e.status==="ì‹ ì²­ì¤‘");
  const myPendingLabor = laborCosts.filter(e=>e.approverId===user?.id && e.status==="ì‹ ì²­ì¤‘");
  // ë‚´ê°€ êµ¬ë§¤í•´ì•¼ í•  êµ¬ë§¤ìš”ì²­
  const myPendingPurchases = purchases.filter(p=>p.buyerId===user?.id && p.status==="ìš”ì²­ì¤‘");
  const urgentPurchases = myPendingPurchases.filter(p=>p.deadline && p.deadline<=new Date(Date.now()+3*86400000).toISOString().slice(0,10));

  return (
    <div>
      <h1 style={{color:"var(--txt)",fontSize:20,fontWeight:800,marginBottom:4}}>ë‚´ ì—…ë¬´</h1>
      <div style={{color:"var(--txt4)",fontSize:13,marginBottom:24}}>
        {user?.producer ? `ë‹´ë‹¹ í”„ë¡œì íŠ¸ Â· ${user.name} ${user.role}` : `ì „ì²´ í”„ë¡œì íŠ¸ (ê´€ë¦¬ì ëª¨ë“œ) Â· ${user?.name}`}
      </div>

      {/* ë‚˜ì—ê²Œ ìœ„ì„ëœ ê³¼ì—… (ë°°ì§€) */}
      {delegatedToMe.length > 0 && (
        <div style={{marginBottom:28}}>
          <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:14}}>
            <span style={{color:"#fbbf24",fontSize:13,fontWeight:700}}>ğŸ“‹ ë‚˜ì—ê²Œ ìœ„ì„ëœ ê³¼ì—…</span>
            <span style={{background:"rgba(245,158,11,.2)",color:"#fbbf24",fontSize:11,fontWeight:700,padding:"2px 8px",borderRadius:10}}>{delegatedToMe.length}</span>
          </div>
          {delegatedToMe.map((log,i)=>{
            const proj = projects.find(p=>p.id===log.projectId);
            return (
              <div key={i} style={{
                display:"flex",alignItems:"flex-start",gap:12,padding:"12px 16px",
                background:"rgba(245,158,11,.05)",border:"1px solid rgba(245,158,11,.2)",
                borderLeft:"3px solid #f59e0b",borderRadius:8,marginBottom:6,
              }}>
                <span style={{fontSize:20,flexShrink:0,marginTop:2}}>ğŸ“‹</span>
                <div style={{flex:1,minWidth:0}}>
                  <div style={{color:"#fbbf24",fontWeight:700,fontSize:13,marginBottom:3}}>
                    {log.taskName}
                  </div>
                  <div style={{color:"var(--txt2)",fontSize:12,marginBottom:4,lineHeight:1.5}}>{log.content}</div>
                  <div style={{color:"var(--txt4)",fontSize:11}}>
                    {log.projectName} &nbsp;Â·&nbsp;
                    <span style={{color:"#818cf8"}}>{log.author}</span>ê°€ ìœ„ì„ &nbsp;Â·&nbsp; {log.date}
                  </div>
                </div>
                <button onClick={()=>{if(proj){setDetail(proj);setPage("detail");}}}
                  style={{background:"rgba(99,102,241,.12)",border:"1px solid rgba(99,102,241,.25)",
                    color:"#a5b4fc",borderRadius:6,padding:"5px 12px",fontSize:11,fontWeight:600,cursor:"pointer",flexShrink:0}}>
                  í”„ë¡œì íŠ¸ ë³´ê¸° â†’
                </button>
              </div>
            );
          })}
        </div>
      )}

      {/* ìŠ¹ì¸ ëŒ€ê¸°: ì§€ì¶œê²°ì˜ */}
      {myPendingExpenses.length > 0 && (
        <div style={{marginBottom:24}}>
          <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:12}}>
            <span style={{color:"#fbbf24",fontSize:13,fontWeight:700}}>ğŸ’³ ìŠ¹ì¸ ëŒ€ê¸° Â· ì§€ì¶œê²°ì˜</span>
            <span style={{background:"rgba(245,158,11,.2)",color:"#fbbf24",fontSize:11,fontWeight:700,padding:"2px 8px",borderRadius:10}}>{myPendingExpenses.length}</span>
          </div>
          {myPendingExpenses.map(e=>(
            <div key={e.id} style={{display:"flex",alignItems:"center",justifyContent:"space-between",gap:10,
              padding:"10px 14px",background:"rgba(245,158,11,.05)",border:"1px solid rgba(245,158,11,.2)",
              borderLeft:"3px solid #f59e0b",borderRadius:8,marginBottom:6,flexWrap:"wrap"}}>
              <div style={{flex:1,minWidth:0}}>
                <div style={{color:"#fbbf24",fontWeight:700,fontSize:13}}>{e.description}</div>
                <div style={{color:"var(--txt4)",fontSize:11,marginTop:2}}>
                  {e.projectName} Â· {e.category} Â· ì‹ ì²­: {e.requester} Â· {e.date}
                </div>
              </div>
              <div style={{display:"flex",alignItems:"center",gap:8,flexShrink:0}}>
                <span style={{color:"var(--txt)",fontWeight:800,fontSize:13}}>{e.amount.toLocaleString()}ì›</span>
                <button onClick={()=>setPage("expense")} style={{background:"rgba(99,102,241,.12)",border:"1px solid rgba(99,102,241,.25)",color:"#a5b4fc",borderRadius:6,padding:"4px 10px",fontSize:11,fontWeight:600,cursor:"pointer"}}>ì²˜ë¦¬í•˜ê¸° â†’</button>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* ìŠ¹ì¸ ëŒ€ê¸°: ì¸ê±´ë¹„ */}
      {myPendingLabor.length > 0 && (
        <div style={{marginBottom:24}}>
          <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:12}}>
            <span style={{color:"#a78bfa",fontSize:13,fontWeight:700}}>ğŸ‘¤ ìŠ¹ì¸ ëŒ€ê¸° Â· ì¸ê±´ë¹„</span>
            <span style={{background:"rgba(167,139,250,.2)",color:"#a78bfa",fontSize:11,fontWeight:700,padding:"2px 8px",borderRadius:10}}>{myPendingLabor.length}</span>
          </div>
          {myPendingLabor.map(e=>(
            <div key={e.id} style={{display:"flex",alignItems:"center",justifyContent:"space-between",gap:10,
              padding:"10px 14px",background:"rgba(167,139,250,.05)",border:"1px solid rgba(167,139,250,.2)",
              borderLeft:"3px solid #a78bfa",borderRadius:8,marginBottom:6,flexWrap:"wrap"}}>
              <div style={{flex:1,minWidth:0}}>
                <div style={{color:"#c4b5fd",fontWeight:700,fontSize:13}}>{e.workerName} <span style={{fontWeight:400,color:"var(--txt3)"}}>({e.role})</span></div>
                <div style={{color:"var(--txt4)",fontSize:11,marginTop:2}}>
                  {e.projectName} Â· {e.unitPrice.toLocaleString()}ì› Ã— {e.days}ì¼ Â· ì‹ ì²­: {e.requester}
                </div>
              </div>
              <div style={{display:"flex",alignItems:"center",gap:8,flexShrink:0}}>
                <span style={{color:"var(--txt)",fontWeight:800,fontSize:13}}>{e.amount.toLocaleString()}ì›</span>
                <button onClick={()=>setPage("labor")} style={{background:"rgba(99,102,241,.12)",border:"1px solid rgba(99,102,241,.25)",color:"#a5b4fc",borderRadius:6,padding:"4px 10px",fontSize:11,fontWeight:600,cursor:"pointer"}}>ì²˜ë¦¬í•˜ê¸° â†’</button>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* ë‚´ êµ¬ë§¤ ìš”ì²­ */}
      {myPendingPurchases.length > 0 && (
        <div style={{marginBottom:24}}>
          <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:12}}>
            <span style={{color:"#38bdf8",fontSize:13,fontWeight:700}}>ğŸ›’ ë‚´ê°€ êµ¬ë§¤í•´ì•¼ í•  í•­ëª©</span>
            <span style={{background:"rgba(56,189,248,.2)",color:"#38bdf8",fontSize:11,fontWeight:700,padding:"2px 8px",borderRadius:10}}>{myPendingPurchases.length}</span>
            {urgentPurchases.length>0&&<span style={{background:"rgba(239,68,68,.2)",color:"#fca5a5",fontSize:11,fontWeight:700,padding:"2px 8px",borderRadius:10}}>ğŸ”´ ê¸´ê¸‰ {urgentPurchases.length}ê±´</span>}
          </div>
          {myPendingPurchases.sort((a,b)=>a.deadline.localeCompare(b.deadline)).map(p=>{
            const ddays = p.deadline ? Math.ceil((new Date(p.deadline)-new Date(today))/(1000*60*60*24)) : null;
            const urgent2 = ddays!==null && ddays<=3;
            return (
              <div key={p.id} style={{display:"flex",alignItems:"center",justifyContent:"space-between",gap:10,
                padding:"10px 14px",
                background:urgent2?"rgba(239,68,68,.05)":"rgba(56,189,248,.04)",
                border:`1px solid ${urgent2?"rgba(239,68,68,.3)":"rgba(56,189,248,.2)"}`,
                borderLeft:`3px solid ${urgent2?"#ef4444":"#38bdf8"}`,
                borderRadius:8,marginBottom:6,flexWrap:"wrap"}}>
                <div style={{flex:1,minWidth:0}}>
                  <div style={{color:"#38bdf8",fontWeight:700,fontSize:13}}>
                    {p.item} {p.spec&&<span style={{fontWeight:400,color:"var(--txt3)",fontSize:12}}>({p.spec})</span>}
                    &nbsp;<span style={{color:"var(--txt3)",fontSize:12,fontWeight:400}}>Ã— {p.qty}ê°œ</span>
                  </div>
                  <div style={{color:ddays<=0?"#fca5a5":ddays<=3?"#fbbf24":"var(--txt4)",fontSize:11,marginTop:2,fontWeight:urgent2?700:400}}>
                    {p.projectName} Â· ë§ˆê° {p.deadline} {ddays!==null&&`(D${ddays<=0?ddays:"-"+ddays})`} Â· ìš”ì²­: {p.requester}
                  </div>
                  {p.note&&<div style={{color:"var(--txt4)",fontSize:11,marginTop:2}}>ğŸ“ {p.note}</div>}
                </div>
                <div style={{display:"flex",gap:5,flexShrink:0,alignItems:"center"}}>
                  {p.purchaseLink&&<a href={p.purchaseLink} target="_blank" rel="noopener noreferrer"
                    style={{background:"rgba(56,189,248,.1)",border:"1px solid rgba(56,189,248,.25)",color:"#38bdf8",borderRadius:6,padding:"4px 10px",fontSize:11,fontWeight:600,cursor:"pointer",textDecoration:"none"}}>
                    ğŸ”— êµ¬ë§¤ë§í¬
                  </a>}
                  <button onClick={()=>setPage("purchase")} style={{background:"rgba(56,189,248,.12)",border:"1px solid rgba(56,189,248,.25)",color:"#38bdf8",borderRadius:6,padding:"4px 10px",fontSize:11,fontWeight:600,cursor:"pointer"}}>ì²˜ë¦¬í•˜ê¸° â†’</button>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* ë‚´ í”„ë¡œì íŠ¸ */}
      <div style={{marginBottom:28}}>
        <div style={{color:"var(--txt2)",fontSize:13,fontWeight:700,marginBottom:14}}>ë‹´ë‹¹ í”„ë¡œì íŠ¸</div>
        <div className="grid-3">
          {myProjects.map(p=>(
            <ProjectCard key={p.id} project={p} onClick={()=>{setDetail(p);setPage("detail");}}/>
          ))}
          {myProjects.length===0&&<div style={{color:"var(--txt4)",gridColumn:"1/-1",padding:20}}>ë‹´ë‹¹ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>}
        </div>
      </div>

      {/* ë¯¸ì™„ë£Œ ê³¼ì—… */}
      <div>
        <div style={{color:"var(--txt2)",fontSize:13,fontWeight:700,marginBottom:14}}>âš ï¸ ë¯¸ì™„ë£Œ ê³¼ì—… (ì „ì²´ ë‹´ë‹¹ í”„ë¡œì íŠ¸)</div>
        {myTasks.map((t,i)=>(
          <div key={i} style={{
            display:"flex",alignItems:"center",gap:12,padding:"11px 14px",
            background:"rgba(255,255,255,.02)",border:"1px solid rgba(255,255,255,.05)",
            borderRadius:8,marginBottom:5,
          }}>
            <div style={{width:16,height:16,borderRadius:4,border:"1.5px solid #334155",background:"transparent"}}/>
            <span style={{flex:1,color:"var(--txt)",fontSize:13}}>{t.item}</span>
            <span style={{background:"rgba(99,102,241,.1)",color:"#818cf8",padding:"2px 8px",borderRadius:4,fontSize:11}}>{t.category}</span>
            <span style={{color:"var(--txt3)",fontSize:12}}>{t.projectName}</span>
            {(t.unitPrice||0)>0&&<span style={{color:"var(--txt4)",fontSize:11}}>{Math.round((t.unitPrice||0)*(t.qty||1)*(t.days||1)/10000).toLocaleString()}ë§Œì›</span>}
          </div>
        ))}
        {myTasks.length===0&&<div style={{color:"var(--txt4)",fontSize:13,padding:20,textAlign:"center",border:"1px dashed rgba(255,255,255,.07)",borderRadius:10}}>ğŸ‰ ëª¨ë“  ê³¼ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>}
      </div>
    </div>
  );
}

// â”€ Files Page â”€
function FilesPage({projects}) {
  const driveConnected = DRIVE_CONFIG.ENABLED;
  const totalFiles = projects.reduce((s,p)=>(s+(p.files||[]).length),0);

  // íŒŒì¼ ì´ë¦„ ì¶”ì¶œ í—¬í¼
  const getFileName = (f) => typeof f === "string" ? f : f.name;
  const getFileObj = (f) => typeof f === "string" ? { name: f, legacy: true } : f;

  const handleFileOpen = async (file) => {
    const f = getFileObj(file);
    if (f.url) { window.open(f.url, "_blank"); return; }
    if (f.driveFileId && driveConnected) {
      try {
        const res = await fetch(`${DRIVE_CONFIG.GAS_URL}?action=downloadFile&fileId=${f.driveFileId}`, {redirect:"follow"});
        const data = await res.json();
        if (data.webViewLink) window.open(data.webViewLink, "_blank");
      } catch { toast("íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤", "error"); }
    } else {
      toast("Google Drive ì—°ê²° í›„ íŒŒì¼ì„ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤", "warn");
    }
  };

  return (
    <div>
      <h1 style={{color:"var(--txt)",fontSize:20,fontWeight:800,marginBottom:4}}>íŒŒì¼ / ê³µìœ  ë“œë¼ì´ë¸Œ</h1>
      <div style={{color:"var(--txt4)",fontSize:13,marginBottom:24}}>ì „ì²´ í”„ë¡œì íŠ¸ íŒŒì¼ ê´€ë¦¬ Â· {totalFiles}ê°œ íŒŒì¼</div>
      {/* Drive ìƒíƒœ */}
      <div style={{
        background: driveConnected ? "rgba(99,102,241,.08)" : "rgba(245,158,11,.08)",
        border: `1px solid ${driveConnected ? "rgba(99,102,241,.2)" : "rgba(245,158,11,.2)"}`,
        borderRadius:12,padding:18,marginBottom:22,
        display:"flex",alignItems:"center",gap:14,flexWrap:"wrap",
      }}>
        <span style={{fontSize:28}}>â˜ï¸</span>
        <div>
          <div style={{color: driveConnected?"#a5b4fc":"#fbbf24",fontWeight:700,fontSize:14}}>
            Google Drive {driveConnected ? "ì—°ë™ í™œì„±í™”" : "ë¯¸ì—°ê²°"}
          </div>
          <div style={{color:"var(--txt4)",fontSize:12}}>
            {driveConnected ? "ëª¨ë“  í”„ë¡œì íŠ¸ íŒŒì¼ì´ ìë™ ë™ê¸°í™”ë©ë‹ˆë‹¤" : "DRIVE_CONFIG.GAS_URLì„ ì„¤ì •í•˜ì—¬ Drive ì—°ë™ì„ í™œì„±í™”í•˜ì„¸ìš”"}
          </div>
        </div>
        <div style={{marginLeft:"auto",display:"flex",alignItems:"center",gap:6}}>
          <div style={{width:8,height:8,borderRadius:"50%",background:driveConnected?"#10b981":"#f59e0b",boxShadow:`0 0 6px ${driveConnected?"#10b981":"#f59e0b"}`}}/>
          <span style={{color:driveConnected?"#10b981":"#f59e0b",fontSize:13,fontWeight:600}}>
            {driveConnected ? "ì—°ê²°ë¨" : "ë¯¸ì—°ê²°"}
          </span>
        </div>
      </div>
      {/* í”„ë¡œì íŠ¸ë³„ íŒŒì¼ */}
      {projects.map(p=>(
        <div key={p.id} className="card-sm" style={{marginBottom:10}}>
          <div className="flex-between" style={{marginBottom:10}}>
            <div style={{color:"var(--txt)",fontWeight:600,fontSize:14}}>ğŸ“ {p.name}</div>
            <span style={{color:"var(--txt4)",fontSize:12}}>{(p.files||[]).length}ê°œ íŒŒì¼</span>
          </div>
          {(p.files||[]).length>0 ? (p.files||[]).map((f,i)=>{
            const fo = getFileObj(f);
            return (
              <div key={fo.name+i} className="flex-between" style={{padding:"7px 0",borderBottom:"1px solid rgba(255,255,255,.04)"}}>
                <div style={{display:"flex",alignItems:"center",gap:6}}>
                  <span style={{color:"var(--txt2)",fontSize:13}}>ğŸ“„ {fo.name}</span>
                  {fo.size && <span style={{color:"var(--txt4)",fontSize:10}}>({fo.size>1048576?(fo.size/1048576).toFixed(1)+"MB":(fo.size/1024).toFixed(0)+"KB"})</span>}
                </div>
                <div style={{display:"flex",gap:8,alignItems:"center"}}>
                  {(fo.driveFileId||fo.url) && <span style={{color:"#10b981",fontSize:11}}>Drive âœ“</span>}
                  <button className="btn btn-ghost" style={{padding:"3px 10px",fontSize:11}}
                    onClick={()=>handleFileOpen(f)}>{fo.driveFileId||fo.url?"ì—´ê¸°":"ë‹¤ìš´ë¡œë“œ"}</button>
                </div>
              </div>
            );
          }) : <div style={{color:"var(--txt4)",fontSize:12,padding:"8px 0"}}>íŒŒì¼ ì—†ìŒ</div>}
        </div>
      ))}
    </div>
  );
}

/* â•â• ìš´ì˜ê³„íšì•ˆ / ê²°ê³¼ë³´ê³ ì„œ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function DocEditorPanel({docType, project}) {
  // docType: "plan" | "report"
  const isPlan = docType === "plan";
  const SECTIONS = [
    {id:"overview", num:"01", title:"Over View", icon:"ğŸ“Œ"},
    {id:"venue",    num:"02", title:"Venue",     icon:"ğŸ›"},
    {id:"design",   num:"03", title:"Design",    icon:"ğŸ¨"},
    {id:"program",  num:"04", title:"Program",   icon:"ğŸ“‹"},
    {id:"operation",num:"05", title:"Operation", icon:"âš™ï¸"},
    {id:"timeline", num:"06", title:"Time Line", icon:"ğŸ“…"},
  ];

  const [activeSection, setActiveSection] = React.useState("overview");

  // í”„ë¡œì íŠ¸ë³„ ë¬¸ì„œ ë°ì´í„° ì €ì¥ (í”„ë¡œì íŠ¸id+íƒ€ì… í‚¤)
  const [allDocs, setAllDocs] = React.useState({});

  const proj = project;
  const docKey = `${proj?.id}_${docType}`;
  const docData = allDocs[docKey] || {};

  const updateDoc = (sectionId, field, value) => {
    setAllDocs(prev => ({
      ...prev,
      [docKey]: {
        ...prev[docKey],
        [sectionId]: {
          ...(prev[docKey]?.[sectionId] || {}),
          [field]: value,
        }
      }
    }));
  };

  const updateDocSection = (sectionId, obj) => {
    setAllDocs(prev => ({
      ...prev,
      [docKey]: {
        ...prev[docKey],
        [sectionId]: { ...(prev[docKey]?.[sectionId] || {}), ...obj }
      }
    }));
  };

  // í˜„ì¬ ì„¹ì…˜ ë°ì´í„°
  const sd = (sectionId) => docData[sectionId] || {};

  // ë™ì  ë¦¬ìŠ¤íŠ¸ í—¬í¼
  const getList = (sectionId, field, defaultItem) => {
    const val = sd(sectionId)[field];
    return val && val.length ? val : [defaultItem];
  };
  const setList = (sectionId, field, newList) => updateDoc(sectionId, field, newList);
  const addListItem = (sectionId, field, defaultItem) => {
    const cur = sd(sectionId)[field] || [];
    setList(sectionId, field, [...cur, {...defaultItem, _id: Date.now()}]);
  };
  const removeListItem = (sectionId, field, idx) => {
    const cur = sd(sectionId)[field] || [];
    setList(sectionId, field, cur.filter((_,i)=>i!==idx));
  };
  const updateListItem = (sectionId, field, idx, key, val) => {
    const cur = (sd(sectionId)[field] || []).map((item,i) => i===idx ? {...item, [key]:val} : item);
    setList(sectionId, field, cur);
  };

  // PDF ì¶œë ¥
  const printPDF = () => {
    const W = window.open("","_blank","width=1200,height=900");
    const p = proj || {};
    const ov = sd("overview");
    const ve = sd("venue");
    const de = sd("design");
    const pr = sd("program");
    const op = sd("operation");
    const tl = sd("timeline");

    const bannerRows = (de.bannerList||[]).map((b,i)=>`
      <tr><td>${i+1}</td><td>${b.name||""}</td><td>${b.size||""}</td><td style="text-align:center">${b.qty||""}</td></tr>`).join("") || `<tr><td colspan="4" style="text-align:center;color:#888">ë°ì´í„° ì—†ìŒ</td></tr>`;

    const programRows = (pr.timeline||[]).map((t,i)=>`
      <tr><td style="text-align:center">${i+1}</td><td style="white-space:nowrap">${t.time||""}</td><td style="text-align:center">${t.duration||""}</td><td>${t.content||""}</td><td>${t.note||""}</td></tr>`).join("") || `<tr><td colspan="5" style="text-align:center;color:#888">ë°ì´í„° ì—†ìŒ</td></tr>`;

    const staffRows = (op.staffList||[]).map((s,i)=>`
      <tr><td style="text-align:center">${i+1}</td><td>${s.role||""}</td><td>${s.name||""}</td><td>${s.contact||""}</td><td>${s.note||""}</td></tr>`).join("") || `<tr><td colspan="5" style="text-align:center;color:#888">ë°ì´í„° ì—†ìŒ</td></tr>`;

    const prizeRows = (op.prizeList||[]).map((s,i)=>`
      <tr><td style="text-align:center">${i+1}</td><td>${s.grade||""}</td><td>${s.item||""}</td><td style="text-align:center">${s.qty||""}</td><td>${s.note||""}</td></tr>`).join("") || `<tr><td colspan="5" style="text-align:center;color:#888">ë°ì´í„° ì—†ìŒ</td></tr>`;

    const milestoneRows = (tl.milestones||[]).map((m,i)=>{
      const sc = m.status==="ì™„ë£Œ"?"#10b981":m.status==="ì§„í–‰ì¤‘"?"#f59e0b":"#6366f1";
      const rowStyle = m.isSubtask ? "background:#f8fafc;" : "";
      const taskStyle = m.isSubtask ? "padding-left:20px;color:#64748b;" : "font-weight:600;";
      const progPct = m.progress||0;
      return `<tr style="${rowStyle}">
        <td style="text-align:center;width:24px">${i+1}</td>
        <td style="width:60px;font-size:11px;color:#64748b">${m.division||""}</td>
        <td style="${taskStyle}">${m.task||""}</td>
        <td style="white-space:nowrap;font-size:11px">${m.startDate||""}</td>
        <td style="white-space:nowrap;font-size:11px">${m.endDate||""}</td>
        <td style="width:80px">
          <div style="display:flex;align-items:center;gap:4px">
            <div style="flex:1;height:5px;background:#e2e8f0;border-radius:99px;overflow:hidden">
              <div style="width:${progPct}%;height:100%;background:${sc};border-radius:99px"></div>
            </div>
            <span style="font-size:10px;color:${sc};font-weight:700;min-width:24px">${progPct}%</span>
          </div>
        </td>
        <td style="text-align:center;width:60px">
          <span style="background:${sc}22;color:${sc};border:1px solid ${sc}44;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:700">${m.status||"ì˜ˆì •"}</span>
        </td>
      </tr>`;
    }).join("") || `<tr><td colspan="7" style="text-align:center;color:#888;padding:16px">íƒ€ì„ë¼ì¸ ë°ì´í„° ì—†ìŒ</td></tr>`;

    const docTitle = isPlan ? "ìš´ì˜ê³„íšì•ˆ" : "ê²°ê³¼ë³´ê³ ì„œ";
    const html = `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"/>
<title>${p.name||"í–‰ì‚¬"} ${docTitle}</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;900&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Noto Sans KR',sans-serif;background:#fff;color:#1e293b;font-size:13px}
.page{width:297mm;min-height:210mm;padding:0;margin:0 auto;page-break-after:always;position:relative;overflow:hidden}
.page:last-child{page-break-after:auto}
/* Cover */
.cover{background:linear-gradient(135deg,#0f1623 0%,#1e2a4a 50%,#0f1623 100%);color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:210mm;text-align:center;padding:40px}
.cover .year{font-size:14px;color:#818cf8;letter-spacing:4px;font-weight:600;margin-bottom:16px}
.cover .event-name{font-size:36px;font-weight:900;color:#fff;margin-bottom:12px;line-height:1.2}
.cover .doc-type{font-size:18px;color:#a5b4fc;font-weight:700;margin-bottom:32px;letter-spacing:2px}
.cover .company{font-size:13px;color:#64748b;letter-spacing:1px}
/* Section page */
.sec-page{background:#fff;padding:0}
.sec-header{background:linear-gradient(135deg,#0f1623,#1e3a5f);color:#fff;padding:24px 40px;display:flex;align-items:center;gap:16px}
.sec-num{font-size:48px;font-weight:900;color:#6366f1;opacity:.5;line-height:1;min-width:60px}
.sec-title-block{display:flex;flex-direction:column}
.sec-title{font-size:24px;font-weight:900;color:#fff;letter-spacing:2px}
.sec-sub{font-size:11px;color:#818cf8;letter-spacing:1px;margin-top:2px}
.sec-body{padding:28px 40px}
/* ê³µí†µ í…Œì´ë¸” */
table{width:100%;border-collapse:collapse;margin-bottom:16px}
th{background:#0f1623;color:#a5b4fc;font-size:11px;font-weight:700;padding:8px 10px;text-align:left;border:1px solid #1e3a5f}
td{border:1px solid #e2e8f0;padding:7px 10px;font-size:12px;vertical-align:top}
tr:nth-child(even) td{background:#f8fafc}
/* Info grid */
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.info-box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:14px}
.info-label{font-size:10px;font-weight:700;color:#6366f1;letter-spacing:1px;margin-bottom:5px;text-transform:uppercase}
.info-value{font-size:13px;color:#1e293b;font-weight:600;white-space:pre-wrap;line-height:1.5}
/* 2ì»¬ëŸ¼ ë°•ìŠ¤ */
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:14px;margin-bottom:12px}
.box-title{font-size:11px;font-weight:800;color:#475569;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
.box-val{font-size:13px;color:#1e293b;white-space:pre-wrap;line-height:1.6}
/* Footer */
.footer{position:absolute;bottom:16px;right:32px;font-size:10px;color:#94a3b8}
.pill{display:inline-block}
/* Photo placeholder */
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
.photo-box{background:#f1f5f9;border:2px dashed #cbd5e1;border-radius:8px;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:11px}
@media print{
  .page{width:297mm;margin:0;page-break-after:always}
  .page:last-child{page-break-after:auto}
  body{-webkit-print-color-adjust:exact;print-color-adjust:exact}
}
</style></head><body>

<!-- COVER -->
<div class="page cover">
  <div class="year">${new Date().getFullYear()} CRS in the Community</div>
  <div class="event-name">${p.name||"í–‰ì‚¬ëª…"}</div>
  <div class="doc-type">${docTitle}</div>
  <div class="company">(ì£¼)ì—í”½ìŠ¤í…Œì´ì§€</div>
</div>

<!-- 01 OVER VIEW -->
<div class="page sec-page">
  <div class="sec-header">
    <div class="sec-num">01</div>
    <div class="sec-title-block">
      <div class="sec-title">Over View</div>
      <div class="sec-sub">í–‰ì‚¬ ê°œìš” | EVENT OVERVIEW</div>
    </div>
  </div>
  <div class="sec-body">
    <div class="info-grid">
      <div class="info-box"><div class="info-label">í–‰ì‚¬ëª…</div><div class="info-value">${ov.eventName||p.name||""}</div></div>
      <div class="info-box"><div class="info-label">ì£¼ìµœ</div><div class="info-value">${ov.organizer||p.client||""}</div></div>
      <div class="info-box"><div class="info-label">ì¼ì‹œ</div><div class="info-value">${ov.date||p.eventDate||""} ${ov.time||""}</div></div>
      <div class="info-box"><div class="info-label">ì¥ì†Œ</div><div class="info-value">${ov.venue||p.brief?.venue||""}</div></div>
    </div>
    <div class="box"><div class="box-title">í–‰ì‚¬ ë‚´ìš©</div><div class="box-val">${ov.content||p.brief?.purpose||""}</div></div>
    <div class="two-col">
      <div class="box"><div class="box-title">í–‰ì‚¬ ì„±ê²©</div><div class="box-val">${ov.character||""}</div></div>
      <div class="box"><div class="box-title">ì§€ì› ì‚¬í•­</div><div class="box-val">${ov.support||""}</div></div>
    </div>
    ${ov.extraNotes ? `<div class="box"><div class="box-title">ê¸°íƒ€ì‚¬í•­</div><div class="box-val">${ov.extraNotes}</div></div>` : ""}
  </div>
  <div class="footer">${p.name||""} ${docTitle} Â· (ì£¼)ì—í”½ìŠ¤í…Œì´ì§€</div>
</div>

<!-- 02 VENUE -->
<div class="page sec-page">
  <div class="sec-header">
    <div class="sec-num">02</div>
    <div class="sec-title-block">
      <div class="sec-title">Venue</div>
      <div class="sec-sub">ì¥ì†Œ ì•ˆë‚´ | VENUE INFORMATION</div>
    </div>
  </div>
  <div class="sec-body">
    <div class="info-grid">
      <div class="info-box"><div class="info-label">ì¥ì†Œëª…</div><div class="info-value">${ve.venueName||p.brief?.venue||""}</div></div>
      <div class="info-box"><div class="info-label">ìˆ˜ìš© ì¸ì›</div><div class="info-value">${ve.capacity||""}</div></div>
      <div class="info-box"><div class="info-label">ì£¼ì†Œ</div><div class="info-value">${ve.address||""}</div></div>
      <div class="info-box"><div class="info-label">ì¸µ/í™€</div><div class="info-value">${ve.floor||""}</div></div>
    </div>
    <div class="box"><div class="box-title">ì¥ì†Œ íŠ¹ì´ì‚¬í•­</div><div class="box-val">${ve.notes||""}</div></div>
    <table>
      <thead><tr><th>#</th><th>ì¥ë¹„ëª…</th><th>ê·œê²©</th><th>ìˆ˜ëŸ‰</th><th>ë¹„ê³ </th></tr></thead>
      <tbody>
        ${(ve.equipList||[]).map((e,i)=>`<tr><td>${i+1}</td><td>${e.name||""}</td><td>${e.spec||""}</td><td style="text-align:center">${e.qty||""}</td><td>${e.note||""}</td></tr>`).join("")||`<tr><td colspan="5" style="text-align:center;color:#888">ì¥ë¹„ ëª©ë¡ ì—†ìŒ</td></tr>`}
      </tbody>
    </table>
  </div>
  <div class="footer">${p.name||""} ${docTitle} Â· (ì£¼)ì—í”½ìŠ¤í…Œì´ì§€</div>
</div>

<!-- 03 DESIGN -->
<div class="page sec-page">
  <div class="sec-header">
    <div class="sec-num">03</div>
    <div class="sec-title-block">
      <div class="sec-title">Design</div>
      <div class="sec-sub">ë””ìì¸ ê³„íš | DESIGN PLAN</div>
    </div>
  </div>
  <div class="sec-body">
    <div class="box-title" style="margin-bottom:8px">í˜„ìˆ˜ë§‰/ë°°ë„ˆ ëª©ë¡</div>
    <table>
      <thead><tr><th>#</th><th>í’ˆëª©ëª…</th><th>ê·œê²© (mm)</th><th style="text-align:center">ìˆ˜ëŸ‰</th></tr></thead>
      <tbody>${bannerRows}</tbody>
    </table>
    <div class="two-col">
      <div class="box"><div class="box-title">ë””ì§€í„¸/ì˜ìƒ ê³„íš</div><div class="box-val">${de.videoNotes||""}</div></div>
      <div class="box"><div class="box-title">ì¸ì‡„ë¬¼</div><div class="box-val">${de.printNotes||""}</div></div>
    </div>
    <div class="box"><div class="box-title">LED/ìŠ¤í¬ë¦° ê³„íš</div><div class="box-val">${de.ledNotes||""}</div></div>
    ${isPlan ? "" : `<div class="box-title" style="margin-top:8px;margin-bottom:8px">í˜„ì¥ ì‚¬ì§„</div><div class="photo-grid">${[1,2,3,4,5,6].map(()=>`<div class="photo-box">ì‚¬ì§„ ì²¨ë¶€</div>`).join("")}</div>`}
  </div>
  <div class="footer">${p.name||""} ${docTitle} Â· (ì£¼)ì—í”½ìŠ¤í…Œì´ì§€</div>
</div>

<!-- 04 PROGRAM -->
<div class="page sec-page">
  <div class="sec-header">
    <div class="sec-num">04</div>
    <div class="sec-title-block">
      <div class="sec-title">Program</div>
      <div class="sec-sub">ì§„í–‰ ìˆœì„œ | EVENT PROGRAM</div>
    </div>
  </div>
  <div class="sec-body">
    <table>
      <thead><tr><th>#</th><th>ì‹œê°„</th><th>ì†Œìš”</th><th>ë‚´ìš©</th><th>ë¹„ê³ </th></tr></thead>
      <tbody>${programRows}</tbody>
    </table>
    ${pr.mcInfo ? `<div class="box"><div class="box-title">MC ì§„í–‰ ë©”ëª¨</div><div class="box-val">${pr.mcInfo}</div></div>` : ""}
    ${isPlan ? "" : `<div class="box"><div class="box-title">í”„ë¡œê·¸ë¨ ê²°ê³¼ ë©”ëª¨</div><div class="box-val">${pr.resultNotes||""}</div></div>`}
  </div>
  <div class="footer">${p.name||""} ${docTitle} Â· (ì£¼)ì—í”½ìŠ¤í…Œì´ì§€</div>
</div>

<!-- 05 OPERATION -->
<div class="page sec-page">
  <div class="sec-header">
    <div class="sec-num">05</div>
    <div class="sec-title-block">
      <div class="sec-title">Operation</div>
      <div class="sec-sub">ìš´ì˜ ê³„íš | OPERATION PLAN</div>
    </div>
  </div>
  <div class="sec-body">
    <div class="two-col">
      <div class="box"><div class="box-title">MC</div><div class="box-val"><strong>${op.mcName||""}</strong><br/>${op.mcProfile||""}</div></div>
      <div class="box"><div class="box-title">ìš´ì˜ íŠ¹ì´ì‚¬í•­</div><div class="box-val">${op.notes||""}</div></div>
    </div>
    <div class="box-title" style="margin-bottom:8px">ìŠ¤íƒœí”„ ë°°ì¹˜</div>
    <table>
      <thead><tr><th>#</th><th>ì—­í• </th><th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>ë¹„ê³ </th></tr></thead>
      <tbody>${staffRows}</tbody>
    </table>
    <div class="box-title" style="margin-bottom:8px">ê²½í’ˆ ëª©ë¡</div>
    <table>
      <thead><tr><th>#</th><th>ë“±ê¸‰</th><th>í’ˆëª©</th><th style="text-align:center">ìˆ˜ëŸ‰</th><th>ë¹„ê³ </th></tr></thead>
      <tbody>${prizeRows}</tbody>
    </table>
  </div>
  <div class="footer">${p.name||""} ${docTitle} Â· (ì£¼)ì—í”½ìŠ¤í…Œì´ì§€</div>
</div>

<!-- 06 TIME LINE -->
<div class="page sec-page">
  <div class="sec-header">
    <div class="sec-num">06</div>
    <div class="sec-title-block">
      <div class="sec-title">Time Line</div>
      <div class="sec-sub">ì¼ì • ê³„íš | PROJECT TIMELINE</div>
    </div>
  </div>
  <div class="sec-body">
    <table>
      <thead><tr><th>#</th><th>êµ¬ë¶„</th><th>ì—…ë¬´</th><th>ì‹œì‘ì¼</th><th>ì¢…ë£Œì¼</th><th>ì§„í–‰ë¥ </th><th>ìƒíƒœ</th></tr></thead>
      <tbody>${milestoneRows}</tbody>
    </table>
    ${tl.ganttNotes ? `<div class="box"><div class="box-title">ì¼ì • ë©”ëª¨</div><div class="box-val">${tl.ganttNotes}</div></div>` : ""}
  </div>
  <div class="footer">${p.name||""} ${docTitle} Â· (ì£¼)ì—í”½ìŠ¤í…Œì´ì§€</div>
</div>

</body></html>`;
    W.document.write(html);
    W.document.close();
    setTimeout(()=>W.print(), 600);
    toast("PDF ì¶œë ¥ ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.", "success");
  };

  // â”€â”€ ì„¹ì…˜ë³„ í¸ì§‘ UI â”€â”€
  const renderSection = () => {
    const ov = sd("overview");
    const ve = sd("venue");
    const de = sd("design");
    const pr = sd("program");
    const op = sd("operation");
    const tl = sd("timeline");

    const FG = ({label, children}) => (
      <div className="form-group">
        <label className="form-label">{label}</label>
        {children}
      </div>
    );

    if (activeSection === "overview") return (
      <div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
          <FG label="í–‰ì‚¬ëª…"><input className="form-input" value={ov.eventName||proj?.name||""} onChange={e=>updateDoc("overview","eventName",e.target.value)} placeholder="í–‰ì‚¬ëª… ì…ë ¥"/></FG>
          <FG label="ì£¼ìµœì‚¬"><input className="form-input" value={ov.organizer||proj?.client||""} onChange={e=>updateDoc("overview","organizer",e.target.value)} placeholder="ì£¼ìµœì‚¬/í´ë¼ì´ì–¸íŠ¸"/></FG>
          <FG label="ì¼ì‹œ"><input className="form-input" value={ov.date||proj?.eventDate||""} onChange={e=>updateDoc("overview","date",e.target.value)} placeholder="ì˜ˆ) 2025ë…„ 11ì›” 25ì¼(í™”)"/></FG>
          <FG label="ì‹œê°„"><input className="form-input" value={ov.time||""} onChange={e=>updateDoc("overview","time",e.target.value)} placeholder="ì˜ˆ) ì˜¤ì „ 10:30 ~ ì˜¤í›„ 1:30 (3ì‹œê°„)"/></FG>
        </div>
        <FG label="ì¥ì†Œ"><input className="form-input" value={ov.venue||proj?.brief?.venue||""} onChange={e=>updateDoc("overview","venue",e.target.value)} placeholder="í–‰ì‚¬ ì¥ì†Œëª…"/></FG>
        <FG label="í–‰ì‚¬ ë‚´ìš©">
          <textarea className="form-input" rows={3} value={ov.content||proj?.brief?.purpose||""} onChange={e=>updateDoc("overview","content",e.target.value)} placeholder="í–‰ì‚¬ì˜ ì£¼ìš” ë‚´ìš© ë° ëª©ì " style={{resize:"vertical"}}/>
        </FG>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
          <FG label="í–‰ì‚¬ ì„±ê²©">
            <textarea className="form-input" rows={4} value={ov.character||""} onChange={e=>updateDoc("overview","character",e.target.value)} placeholder="ì˜ˆ) ì§€ì—­ì‚¬íšŒê³µí—Œì¸ì •ì œ ì‹œìƒì‹&#10;- ì‹œìƒì‹&#10;- ë„¤íŠ¸ì›Œí‚¹&#10;- ì „ì‹œ" style={{resize:"vertical"}}/>
          </FG>
          <FG label="ì§€ì› ì‚¬í•­">
            <textarea className="form-input" rows={4} value={ov.support||""} onChange={e=>updateDoc("overview","support",e.target.value)} placeholder="ì˜ˆ) ë¬´ëŒ€/ìŒí–¥/ì¡°ëª…/LED&#10;ì‚¬íšŒì&#10;ì˜ìƒ ì œì‘&#10;ì¸ì‡„ë¬¼" style={{resize:"vertical"}}/>
          </FG>
        </div>
        <FG label="ê¸°íƒ€ì‚¬í•­">
          <textarea className="form-input" rows={2} value={ov.extraNotes||""} onChange={e=>updateDoc("overview","extraNotes",e.target.value)} placeholder="ê¸°íƒ€ íŠ¹ì´ì‚¬í•­" style={{resize:"vertical"}}/>
        </FG>
      </div>
    );

    if (activeSection === "venue") {
      const eqList = getList("venue","equipList",{name:"",spec:"",qty:"",note:""});
      return (
        <div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
            <FG label="ì¥ì†Œëª…"><input className="form-input" value={ve.venueName||proj?.brief?.venue||""} onChange={e=>updateDoc("venue","venueName",e.target.value)} placeholder="ì¥ì†Œëª…"/></FG>
            <FG label="ìˆ˜ìš© ì¸ì›"><input className="form-input" value={ve.capacity||proj?.brief?.attendance||""} onChange={e=>updateDoc("venue","capacity",e.target.value)} placeholder="ì˜ˆ) 300ëª…"/></FG>
            <FG label="ì£¼ì†Œ"><input className="form-input" value={ve.address||""} onChange={e=>updateDoc("venue","address",e.target.value)} placeholder="ë„ë¡œëª… ì£¼ì†Œ"/></FG>
            <FG label="ì¸µ/í™€"><input className="form-input" value={ve.floor||""} onChange={e=>updateDoc("venue","floor",e.target.value)} placeholder="ì˜ˆ) B1ì¸µ ê·¸ëœë“œë³¼ë£¸"/></FG>
          </div>
          <FG label="ì¥ì†Œ íŠ¹ì´ì‚¬í•­">
            <textarea className="form-input" rows={2} value={ve.notes||""} onChange={e=>updateDoc("venue","notes",e.target.value)} placeholder="ë°˜ì… ë™ì„ , ì£¼ì°¨, íŠ¹ì´ì‚¬í•­ ë“±" style={{resize:"vertical"}}/>
          </FG>
          <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}>
            <label className="form-label" style={{margin:0}}>ì¥ë¹„/ì‹œì„¤ ëª©ë¡</label>
            <button className="btn btn-ghost" style={{padding:"4px 10px",fontSize:12}} onClick={()=>addListItem("venue","equipList",{name:"",spec:"",qty:"",note:""})}>+ í•­ëª© ì¶”ê°€</button>
          </div>
          <div style={{overflowX:"auto"}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}>
              <thead><tr style={{background:"rgba(99,102,241,.1)"}}>
                <th style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)",width:30}}>#</th>
                <th style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)"}}>ì¥ë¹„ëª…</th>
                <th style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)"}}>ê·œê²©</th>
                <th style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)",width:60}}>ìˆ˜ëŸ‰</th>
                <th style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)"}}>ë¹„ê³ </th>
                <th style={{width:36,border:"1px solid rgba(255,255,255,.07)"}}></th>
              </tr></thead>
              <tbody>
                {eqList.map((item,idx)=>(
                  <tr key={idx}>
                    <td style={{padding:"4px 8px",border:"1px solid rgba(255,255,255,.05)",textAlign:"center",color:"var(--txt3)",fontSize:11}}>{idx+1}</td>
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.name||""} onChange={e=>updateListItem("venue","equipList",idx,"name",e.target.value)} style={{padding:"4px 8px",fontSize:12}} placeholder="ì¥ë¹„ëª…"/></td>
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.spec||""} onChange={e=>updateListItem("venue","equipList",idx,"spec",e.target.value)} style={{padding:"4px 8px",fontSize:12}} placeholder="ê·œê²©"/></td>
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.qty||""} onChange={e=>updateListItem("venue","equipList",idx,"qty",e.target.value)} style={{padding:"4px 8px",fontSize:12,textAlign:"center"}} placeholder="0"/></td>
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.note||""} onChange={e=>updateListItem("venue","equipList",idx,"note",e.target.value)} style={{padding:"4px 8px",fontSize:12}} placeholder="ë¹„ê³ "/></td>
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)",textAlign:"center"}}><button onClick={()=>removeListItem("venue","equipList",idx)} style={{background:"rgba(239,68,68,.15)",border:"none",color:"#fca5a5",borderRadius:4,padding:"3px 7px",cursor:"pointer",fontSize:11}}>âœ•</button></td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    if (activeSection === "design") {
      const bnList = getList("design","bannerList",{name:"",size:"",qty:""});
      return (
        <div>
          <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}>
            <label className="form-label" style={{margin:0}}>í˜„ìˆ˜ë§‰/ë°°ë„ˆ ëª©ë¡</label>
            <button className="btn btn-ghost" style={{padding:"4px 10px",fontSize:12}} onClick={()=>addListItem("design","bannerList",{name:"",size:"",qty:""})}>+ í•­ëª© ì¶”ê°€</button>
          </div>
          <div style={{overflowX:"auto",marginBottom:16}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}>
              <thead><tr style={{background:"rgba(99,102,241,.1)"}}>
                <th style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)",width:30}}>#</th>
                <th style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)"}}>í’ˆëª©ëª…</th>
                <th style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)"}}>ê·œê²© (mm)</th>
                <th style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)",width:60}}>ìˆ˜ëŸ‰</th>
                <th style={{width:36,border:"1px solid rgba(255,255,255,.07)"}}></th>
              </tr></thead>
              <tbody>
                {bnList.map((item,idx)=>(
                  <tr key={idx}>
                    <td style={{padding:"4px 8px",border:"1px solid rgba(255,255,255,.05)",textAlign:"center",color:"var(--txt3)",fontSize:11}}>{idx+1}</td>
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.name||""} onChange={e=>updateListItem("design","bannerList",idx,"name",e.target.value)} style={{padding:"4px 8px",fontSize:12}} placeholder="í˜„ìˆ˜ë§‰ëª…/ìš©ë„"/></td>
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.size||""} onChange={e=>updateListItem("design","bannerList",idx,"size",e.target.value)} style={{padding:"4px 8px",fontSize:12}} placeholder="ì˜ˆ) 3000*2000"/></td>
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.qty||""} onChange={e=>updateListItem("design","bannerList",idx,"qty",e.target.value)} style={{padding:"4px 8px",fontSize:12,textAlign:"center"}} placeholder="0"/></td>
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)",textAlign:"center"}}><button onClick={()=>removeListItem("design","bannerList",idx)} style={{background:"rgba(239,68,68,.15)",border:"none",color:"#fca5a5",borderRadius:4,padding:"3px 7px",cursor:"pointer",fontSize:11}}>âœ•</button></td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
            <FG label="ë””ì§€í„¸/ì˜ìƒ ê³„íš">
              <textarea className="form-input" rows={4} value={de.videoNotes||""} onChange={e=>updateDoc("design","videoNotes",e.target.value)} placeholder="ì˜ˆ) DIDID(7ëŒ€), ì˜ìƒ ê³„íš&#10;- ì˜¤í”„ë‹ ì˜ìƒ (1ë¶„ 30ì´ˆ)&#10;- ì‹œìƒ ì˜ìƒ (ê° 30ì´ˆ)" style={{resize:"vertical"}}/>
            </FG>
            <FG label="ì¸ì‡„ë¬¼">
              <textarea className="form-input" rows={4} value={de.printNotes||""} onChange={e=>updateDoc("design","printNotes",e.target.value)} placeholder="ì˜ˆ) íŒ¸í”Œë¦¿ A3&#10;ì¢Œì„ ì•ˆë‚´íŒ&#10;ëª…íŒ¨ ë“±" style={{resize:"vertical"}}/>
            </FG>
          </div>
          <FG label="LED/ìŠ¤í¬ë¦° ê³„íš">
            <textarea className="form-input" rows={3} value={de.ledNotes||""} onChange={e=>updateDoc("design","ledNotes",e.target.value)} placeholder="ì˜ˆ) LED ìŠ¤í¬ë¦° 4853x960 / ë©”ì¸ í”„ë¡œì í„° 12,000 DLP" style={{resize:"vertical"}}/>
          </FG>
          {!isPlan && (
            <FG label="ê²°ê³¼ ë©”ëª¨">
              <textarea className="form-input" rows={2} value={de.resultNotes||""} onChange={e=>updateDoc("design","resultNotes",e.target.value)} placeholder="ë””ìì¸ ì‹¤ì œ ì ìš© ê²°ê³¼ ë©”ëª¨" style={{resize:"vertical"}}/>
            </FG>
          )}
        </div>
      );
    }

    if (activeSection === "program") {
      const pgList = getList("program","timeline",{time:"",duration:"",content:"",note:""});
      return (
        <div>
          <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}>
            <label className="form-label" style={{margin:0}}>íƒ€ì„í…Œì´ë¸” / ì§„í–‰ìˆœì„œ</label>
            <button className="btn btn-ghost" style={{padding:"4px 10px",fontSize:12}} onClick={()=>addListItem("program","timeline",{time:"",duration:"",content:"",note:""})}>+ í•­ëª© ì¶”ê°€</button>
          </div>
          <div style={{overflowX:"auto",marginBottom:16}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}>
              <thead><tr style={{background:"rgba(99,102,241,.1)"}}>
                <th style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)",width:30}}>#</th>
                <th style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)",width:120}}>ì‹œê°„</th>
                <th style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)",width:60}}>ì†Œìš”(ë¶„)</th>
                <th style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)"}}>ë‚´ìš©</th>
                <th style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)"}}>ë¹„ê³ </th>
                <th style={{width:36,border:"1px solid rgba(255,255,255,.07)"}}></th>
              </tr></thead>
              <tbody>
                {pgList.map((item,idx)=>(
                  <tr key={idx}>
                    <td style={{padding:"4px 8px",border:"1px solid rgba(255,255,255,.05)",textAlign:"center",color:"var(--txt3)",fontSize:11}}>{idx+1}</td>
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.time||""} onChange={e=>updateListItem("program","timeline",idx,"time",e.target.value)} style={{padding:"4px 8px",fontSize:12}} placeholder="10:30~10:35"/></td>
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.duration||""} onChange={e=>updateListItem("program","timeline",idx,"duration",e.target.value)} style={{padding:"4px 8px",fontSize:12,textAlign:"center"}} placeholder="5"/></td>
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.content||""} onChange={e=>updateListItem("program","timeline",idx,"content",e.target.value)} style={{padding:"4px 8px",fontSize:12}} placeholder="ìˆœì„œ ë‚´ìš©"/></td>
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.note||""} onChange={e=>updateListItem("program","timeline",idx,"note",e.target.value)} style={{padding:"4px 8px",fontSize:12}} placeholder="ë¹„ê³ "/></td>
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)",textAlign:"center"}}><button onClick={()=>removeListItem("program","timeline",idx)} style={{background:"rgba(239,68,68,.15)",border:"none",color:"#fca5a5",borderRadius:4,padding:"3px 7px",cursor:"pointer",fontSize:11}}>âœ•</button></td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <FG label="MC / ì§„í–‰ ë©”ëª¨">
            <textarea className="form-input" rows={2} value={pr.mcInfo||""} onChange={e=>updateDoc("program","mcInfo",e.target.value)} placeholder="MC ì§„í–‰ ê´€ë ¨ íŠ¹ì´ì‚¬í•­" style={{resize:"vertical"}}/>
          </FG>
          {!isPlan && (
            <FG label="í”„ë¡œê·¸ë¨ ê²°ê³¼ ë©”ëª¨">
              <textarea className="form-input" rows={2} value={pr.resultNotes||""} onChange={e=>updateDoc("program","resultNotes",e.target.value)} placeholder="ì‹¤ì œ ì§„í–‰ ê²°ê³¼ ë©”ëª¨" style={{resize:"vertical"}}/>
            </FG>
          )}
        </div>
      );
    }

    if (activeSection === "operation") {
      const sfList = getList("operation","staffList",{role:"",name:"",contact:"",note:""});
      const prList = getList("operation","prizeList",{grade:"",item:"",qty:"",note:""});
      return (
        <div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:4}}>
            <FG label="MC ì´ë¦„"><input className="form-input" value={op.mcName||""} onChange={e=>updateDoc("operation","mcName",e.target.value)} placeholder="MC ì´ë¦„"/></FG>
            <FG label="MC í”„ë¡œí•„">
              <textarea className="form-input" rows={2} value={op.mcProfile||""} onChange={e=>updateDoc("operation","mcProfile",e.target.value)} placeholder="ë°©ì†¡ ê²½ë ¥ ë“±" style={{resize:"vertical"}}/>
            </FG>
          </div>
          <FG label="ìš´ì˜ íŠ¹ì´ì‚¬í•­">
            <textarea className="form-input" rows={2} value={op.notes||""} onChange={e=>updateDoc("operation","notes",e.target.value)} placeholder="ìš´ì˜ ê´€ë ¨ íŠ¹ì´ì‚¬í•­" style={{resize:"vertical"}}/>
          </FG>
          <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}>
            <label className="form-label" style={{margin:0}}>ìŠ¤íƒœí”„ ë°°ì¹˜</label>
            <button className="btn btn-ghost" style={{padding:"4px 10px",fontSize:12}} onClick={()=>addListItem("operation","staffList",{role:"",name:"",contact:"",note:""})}>+ ì¶”ê°€</button>
          </div>
          <div style={{overflowX:"auto",marginBottom:16}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}>
              <thead><tr style={{background:"rgba(99,102,241,.1)"}}>
                {["#","ì—­í• ","ì´ë¦„","ì—°ë½ì²˜","ë¹„ê³ ",""].map((h,i)=><th key={i} style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)",width:i===0?30:i===5?36:undefined}}>{h}</th>)}
              </tr></thead>
              <tbody>
                {sfList.map((item,idx)=>(
                  <tr key={idx}>
                    <td style={{padding:"4px 8px",border:"1px solid rgba(255,255,255,.05)",textAlign:"center",color:"var(--txt3)",fontSize:11}}>{idx+1}</td>
                    {["role","name","contact","note"].map(f=>(
                      <td key={f} style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item[f]||""} onChange={e=>updateListItem("operation","staffList",idx,f,e.target.value)} style={{padding:"4px 8px",fontSize:12}} placeholder={{role:"ì—­í• ",name:"ì´ë¦„",contact:"ì—°ë½ì²˜",note:"ë¹„ê³ "}[f]}/></td>
                    ))}
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)",textAlign:"center"}}><button onClick={()=>removeListItem("operation","staffList",idx)} style={{background:"rgba(239,68,68,.15)",border:"none",color:"#fca5a5",borderRadius:4,padding:"3px 7px",cursor:"pointer",fontSize:11}}>âœ•</button></td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}>
            <label className="form-label" style={{margin:0}}>ê²½í’ˆ ëª©ë¡</label>
            <button className="btn btn-ghost" style={{padding:"4px 10px",fontSize:12}} onClick={()=>addListItem("operation","prizeList",{grade:"",item:"",qty:"",note:""})}>+ ì¶”ê°€</button>
          </div>
          <div style={{overflowX:"auto"}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}>
              <thead><tr style={{background:"rgba(99,102,241,.1)"}}>
                {["#","ë“±ê¸‰","í’ˆëª©","ìˆ˜ëŸ‰","ë¹„ê³ ",""].map((h,i)=><th key={i} style={{padding:"6px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)",width:i===0?30:i===3?60:i===5?36:undefined}}>{h}</th>)}
              </tr></thead>
              <tbody>
                {prList.map((item,idx)=>(
                  <tr key={idx}>
                    <td style={{padding:"4px 8px",border:"1px solid rgba(255,255,255,.05)",textAlign:"center",color:"var(--txt3)",fontSize:11}}>{idx+1}</td>
                    {["grade","item","qty","note"].map(f=>(
                      <td key={f} style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item[f]||""} onChange={e=>updateListItem("operation","prizeList",idx,f,e.target.value)} style={{padding:"4px 8px",fontSize:12,textAlign:f==="qty"?"center":undefined}} placeholder={{grade:"1ë“±",item:"ê²½í’ˆëª…",qty:"0",note:"ë¹„ê³ "}[f]}/></td>
                    ))}
                    <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)",textAlign:"center"}}><button onClick={()=>removeListItem("operation","prizeList",idx)} style={{background:"rgba(239,68,68,.15)",border:"none",color:"#fca5a5",borderRadius:4,padding:"3px 7px",cursor:"pointer",fontSize:11}}>âœ•</button></td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    if (activeSection === "timeline") {
      const mlList = sd("timeline").milestones || [];
      const hasGantt = (proj?.gantt||[]).length > 0;

      // ê°„íŠ¸ì°¨íŠ¸ â†’ íƒ€ì„ë¼ì¸ ë³€í™˜ í•¨ìˆ˜
      const importFromGantt = () => {
        const gantt = proj?.gantt || [];
        if (!gantt.length) { toast("ê°„íŠ¸ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤","warn"); return; }
        const converted = [];
        gantt.forEach(g => {
          converted.push({
            division: g.division || "",
            task: g.task || "",
            startDate: g.startDate || "",
            endDate: g.endDate || "",
            progress: g.progress || 0,
            status: g.progress === 100 ? "ì™„ë£Œ" : (g.progress||0) > 0 ? "ì§„í–‰ì¤‘" : "ì˜ˆì •",
            color: g.color || "#6366f1",
            isSubtask: false,
          });
          (g.subtasks||[]).forEach(s => {
            converted.push({
              division: "",
              task: `â”” ${s.task}`,
              startDate: s.startDate || "",
              endDate: s.endDate || "",
              progress: s.done ? 100 : 0,
              status: s.done ? "ì™„ë£Œ" : "ì˜ˆì •",
              color: g.color || "#6366f1",
              isSubtask: true,
            });
          });
        });
        setList("timeline","milestones", converted);
        toast("âœ… ê°„íŠ¸ì°¨íŠ¸ì—ì„œ íƒ€ì„ë¼ì¸ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤","success");
      };

      const STATUS_COLORS_TL = {"ì™„ë£Œ":"#10b981","ì§„í–‰ì¤‘":"#f59e0b","ì˜ˆì •":"#6366f1"};

      return (
        <div>
          {/* ìƒë‹¨ ë²„íŠ¼ ë°” */}
          <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:12,flexWrap:"wrap",gap:8}}>
            <div style={{display:"flex",alignItems:"center",gap:6}}>
              <label className="form-label" style={{margin:0}}>íƒ€ì„ë¼ì¸ (ê°„íŠ¸ì°¨íŠ¸ ì—°ë™)</label>
              {hasGantt && (
                <span style={{fontSize:11,color:"#10b981",background:"rgba(16,185,129,.1)",border:"1px solid rgba(16,185,129,.2)",borderRadius:4,padding:"2px 7px"}}>
                  ê°„íŠ¸ {(proj?.gantt||[]).length}ê°œ í•­ëª© ì—°ê²°ë¨
                </span>
              )}
            </div>
            <div style={{display:"flex",gap:6}}>
              {hasGantt && (
                <button className="btn btn-ghost" style={{padding:"5px 12px",fontSize:12,borderColor:"rgba(16,185,129,.3)",color:"#34d399"}}
                  onClick={importFromGantt}>
                  ğŸ”„ ê°„íŠ¸ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                </button>
              )}
              <button className="btn btn-ghost" style={{padding:"5px 12px",fontSize:12}}
                onClick={()=>setList("timeline","milestones",[...(sd("timeline").milestones||[]),{division:"",task:"",startDate:"",endDate:"",progress:0,status:"ì˜ˆì •",color:"#6366f1",isSubtask:false}])}>
                + ì§ì ‘ ì¶”ê°€
              </button>
            </div>
          </div>

          {/* ê°„íŠ¸ ì—†ê³  ëª©ë¡ ë¹„ì–´ìˆì„ ë•Œ ì•ˆë‚´ */}
          {!hasGantt && mlList.length===0 && (
            <div style={{background:"rgba(99,102,241,.06)",border:"1px dashed rgba(99,102,241,.2)",borderRadius:8,padding:20,textAlign:"center",marginBottom:16}}>
              <div style={{fontSize:24,marginBottom:8}}>ğŸ“…</div>
              <div style={{color:"var(--txt3)",fontSize:13}}>ê°„íŠ¸ì°¨íŠ¸ë¥¼ ë¨¼ì € ì‘ì„±í•˜ë©´ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
              <div style={{color:"var(--txt4)",fontSize:12,marginTop:4}}>ë˜ëŠ” "ì§ì ‘ ì¶”ê°€" ë²„íŠ¼ìœ¼ë¡œ ìˆ˜ë™ ì…ë ¥í•˜ì„¸ìš”.</div>
            </div>
          )}

          {/* ê°„íŠ¸ ìˆê³  ëª©ë¡ ë¹„ì–´ìˆì„ ë•Œ ìë™ ì•ˆë‚´ */}
          {hasGantt && mlList.length===0 && (
            <div style={{background:"rgba(16,185,129,.06)",border:"1px dashed rgba(16,185,129,.25)",borderRadius:8,padding:16,textAlign:"center",marginBottom:16}}>
              <div style={{fontSize:20,marginBottom:6}}>âœ¨</div>
              <div style={{color:"#34d399",fontSize:13,fontWeight:600}}>ê°„íŠ¸ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤!</div>
              <div style={{color:"var(--txt4)",fontSize:12,marginTop:4}}>ìƒë‹¨ì˜ "ğŸ”„ ê°„íŠ¸ì—ì„œ ê°€ì ¸ì˜¤ê¸°" ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</div>
            </div>
          )}

          {/* íƒ€ì„ë¼ì¸ í…Œì´ë¸” */}
          {mlList.length > 0 && (
            <div style={{overflowX:"auto",marginBottom:16}}>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:12,minWidth:640}}>
                <thead>
                  <tr style={{background:"rgba(99,102,241,.1)"}}>
                    {["#","êµ¬ë¶„","ì—…ë¬´","ì‹œì‘ì¼","ì¢…ë£Œì¼","ì§„í–‰ë¥ ","ìƒíƒœ",""].map((h,i)=>(
                      <th key={i} style={{padding:"7px 8px",color:"#818cf8",fontWeight:700,border:"1px solid rgba(255,255,255,.07)",
                        width:i===0?28:i===5?70:i===6?76:i===7?32:undefined,whiteSpace:"nowrap"}}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {mlList.map((item,idx)=>{
                    const sc = STATUS_COLORS_TL[item.status||"ì˜ˆì •"]||"#6366f1";
                    const rowBg = item.isSubtask ? "rgba(255,255,255,.015)" : "transparent";
                    return (
                      <tr key={idx} style={{background:rowBg}}>
                        <td style={{padding:"4px 8px",border:"1px solid rgba(255,255,255,.05)",textAlign:"center",color:"var(--txt4)",fontSize:10}}>{idx+1}</td>
                        <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.division||""} onChange={e=>updateListItem("timeline","milestones",idx,"division",e.target.value)} style={{padding:"4px 8px",fontSize:11}} placeholder="êµ¬ë¶„"/></td>
                        <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.task||""} onChange={e=>updateListItem("timeline","milestones",idx,"task",e.target.value)} style={{padding:"4px 8px",fontSize:12,paddingLeft:item.isSubtask?"20px":"8px"}} placeholder="ì—…ë¬´ëª…"/></td>
                        <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.startDate||""} onChange={e=>updateListItem("timeline","milestones",idx,"startDate",e.target.value)} style={{padding:"4px 8px",fontSize:11}} placeholder="YYYY-MM-DD"/></td>
                        <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><input className="form-input" value={item.endDate||""} onChange={e=>updateListItem("timeline","milestones",idx,"endDate",e.target.value)} style={{padding:"4px 8px",fontSize:11}} placeholder="YYYY-MM-DD"/></td>
                        <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}>
                          <div style={{display:"flex",alignItems:"center",gap:4}}>
                            <div style={{flex:1,height:5,background:"rgba(255,255,255,.07)",borderRadius:99,overflow:"hidden"}}>
                              <div style={{width:`${item.progress||0}%`,height:"100%",background:sc,borderRadius:99,transition:"width .3s"}}/>
                            </div>
                            <span style={{color:sc,fontSize:10,fontWeight:700,minWidth:28}}>{item.progress||0}%</span>
                          </div>
                        </td>
                        <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)"}}><select className="form-input" value={item.status||"ì˜ˆì •"} onChange={e=>updateListItem("timeline","milestones",idx,"status",e.target.value)} style={{padding:"4px 6px",fontSize:11,color:sc}}>
                          {["ì˜ˆì •","ì§„í–‰ì¤‘","ì™„ë£Œ"].map(s=><option key={s} value={s}>{s}</option>)}
                        </select></td>
                        <td style={{padding:"4px",border:"1px solid rgba(255,255,255,.05)",textAlign:"center"}}><button onClick={()=>removeListItem("timeline","milestones",idx)} style={{background:"rgba(239,68,68,.15)",border:"none",color:"#fca5a5",borderRadius:4,padding:"2px 6px",cursor:"pointer",fontSize:10}}>âœ•</button></td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}

          <FG label="íƒ€ì„ë¼ì¸ ë©”ëª¨">
            <textarea className="form-input" rows={2} value={tl.ganttNotes||""} onChange={e=>updateDoc("timeline","ganttNotes",e.target.value)} placeholder="ì „ì²´ ì¼ì • ê´€ë ¨ ë©”ëª¨" style={{resize:"vertical"}}/>
          </FG>
        </div>
      );
    }
    return null;
  };

  const curSec = SECTIONS.find(s=>s.id===activeSection);
  const docColor = isPlan ? "#6366f1" : "#10b981";
  const docLabel = isPlan ? "ìš´ì˜ê³„íšì•ˆ" : "ê²°ê³¼ë³´ê³ ì„œ";

  return (
    <div>
      {/* í—¤ë” */}
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20,flexWrap:"wrap",gap:12}}>
        <div style={{display:"flex",alignItems:"center",gap:12}}>
          <div style={{width:36,height:36,borderRadius:8,background:isPlan?"linear-gradient(135deg,#6366f1,#8b5cf6)":"linear-gradient(135deg,#10b981,#059669)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:18}}>{isPlan?"ğŸ“‹":"ğŸ“Š"}</div>
          <div>
            <div style={{fontSize:18,fontWeight:800,color:"var(--txt)"}}>{docLabel}</div>
            <div style={{fontSize:12,color:"var(--txt3)"}}>{isPlan?"í–‰ì‚¬ ì‚¬ì „ ìš´ì˜ ê³„íš ë¬¸ì„œ":"í–‰ì‚¬ ì‚¬í›„ ê²°ê³¼ ë³´ê³  ë¬¸ì„œ"} Â· PPT/PDF ì¶œë ¥</div>
          </div>
        </div>
        <div style={{display:"flex",gap:8,alignItems:"center"}}>
          <button className="btn btn-primary" onClick={printPDF} style={{background:isPlan?"linear-gradient(135deg,#6366f1,#8b5cf6)":"linear-gradient(135deg,#10b981,#059669)"}}>
            ğŸ–¨ï¸ PDF ì¶œë ¥
          </button>
        </div>
      </div>

      {/* ì„¹ì…˜ íƒ­ + í¸ì§‘ ì˜ì—­ */}
      <div style={{display:"flex",gap:16}}>
        {/* ì„¹ì…˜ ë„¤ë¹„ */}
        <div style={{width:120,flexShrink:0,display:"flex",flexDirection:"column",gap:6}}>
          {SECTIONS.map(sec=>(
            <button key={sec.id} onClick={()=>setActiveSection(sec.id)} style={{
              background: activeSection===sec.id ? (isPlan?"linear-gradient(135deg,#6366f1,#8b5cf6)":"linear-gradient(135deg,#10b981,#059669)") : "rgba(255,255,255,.04)",
              border: activeSection===sec.id ? "none" : "1px solid var(--border)",
              borderRadius:10,padding:"12px 10px",cursor:"pointer",textAlign:"left",
              color: activeSection===sec.id ? "#fff" : "var(--txt3)",
              transition:"all .15s",
            }}>
              <div style={{fontSize:14,marginBottom:4}}>{sec.icon}</div>
              <div style={{fontSize:11,fontWeight:800,letterSpacing:0.5}}>{sec.num}</div>
              <div style={{fontSize:11,lineHeight:1.3,marginTop:2,fontWeight: activeSection===sec.id?700:500}}>{sec.title}</div>
            </button>
          ))}
        </div>

        {/* í¸ì§‘ ì˜ì—­ */}
        <div style={{flex:1}}>
          <div className="card" style={{position:"relative"}}>
            <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:18,paddingBottom:14,borderBottom:"1px solid var(--border)"}}>
              <div style={{width:32,height:32,borderRadius:8,background:isPlan?"rgba(99,102,241,.15)":"rgba(16,185,129,.15)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:16}}>{curSec?.icon}</div>
              <div>
                <div style={{fontSize:15,fontWeight:800,color:"var(--txt)"}}>{curSec?.num} {curSec?.title}</div>
                <div style={{fontSize:11,color:"var(--txt3)"}}>{docLabel} Â· {proj?.name||""}</div>
              </div>
              <div style={{marginLeft:"auto",fontSize:11,color:"var(--txt4)"}}>ìˆ˜ì • ë‚´ìš©ì€ ìë™ ì €ì¥ë©ë‹ˆë‹¤</div>
            </div>
            {renderSection()}
          </div>
        </div>
      </div>
    </div>
  );
}

/* â•â• ë©”ì¸ ì•± â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// â”€ ì§€ì¶œê²°ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ExpensePanel({expenses, setExpenses, projects, users, currentUser}) {
  const BANKS = ["êµ­ë¯¼ì€í–‰","ì‹ í•œì€í–‰","ìš°ë¦¬ì€í–‰","í•˜ë‚˜ì€í–‰","ë†í˜‘ì€í–‰","ê¸°ì—…ì€í–‰","ì¹´ì¹´ì˜¤ë±…í¬","í† ìŠ¤ë±…í¬","ì¼€ì´ë±…í¬","ìˆ˜í˜‘ì€í–‰","SCì œì¼ì€í–‰","ì”¨í‹°ì€í–‰","ìƒˆë§ˆì„ê¸ˆê³ ","ì‹ í˜‘","ìš°ì²´êµ­","ê¸°íƒ€"];
  const TAX_TYPES = ["ë¶€ê°€ì„¸ë³„ë„","ë¶€ê°€ì„¸í¬í•¨","ë©´ì„¸","ê¸°íƒ€"];
  const EVIDENCE_TYPES = ["ì„¸ê¸ˆê³„ì‚°ì„œ","ë§¤ì¶œì „í‘œ","í˜„ê¸ˆì˜ìˆ˜ì¦","ê¸°íƒ€"];
  const RECEIPT_STATES = ["ë°œí–‰","ë¯¸ë°œí–‰","ë¶ˆìš”"];
  const PAY_STATES = ["ì˜ˆì •","ì§€ê¸‰"];
  const EMPTY = {projectId:"",description:"",amount:"",taxType:"ë¶€ê°€ì„¸ë³„ë„",bank:"",accountNo:"",accountName:"",evidence:"ì„¸ê¸ˆê³„ì‚°ì„œ",resolver:"",receiptStatus:"ë°œí–‰",payStatus:"ì˜ˆì •",note:""};

  const [showForm, setShowForm] = useState(false);
  const [form, setForm] = useState(EMPTY);
  const [filter, setFilter] = useState("ì „ì²´");

  // ì„¸ê¸ˆí˜•íƒœë³„ ì§€ê¸‰ìš”ê¸ˆì•¡ ìë™ê³„ì‚°
  const calcPayAmt = (amount, taxType) => {
    const amt = parseInt(amount)||0;
    if (taxType==="ë¶€ê°€ì„¸ë³„ë„") return Math.round(amt*1.1);
    return amt; // ë¶€ê°€ì„¸í¬í•¨, ë©´ì„¸, ê¸°íƒ€
  };
  const calcVAT = (amount, taxType) => {
    const amt = parseInt(amount)||0;
    if (taxType==="ë¶€ê°€ì„¸ë³„ë„") return Math.round(amt*0.1);
    if (taxType==="ë¶€ê°€ì„¸í¬í•¨") return amt - Math.round(amt/1.1);
    return 0;
  };
  const calcSupply = (amount, taxType) => {
    const amt = parseInt(amount)||0;
    if (taxType==="ë¶€ê°€ì„¸í¬í•¨") return Math.round(amt/1.1);
    return amt;
  };

  const submit = () => {
    if (!form.projectId||!form.description.trim()||!form.amount) {
      toast("í”„ë¡œì íŠ¸Â·ì§€ì¶œë‚´ìš©Â·ê¸ˆì•¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤","error"); return;
    }
    const proj = projects.find(p=>p.id===parseInt(form.projectId));
    const nextSeq = (expenses.length>0 ? Math.max(...expenses.map(e=>e.seq||0)) : 0) + 1;
    setExpenses(prev=>[...prev,{
      id:Date.now(), seq:nextSeq, createdAt:today,
      projectId:parseInt(form.projectId), projectName:proj?.name||"",
      description:form.description, amount:parseInt(form.amount)||0,
      taxType:form.taxType, bank:form.bank, accountNo:form.accountNo,
      accountName:form.accountName, evidence:form.evidence,
      resolver:form.resolver, receiptStatus:form.receiptStatus,
      payStatus:form.payStatus, note:form.note,
    }]);
    setForm(EMPTY); setShowForm(false);
    toast("ğŸ’³ ì§€ì¶œê²°ì˜ ë“±ë¡ ì™„ë£Œ","success");
  };

  const deleteItem = (id) => setExpenses(prev=>prev.filter(e=>e.id!==id));
  const filtered = filter==="ì „ì²´" ? expenses : expenses.filter(e=>e.payStatus===filter);

  // í•©ê³„
  const totalAmt = filtered.reduce((s,e)=>s+(parseInt(e.amount)||0),0);
  const totalPay = filtered.reduce((s,e)=>s+calcPayAmt(e.amount,e.taxType),0);

  const TH = ({children,w,color}) => (
    <th style={{background:"#1a2235",color:color||"var(--txt3)",fontWeight:700,fontSize:11,
      padding:"7px 8px",whiteSpace:"nowrap",minWidth:w||60,borderBottom:"2px solid rgba(99,102,241,.3)",
      position:"sticky",top:0,zIndex:1,textAlign:"center",border:"1px solid rgba(255,255,255,.06)"}}>
      {children}
    </th>
  );
  const TD = ({children,color,bold,align}) => (
    <td style={{padding:"6px 8px",fontSize:12,color:color||"var(--txt)",fontWeight:bold?"700":"400",
      whiteSpace:"nowrap",textAlign:align||"left",border:"1px solid rgba(255,255,255,.04)",
      verticalAlign:"middle"}}>
      {children}
    </td>
  );

  return (
    <div>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16,flexWrap:"wrap",gap:10}}>
        <div>
          <h1 style={{color:"var(--txt)",fontSize:20,fontWeight:800,marginBottom:4}}>ğŸ’³ ì§€ì¶œê²°ì˜</h1>
          <div style={{color:"var(--txt4)",fontSize:12}}>ì—…ë¬´ ì§€ì¶œ ê¸°ë¡ Â· ì„¸ê¸ˆí˜•íƒœë³„ ì§€ê¸‰ìš”ê¸ˆì•¡ ìë™ê³„ì‚°</div>
        </div>
        <button className="btn btn-primary" onClick={()=>setShowForm(v=>!v)}>+ ì§€ì¶œ ë“±ë¡</button>
      </div>

      {/* ìš”ì•½ */}
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(130px,1fr))",gap:8,marginBottom:16}}>
        {[["ì „ì²´ ê±´ìˆ˜",expenses.length+"ê±´","#a5b4fc"],
          ["ì§€ê¸‰ ì˜ˆì •",expenses.filter(e=>e.payStatus==="ì˜ˆì •").length+"ê±´","#fbbf24"],
          ["ì§€ê¸‰ ì™„ë£Œ",expenses.filter(e=>e.payStatus==="ì§€ê¸‰").length+"ê±´","#34d399"],
          ["ì§€ê¸‰ìš”ê¸ˆì•¡ í•©ê³„",totalPay.toLocaleString()+"ì›","#38bdf8"],
        ].map(([l,v,c])=>(
          <div key={l} className="card-sm" style={{textAlign:"center",padding:"10px"}}>
            <div style={{color:"var(--txt4)",fontSize:10,marginBottom:4}}>{l}</div>
            <div style={{color:c,fontWeight:800,fontSize:14}}>{v}</div>
          </div>
        ))}
      </div>

      {/* ë“±ë¡ í¼ */}
      {showForm && (
        <div className="card-sm" style={{marginBottom:16,border:"1px solid rgba(99,102,241,.3)"}}>
          <div style={{color:"var(--txt2)",fontWeight:700,fontSize:13,marginBottom:12}}>ğŸ“ ì§€ì¶œê²°ì˜ ë“±ë¡</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(150px,1fr))",gap:8,marginBottom:10}}>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>í”„ë¡œì íŠ¸ *</div>
              <select value={form.projectId} onChange={e=>setForm({...form,projectId:e.target.value})}
                style={{width:"100%",background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:6,padding:"6px 8px",fontSize:12}}>
                <option value="">ì„ íƒ</option>
                {projects.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
              </select>
            </div>
            <div style={{gridColumn:"span 2"}}>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ì§€ì¶œë‚´ìš© *</div>
              <input placeholder="ì˜ˆ: ìŠ¤íƒ­ ì‹ëŒ€, ì¥ë¹„ ë Œíƒˆë¹„" value={form.description}
                onChange={e=>setForm({...form,description:e.target.value})} className="form-input"
                style={{width:"100%",padding:"6px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ê¸ˆì•¡ (ì›) *</div>
              <input type="number" placeholder="0" value={form.amount}
                onChange={e=>setForm({...form,amount:e.target.value})} className="form-input"
                style={{width:"100%",padding:"6px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ì„¸ê¸ˆí˜•íƒœ *</div>
              <select value={form.taxType} onChange={e=>setForm({...form,taxType:e.target.value})}
                style={{width:"100%",background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:6,padding:"6px 8px",fontSize:12}}>
                {TAX_TYPES.map(t=><option key={t}>{t}</option>)}
              </select>
            </div>
            {form.amount && (
              <div style={{background:"rgba(99,102,241,.08)",borderRadius:6,padding:"6px 10px",display:"flex",flexDirection:"column",justifyContent:"center"}}>
                <div style={{color:"var(--txt4)",fontSize:10,marginBottom:2}}>ì§€ê¸‰ìš”ê¸ˆì•¡ (ìë™)</div>
                <div style={{color:"#a5b4fc",fontWeight:800,fontSize:14}}>{calcPayAmt(form.amount,form.taxType).toLocaleString()}ì›</div>
                {form.taxType!=="ë©´ì„¸"&&form.taxType!=="ê¸°íƒ€"&&<div style={{color:"var(--txt4)",fontSize:10}}>ë¶€ê°€ì„¸ {calcVAT(form.amount,form.taxType).toLocaleString()}ì›</div>}
              </div>
            )}
          </div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:8,marginBottom:10}}>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ì§€ê¸‰ì€í–‰</div>
              <select value={form.bank} onChange={e=>setForm({...form,bank:e.target.value})}
                style={{width:"100%",background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:6,padding:"6px 8px",fontSize:12}}>
                <option value="">ì„ íƒ</option>
                {BANKS.map(b=><option key={b}>{b}</option>)}
              </select>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ì§€ê¸‰ê³„ì¢Œë²ˆí˜¸</div>
              <input placeholder="- ì—†ì´ ì…ë ¥" value={form.accountNo}
                onChange={e=>setForm({...form,accountNo:e.target.value})} className="form-input"
                style={{width:"100%",padding:"6px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ì˜ˆê¸ˆì£¼ëª…</div>
              <input placeholder="ì˜ˆê¸ˆì£¼" value={form.accountName}
                onChange={e=>setForm({...form,accountName:e.target.value})} className="form-input"
                style={{width:"100%",padding:"6px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ì¦ë¹™</div>
              <select value={form.evidence} onChange={e=>setForm({...form,evidence:e.target.value})}
                style={{width:"100%",background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:6,padding:"6px 8px",fontSize:12}}>
                {EVIDENCE_TYPES.map(t=><option key={t}>{t}</option>)}
              </select>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ê²°ì˜ì</div>
              <input placeholder="ê²°ì˜ì ì´ë¦„" value={form.resolver}
                onChange={e=>setForm({...form,resolver:e.target.value})} className="form-input"
                style={{width:"100%",padding:"6px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ì¦ë¹™ìˆ˜ì·¨</div>
              <select value={form.receiptStatus} onChange={e=>setForm({...form,receiptStatus:e.target.value})}
                style={{width:"100%",background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:6,padding:"6px 8px",fontSize:12}}>
                {RECEIPT_STATES.map(s=><option key={s}>{s}</option>)}
              </select>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ì§€ê¸‰</div>
              <select value={form.payStatus} onChange={e=>setForm({...form,payStatus:e.target.value})}
                style={{width:"100%",background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:6,padding:"6px 8px",fontSize:12}}>
                {PAY_STATES.map(s=><option key={s}>{s}</option>)}
              </select>
            </div>
            <div style={{gridColumn:"span 2"}}>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ë¹„ê³ </div>
              <input placeholder="ë©”ëª¨" value={form.note}
                onChange={e=>setForm({...form,note:e.target.value})} className="form-input"
                style={{width:"100%",padding:"6px 10px",fontSize:12}}/>
            </div>
          </div>
          <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
            <button onClick={()=>setShowForm(false)} style={{background:"transparent",border:"1px solid var(--border)",color:"var(--txt4)",borderRadius:6,padding:"6px 14px",fontSize:12,cursor:"pointer"}}>ì·¨ì†Œ</button>
            <button onClick={submit} className="btn btn-primary" style={{padding:"6px 18px",fontSize:12}}>ë“±ë¡</button>
          </div>
        </div>
      )}

      {/* í•„í„° */}
      <div style={{display:"flex",gap:6,marginBottom:12,flexWrap:"wrap",alignItems:"center"}}>
        {["ì „ì²´","ì˜ˆì •","ì§€ê¸‰"].map(f=>(
          <button key={f} onClick={()=>setFilter(f)} style={{
            padding:"4px 12px",borderRadius:20,fontSize:12,fontWeight:600,border:"none",cursor:"pointer",
            background:filter===f?"linear-gradient(135deg,#6366f1,#8b5cf6)":"rgba(255,255,255,.05)",
            color:filter===f?"#fff":"var(--txt3)",
          }}>{f} {f!=="ì „ì²´"&&`(${expenses.filter(e=>e.payStatus===f).length})`}</button>
        ))}
        <span style={{marginLeft:"auto",color:"var(--txt4)",fontSize:11}}>
          ì¡°íšŒ {filtered.length}ê±´ Â· ê¸ˆì•¡í•©ê³„ {totalAmt.toLocaleString()}ì› Â· ì§€ê¸‰ìš”ê¸ˆì•¡ {totalPay.toLocaleString()}ì›
        </span>
      </div>

      {/* í…Œì´ë¸” */}
      <div style={{overflowX:"auto",borderRadius:8,border:"1px solid rgba(255,255,255,.07)"}}>
        <table style={{width:"100%",borderCollapse:"collapse",minWidth:1100}}>
          <thead>
            <tr>
              <TH w={36}>ì—°ë²ˆ</TH>
              <TH w={130}>í”„ë¡œì íŠ¸ëª…</TH>
              <TH w={140}>ì§€ì¶œë‚´ìš©</TH>
              <TH w={90}>ê¸ˆì•¡</TH>
              <TH w={90}>ì„¸ê¸ˆí˜•íƒœ</TH>
              <TH w={90} color="#34d399">ê³µê¸‰ê°€ì•¡</TH>
              <TH w={80} color="#34d399">ë¶€ê°€ì„¸</TH>
              <TH w={100} color="#a5b4fc">ì§€ê¸‰ìš”ê¸ˆì•¡</TH>
              <TH w={80}>ì§€ê¸‰ì€í–‰</TH>
              <TH w={120}>ê³„ì¢Œë²ˆí˜¸</TH>
              <TH w={70}>ì˜ˆê¸ˆì£¼</TH>
              <TH w={90}>ì¦ë¹™</TH>
              <TH w={60}>ê²°ì˜ì</TH>
              <TH w={70}>ì¦ë¹™ìˆ˜ì·¨</TH>
              <TH w={60}>ì§€ê¸‰</TH>
              <TH w={100}>ë¹„ê³ </TH>
              <TH w={36}></TH>
            </tr>
          </thead>
          <tbody>
            {filtered.length===0 && (
              <tr><td colSpan={17} style={{textAlign:"center",color:"var(--txt4)",padding:"32px",fontSize:13}}>ë“±ë¡ëœ ì§€ì¶œê²°ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>
            )}
            {filtered.map((e,i)=>{
              const supply = calcSupply(e.amount,e.taxType);
              const vat = calcVAT(e.amount,e.taxType);
              const payAmt = calcPayAmt(e.amount,e.taxType);
              const rowBg = i%2===0?"transparent":"rgba(255,255,255,.015)";
              return (
                <tr key={e.id} style={{background:rowBg}}>
                  <TD align="center" color="#6366f1" bold>{e.seq||i+1}</TD>
                  <TD><span style={{color:"#a5b4fc",fontSize:11}}>{e.projectName||"-"}</span></TD>
                  <TD>{e.description}</TD>
                  <TD align="right" bold>{(e.amount||0).toLocaleString()}</TD>
                  <TD align="center">
                    <span style={{background:
                      e.taxType==="ë¶€ê°€ì„¸ë³„ë„"?"rgba(99,102,241,.12)":
                      e.taxType==="ë¶€ê°€ì„¸í¬í•¨"?"rgba(6,182,212,.12)":
                      e.taxType==="ë©´ì„¸"?"rgba(16,185,129,.12)":"rgba(100,116,139,.12)",
                      color:e.taxType==="ë¶€ê°€ì„¸ë³„ë„"?"#a5b4fc":e.taxType==="ë¶€ê°€ì„¸í¬í•¨"?"#38bdf8":e.taxType==="ë©´ì„¸"?"#34d399":"#94a3b8",
                      borderRadius:4,padding:"2px 6px",fontSize:11,fontWeight:600}}>
                      {e.taxType}
                    </span>
                  </TD>
                  <TD align="right" color="#34d399">{supply.toLocaleString()}</TD>
                  <TD align="right" color="#34d399">{vat.toLocaleString()}</TD>
                  <TD align="right" bold color="#a5b4fc">{payAmt.toLocaleString()}</TD>
                  <TD>{e.bank||"-"}</TD>
                  <TD><span style={{fontFamily:"monospace",fontSize:11}}>{e.accountNo||"-"}</span></TD>
                  <TD>{e.accountName||"-"}</TD>
                  <TD align="center"><span style={{fontSize:11,color:"var(--txt3)"}}>{e.evidence}</span></TD>
                  <TD align="center">{e.resolver||"-"}</TD>
                  <TD align="center">
                    <span style={{
                      color:e.receiptStatus==="ë°œí–‰"?"#34d399":e.receiptStatus==="ë¯¸ë°œí–‰"?"#fbbf24":"#94a3b8",
                      fontSize:11,fontWeight:600}}>
                      {e.receiptStatus}
                    </span>
                  </TD>
                  <TD align="center">
                    <span style={{
                      background:e.payStatus==="ì§€ê¸‰"?"rgba(16,185,129,.15)":"rgba(245,158,11,.12)",
                      color:e.payStatus==="ì§€ê¸‰"?"#34d399":"#fbbf24",
                      borderRadius:4,padding:"2px 7px",fontSize:11,fontWeight:700}}>
                      {e.payStatus}
                    </span>
                  </TD>
                  <TD color="var(--txt4)">{e.note||""}</TD>
                  <td style={{padding:"4px",textAlign:"center",border:"1px solid rgba(255,255,255,.04)"}}>
                    <button onClick={()=>deleteItem(e.id)}
                      style={{background:"transparent",border:"none",color:"#fca5a5",fontSize:13,cursor:"pointer",padding:0,lineHeight:1}}>Ã—</button>
                  </td>
                </tr>
              );
            })}
          </tbody>
          {filtered.length>0 && (
            <tfoot>
              <tr style={{background:"rgba(99,102,241,.08)"}}>
                <td colSpan={3} style={{padding:"7px 8px",color:"#a5b4fc",fontWeight:700,fontSize:12,borderTop:"2px solid rgba(99,102,241,.3)"}}>í•©ê³„</td>
                <td style={{padding:"7px 8px",textAlign:"right",color:"var(--txt)",fontWeight:800,fontSize:12,borderTop:"2px solid rgba(99,102,241,.3)"}}>{totalAmt.toLocaleString()}</td>
                <td style={{borderTop:"2px solid rgba(99,102,241,.3)"}}/>
                <td style={{padding:"7px 8px",textAlign:"right",color:"#34d399",fontWeight:700,fontSize:12,borderTop:"2px solid rgba(99,102,241,.3)"}}>{filtered.reduce((s,e)=>s+calcSupply(e.amount,e.taxType),0).toLocaleString()}</td>
                <td style={{padding:"7px 8px",textAlign:"right",color:"#34d399",fontWeight:700,fontSize:12,borderTop:"2px solid rgba(99,102,241,.3)"}}>{filtered.reduce((s,e)=>s+calcVAT(e.amount,e.taxType),0).toLocaleString()}</td>
                <td style={{padding:"7px 8px",textAlign:"right",color:"#a5b4fc",fontWeight:800,fontSize:13,borderTop:"2px solid rgba(99,102,241,.3)"}}>{totalPay.toLocaleString()}</td>
                <td colSpan={9} style={{borderTop:"2px solid rgba(99,102,241,.3)"}}/>
              </tr>
            </tfoot>
          )}
        </table>
      </div>
    </div>
  );
}

// â”€ ì¸ê±´ë¹„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LaborPanel({laborCosts, setLaborCosts, projects, users, currentUser}) {
  const BANKS = ["êµ­ë¯¼ì€í–‰","ì‹ í•œì€í–‰","ìš°ë¦¬ì€í–‰","í•˜ë‚˜ì€í–‰","ë†í˜‘ì€í–‰","ê¸°ì—…ì€í–‰","ì¹´ì¹´ì˜¤ë±…í¬","í† ìŠ¤ë±…í¬","ì¼€ì´ë±…í¬","ìˆ˜í˜‘ì€í–‰","SCì œì¼ì€í–‰","ì”¨í‹°ì€í–‰","ìƒˆë§ˆì„ê¸ˆê³ ","ì‹ í˜‘","ìš°ì²´êµ­","ê¸°íƒ€"];
  const TAX_TYPES = ["ì‚¬ì—…ì†Œë“","ê¸°íƒ€ì†Œë“"];
  const PAY_STATES = ["ì˜ˆì •","ì§€ê¸‰"];
  const EMPTY = {projectId:"",description:"",amount:"",taxType:"ì‚¬ì—…ì†Œë“",idNumber:"",bank:"",accountNo:"",accountName:"",resolver:"",reportDate:today,payStatus:"ì˜ˆì •",note:""};

  const [showForm, setShowForm] = useState(false);
  const [form, setForm] = useState(EMPTY);
  const [filter, setFilter] = useState("ì „ì²´");

  // ì„¸ê¸ˆí˜•íƒœë³„ ì›ì²œì„¸ ê³„ì‚°
  // ì‚¬ì—…ì†Œë“: 3.3% (ì†Œë“ì„¸ 3% + ì§€ë°©ì†Œë“ì„¸ 0.3%)
  // ê¸°íƒ€ì†Œë“: 22% (ì†Œë“ì„¸ 20% + ì§€ë°©ì†Œë“ì„¸ 2%)
  const calcTax = (amount, taxType) => {
    const amt = parseInt(amount)||0;
    if (taxType==="ì‚¬ì—…ì†Œë“") {
      const incomeTax = Math.round(amt*0.03);
      const localTax = Math.round(amt*0.003);
      return { incomeTax, localTax, total: incomeTax+localTax, netPay: amt-(incomeTax+localTax) };
    } else { // ê¸°íƒ€ì†Œë“
      const incomeTax = Math.round(amt*0.20);
      const localTax = Math.round(amt*0.02);
      return { incomeTax, localTax, total: incomeTax+localTax, netPay: amt-(incomeTax+localTax) };
    }
  };

  const submit = () => {
    if (!form.projectId||!form.description.trim()||!form.amount) {
      toast("í”„ë¡œì íŠ¸Â·ì§€ì¶œë‚´ìš©Â·ê¸ˆì•¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤","error"); return;
    }
    const proj = projects.find(p=>p.id===parseInt(form.projectId));
    const nextSeq = (laborCosts.length>0 ? Math.max(...laborCosts.map(e=>e.seq||0)) : 0) + 1;
    setLaborCosts(prev=>[...prev,{
      id:Date.now(), seq:nextSeq, createdAt:today,
      projectId:parseInt(form.projectId), projectName:proj?.name||"",
      description:form.description, amount:parseInt(form.amount)||0,
      taxType:form.taxType, idNumber:form.idNumber,
      bank:form.bank, accountNo:form.accountNo, accountName:form.accountName,
      resolver:form.resolver, reportDate:form.reportDate,
      payStatus:form.payStatus, note:form.note,
    }]);
    setForm(EMPTY); setShowForm(false);
    toast("ğŸ‘¤ ì¸ê±´ë¹„ ë“±ë¡ ì™„ë£Œ","success");
  };

  const deleteItem = (id) => setLaborCosts(prev=>prev.filter(e=>e.id!==id));
  const filtered = filter==="ì „ì²´" ? laborCosts : filter==="ì‚¬ì—…ì†Œë“"||filter==="ê¸°íƒ€ì†Œë“"
    ? laborCosts.filter(e=>e.taxType===filter)
    : laborCosts.filter(e=>e.payStatus===filter);

  const totalAmt = filtered.reduce((s,e)=>s+(parseInt(e.amount)||0),0);
  const totalTax = filtered.reduce((s,e)=>s+calcTax(e.amount,e.taxType).total,0);
  const totalNet = filtered.reduce((s,e)=>s+calcTax(e.amount,e.taxType).netPay,0);

  const TH = ({children,w,color}) => (
    <th style={{background:"#1a2235",color:color||"var(--txt3)",fontWeight:700,fontSize:11,
      padding:"7px 8px",whiteSpace:"nowrap",minWidth:w||60,borderBottom:"2px solid rgba(99,102,241,.3)",
      position:"sticky",top:0,zIndex:1,textAlign:"center",border:"1px solid rgba(255,255,255,.06)"}}>
      {children}
    </th>
  );
  const TD = ({children,color,bold,align}) => (
    <td style={{padding:"6px 8px",fontSize:12,color:color||"var(--txt)",fontWeight:bold?"700":"400",
      whiteSpace:"nowrap",textAlign:align||"left",border:"1px solid rgba(255,255,255,.04)",
      verticalAlign:"middle"}}>
      {children}
    </td>
  );

  const previewTax = form.amount ? calcTax(form.amount, form.taxType) : null;

  return (
    <div>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16,flexWrap:"wrap",gap:10}}>
        <div>
          <h1 style={{color:"var(--txt)",fontSize:20,fontWeight:800,marginBottom:4}}>ğŸ‘¤ ì¸ê±´ë¹„</h1>
          <div style={{color:"var(--txt4)",fontSize:12}}>ì¸ë ¥ ì§€ê¸‰ ê¸°ë¡ Â· ì‚¬ì—…ì†Œë“(3.3%) / ê¸°íƒ€ì†Œë“(22%) ì›ì²œì„¸ ìë™ê³„ì‚°</div>
        </div>
        <button className="btn btn-primary" onClick={()=>setShowForm(v=>!v)}>+ ì¸ê±´ë¹„ ë“±ë¡</button>
      </div>

      {/* ìš”ì•½ */}
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(130px,1fr))",gap:8,marginBottom:16}}>
        {[["ì „ì²´ ê±´ìˆ˜",laborCosts.length+"ê±´","#a5b4fc"],
          ["ì‚¬ì—…ì†Œë“",laborCosts.filter(e=>e.taxType==="ì‚¬ì—…ì†Œë“").length+"ê±´","#6366f1"],
          ["ê¸°íƒ€ì†Œë“",laborCosts.filter(e=>e.taxType==="ê¸°íƒ€ì†Œë“").length+"ê±´","#ec4899"],
          ["ì„¸ì•¡í•©ê³„",filtered.reduce((s,e)=>s+calcTax(e.amount,e.taxType).total,0).toLocaleString()+"ì›","#f59e0b"],
          ["ì‹¤ì§€ê¸‰í•©ê³„",totalNet.toLocaleString()+"ì›","#34d399"],
        ].map(([l,v,c])=>(
          <div key={l} className="card-sm" style={{textAlign:"center",padding:"10px"}}>
            <div style={{color:"var(--txt4)",fontSize:10,marginBottom:4}}>{l}</div>
            <div style={{color:c,fontWeight:800,fontSize:13}}>{v}</div>
          </div>
        ))}
      </div>

      {/* ë“±ë¡ í¼ */}
      {showForm && (
        <div className="card-sm" style={{marginBottom:16,border:"1px solid rgba(99,102,241,.3)"}}>
          <div style={{color:"var(--txt2)",fontWeight:700,fontSize:13,marginBottom:12}}>ğŸ“ ì¸ê±´ë¹„ ë“±ë¡</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(150px,1fr))",gap:8,marginBottom:10}}>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>í”„ë¡œì íŠ¸ *</div>
              <select value={form.projectId} onChange={e=>setForm({...form,projectId:e.target.value})}
                style={{width:"100%",background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:6,padding:"6px 8px",fontSize:12}}>
                <option value="">ì„ íƒ</option>
                {projects.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
              </select>
            </div>
            <div style={{gridColumn:"span 2"}}>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ì§€ì¶œë‚´ìš© *</div>
              <input placeholder="ì˜ˆ: í”„ë¡œë“€ì„œ(í™ê¸¸ë™), ê°•ì‚¬ë£Œ, ìŠ¤íƒœí”„ ì¸ê±´ë¹„" value={form.description}
                onChange={e=>setForm({...form,description:e.target.value})} className="form-input"
                style={{width:"100%",padding:"6px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ê¸ˆì•¡ (ì›) *</div>
              <input type="number" placeholder="0" value={form.amount}
                onChange={e=>setForm({...form,amount:e.target.value})} className="form-input"
                style={{width:"100%",padding:"6px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ì„¸ê¸ˆí˜•íƒœ *</div>
              <select value={form.taxType} onChange={e=>setForm({...form,taxType:e.target.value})}
                style={{width:"100%",background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:6,padding:"6px 8px",fontSize:12}}>
                {TAX_TYPES.map(t=><option key={t}>{t}</option>)}
              </select>
            </div>
            {previewTax && (
              <div style={{background:"rgba(99,102,241,.08)",borderRadius:6,padding:"6px 10px",gridColumn:"span 2"}}>
                <div style={{color:"var(--txt4)",fontSize:10,marginBottom:4}}>
                  {form.taxType==="ì‚¬ì—…ì†Œë“"?"ì‚¬ì—…ì†Œë“ 3.3% (ì†Œë“ì„¸ 3% + ì§€ë°©ì†Œë“ì„¸ 0.3%)":"ê¸°íƒ€ì†Œë“ 22% (ì†Œë“ì„¸ 20% + ì§€ë°©ì†Œë“ì„¸ 2%)"}
                </div>
                <div style={{display:"flex",gap:16,flexWrap:"wrap"}}>
                  <div><span style={{color:"var(--txt4)",fontSize:10}}>ì†Œë“ì„¸ </span><span style={{color:"#fbbf24",fontWeight:700,fontSize:12}}>{previewTax.incomeTax.toLocaleString()}ì›</span></div>
                  <div><span style={{color:"var(--txt4)",fontSize:10}}>ì§€ë°©ì†Œë“ì„¸ </span><span style={{color:"#fbbf24",fontWeight:700,fontSize:12}}>{previewTax.localTax.toLocaleString()}ì›</span></div>
                  <div><span style={{color:"var(--txt4)",fontSize:10}}>ê³µì œí•©ê³„ </span><span style={{color:"#f59e0b",fontWeight:700,fontSize:12}}>{previewTax.total.toLocaleString()}ì›</span></div>
                  <div><span style={{color:"var(--txt4)",fontSize:10}}>ì‹¤ì§€ê¸‰ì•¡ </span><span style={{color:"#34d399",fontWeight:800,fontSize:14}}>{previewTax.netPay.toLocaleString()}ì›</span></div>
                </div>
              </div>
            )}
          </div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:8,marginBottom:10}}>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ì£¼ë¯¼ë²ˆí˜¸</div>
              <input placeholder="000000-0000000" value={form.idNumber}
                onChange={e=>setForm({...form,idNumber:e.target.value})} className="form-input"
                style={{width:"100%",padding:"6px 10px",fontSize:12,fontFamily:"monospace"}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ì§€ê¸‰ì€í–‰</div>
              <select value={form.bank} onChange={e=>setForm({...form,bank:e.target.value})}
                style={{width:"100%",background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:6,padding:"6px 8px",fontSize:12}}>
                <option value="">ì„ íƒ</option>
                {BANKS.map(b=><option key={b}>{b}</option>)}
              </select>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ê³„ì¢Œë²ˆí˜¸</div>
              <input placeholder="- ì—†ì´ ì…ë ¥" value={form.accountNo}
                onChange={e=>setForm({...form,accountNo:e.target.value})} className="form-input"
                style={{width:"100%",padding:"6px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ì˜ˆê¸ˆì£¼</div>
              <input placeholder="ì˜ˆê¸ˆì£¼" value={form.accountName}
                onChange={e=>setForm({...form,accountName:e.target.value})} className="form-input"
                style={{width:"100%",padding:"6px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ê²°ì˜ì</div>
              <input placeholder="ê²°ì˜ì" value={form.resolver}
                onChange={e=>setForm({...form,resolver:e.target.value})} className="form-input"
                style={{width:"100%",padding:"6px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ë³´ê³ ì¼</div>
              <input type="date" value={form.reportDate}
                onChange={e=>setForm({...form,reportDate:e.target.value})} className="form-input"
                style={{width:"100%",padding:"6px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ì§€ê¸‰</div>
              <select value={form.payStatus} onChange={e=>setForm({...form,payStatus:e.target.value})}
                style={{width:"100%",background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:6,padding:"6px 8px",fontSize:12}}>
                {PAY_STATES.map(s=><option key={s}>{s}</option>)}
              </select>
            </div>
            <div style={{gridColumn:"span 2"}}>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:3}}>ë¹„ê³ </div>
              <input placeholder="ë©”ëª¨" value={form.note}
                onChange={e=>setForm({...form,note:e.target.value})} className="form-input"
                style={{width:"100%",padding:"6px 10px",fontSize:12}}/>
            </div>
          </div>
          <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
            <button onClick={()=>setShowForm(false)} style={{background:"transparent",border:"1px solid var(--border)",color:"var(--txt4)",borderRadius:6,padding:"6px 14px",fontSize:12,cursor:"pointer"}}>ì·¨ì†Œ</button>
            <button onClick={submit} className="btn btn-primary" style={{padding:"6px 18px",fontSize:12}}>ë“±ë¡</button>
          </div>
        </div>
      )}

      {/* í•„í„° */}
      <div style={{display:"flex",gap:6,marginBottom:12,flexWrap:"wrap",alignItems:"center"}}>
        {["ì „ì²´","ì‚¬ì—…ì†Œë“","ê¸°íƒ€ì†Œë“","ì˜ˆì •","ì§€ê¸‰"].map(f=>(
          <button key={f} onClick={()=>setFilter(f)} style={{
            padding:"4px 12px",borderRadius:20,fontSize:12,fontWeight:600,border:"none",cursor:"pointer",
            background:filter===f?"linear-gradient(135deg,#6366f1,#8b5cf6)":"rgba(255,255,255,.05)",
            color:filter===f?"#fff":"var(--txt3)",
          }}>{f}</button>
        ))}
        <span style={{marginLeft:"auto",color:"var(--txt4)",fontSize:11}}>
          ì¡°íšŒ {filtered.length}ê±´ Â· ì´ê¸ˆì•¡ {totalAmt.toLocaleString()}ì› Â· ì„¸ì•¡ {totalTax.toLocaleString()}ì› Â· ì‹¤ì§€ê¸‰ {totalNet.toLocaleString()}ì›
        </span>
      </div>

      {/* í…Œì´ë¸” */}
      <div style={{overflowX:"auto",borderRadius:8,border:"1px solid rgba(255,255,255,.07)"}}>
        <table style={{width:"100%",borderCollapse:"collapse",minWidth:1300}}>
          <thead>
            <tr>
              <TH w={36}>ì—°ë²ˆ</TH>
              <TH w={130}>í”„ë¡œì íŠ¸ëª…</TH>
              <TH w={150}>ì§€ì¶œë‚´ìš©</TH>
              <TH w={90}>ê¸ˆì•¡</TH>
              <TH w={80}>ì„¸ê¸ˆí˜•íƒœ</TH>
              <TH w={80} color="#fbbf24">ì†Œë“ì„¸</TH>
              <TH w={80} color="#fbbf24">ì§€ë°©ì†Œë“ì„¸</TH>
              <TH w={90} color="#f59e0b">ì„¸ì•¡í•©ê³„</TH>
              <TH w={100} color="#34d399">ì´ì§€ì¶œ(ì‹¤ì§€ê¸‰)</TH>
              <TH w={120}>ì£¼ë¯¼ë²ˆí˜¸</TH>
              <TH w={80}>ì§€ê¸‰ì€í–‰</TH>
              <TH w={120}>ê³„ì¢Œë²ˆí˜¸</TH>
              <TH w={70}>ì˜ˆê¸ˆì£¼</TH>
              <TH w={60}>ê²°ì˜ì</TH>
              <TH w={90}>ë³´ê³ ì¼</TH>
              <TH w={60}>ì§€ê¸‰</TH>
              <TH w={100}>ë¹„ê³ </TH>
              <TH w={36}></TH>
            </tr>
          </thead>
          <tbody>
            {filtered.length===0 && (
              <tr><td colSpan={18} style={{textAlign:"center",color:"var(--txt4)",padding:"32px",fontSize:13}}>ë“±ë¡ëœ ì¸ê±´ë¹„ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>
            )}
            {filtered.map((e,i)=>{
              const tax = calcTax(e.amount,e.taxType);
              const rowBg = i%2===0?"transparent":"rgba(255,255,255,.015)";
              const isSaup = e.taxType==="ì‚¬ì—…ì†Œë“";
              return (
                <tr key={e.id} style={{background:rowBg}}>
                  <TD align="center" color="#6366f1" bold>{e.seq||i+1}</TD>
                  <TD><span style={{color:"#a5b4fc",fontSize:11}}>{e.projectName||"-"}</span></TD>
                  <TD>{e.description}</TD>
                  <TD align="right" bold>{(e.amount||0).toLocaleString()}</TD>
                  <TD align="center">
                    <span style={{
                      background:isSaup?"rgba(99,102,241,.12)":"rgba(236,72,153,.12)",
                      color:isSaup?"#a5b4fc":"#f472b6",
                      borderRadius:4,padding:"2px 6px",fontSize:11,fontWeight:600}}>
                      {e.taxType}<br/><span style={{fontSize:10,opacity:.8}}>{isSaup?"3.3%":"22%"}</span>
                    </span>
                  </TD>
                  <TD align="right" color="#fbbf24">{tax.incomeTax.toLocaleString()}</TD>
                  <TD align="right" color="#fbbf24">{tax.localTax.toLocaleString()}</TD>
                  <TD align="right" color="#f59e0b" bold>{tax.total.toLocaleString()}</TD>
                  <TD align="right" bold color="#34d399">{tax.netPay.toLocaleString()}</TD>
                  <TD><span style={{fontFamily:"monospace",fontSize:11,letterSpacing:".04em"}}>
                    {e.idNumber ? e.idNumber.replace(/(\d{6})-?(\d{1})\d+/, "$1-$2â€¢â€¢â€¢â€¢â€¢â€¢") : "-"}
                  </span></TD>
                  <TD>{e.bank||"-"}</TD>
                  <TD><span style={{fontFamily:"monospace",fontSize:11}}>{e.accountNo||"-"}</span></TD>
                  <TD>{e.accountName||"-"}</TD>
                  <TD align="center">{e.resolver||"-"}</TD>
                  <TD align="center" color="var(--txt3)">{e.reportDate||"-"}</TD>
                  <TD align="center">
                    <span style={{
                      background:e.payStatus==="ì§€ê¸‰"?"rgba(16,185,129,.15)":"rgba(245,158,11,.12)",
                      color:e.payStatus==="ì§€ê¸‰"?"#34d399":"#fbbf24",
                      borderRadius:4,padding:"2px 7px",fontSize:11,fontWeight:700}}>
                      {e.payStatus}
                    </span>
                  </TD>
                  <TD color="var(--txt4)">{e.note||""}</TD>
                  <td style={{padding:"4px",textAlign:"center",border:"1px solid rgba(255,255,255,.04)"}}>
                    <button onClick={()=>deleteItem(e.id)}
                      style={{background:"transparent",border:"none",color:"#fca5a5",fontSize:13,cursor:"pointer",padding:0,lineHeight:1}}>Ã—</button>
                  </td>
                </tr>
              );
            })}
          </tbody>
          {filtered.length>0 && (
            <tfoot>
              <tr style={{background:"rgba(99,102,241,.08)"}}>
                <td colSpan={3} style={{padding:"7px 8px",color:"#a5b4fc",fontWeight:700,fontSize:12,borderTop:"2px solid rgba(99,102,241,.3)"}}>í•©ê³„</td>
                <td style={{padding:"7px 8px",textAlign:"right",color:"var(--txt)",fontWeight:800,fontSize:12,borderTop:"2px solid rgba(99,102,241,.3)"}}>{totalAmt.toLocaleString()}</td>
                <td style={{borderTop:"2px solid rgba(99,102,241,.3)"}}/>
                <td style={{padding:"7px 8px",textAlign:"right",color:"#fbbf24",fontWeight:700,fontSize:12,borderTop:"2px solid rgba(99,102,241,.3)"}}>{filtered.reduce((s,e)=>s+calcTax(e.amount,e.taxType).incomeTax,0).toLocaleString()}</td>
                <td style={{padding:"7px 8px",textAlign:"right",color:"#fbbf24",fontWeight:700,fontSize:12,borderTop:"2px solid rgba(99,102,241,.3)"}}>{filtered.reduce((s,e)=>s+calcTax(e.amount,e.taxType).localTax,0).toLocaleString()}</td>
                <td style={{padding:"7px 8px",textAlign:"right",color:"#f59e0b",fontWeight:800,fontSize:12,borderTop:"2px solid rgba(99,102,241,.3)"}}>{totalTax.toLocaleString()}</td>
                <td style={{padding:"7px 8px",textAlign:"right",color:"#34d399",fontWeight:800,fontSize:13,borderTop:"2px solid rgba(99,102,241,.3)"}}>{totalNet.toLocaleString()}</td>
                <td colSpan={9} style={{borderTop:"2px solid rgba(99,102,241,.3)"}}/>
              </tr>
            </tfoot>
          )}
        </table>
      </div>
    </div>
  );
}


// â”€ êµ¬ë§¤ìš”ì²­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PurchasePanel({purchases, setPurchases, projects, users, currentUser}) {
  const CATS = ["ìŒí–¥ì¥ë¹„","ì¡°ëª…ì¥ë¹„","ì˜ìƒì¥ë¹„","ì†Œí’ˆ","ì¸ì‡„ë¬¼","ì†Œëª¨í’ˆ","ê¸°ìì¬","ê¸°íƒ€"];
  const EMPTY = {requestDate:today,deadline:"",projectId:"",category:"ì†Œëª¨í’ˆ",item:"",spec:"",qty:"1",unitPrice:"",buyerId:"",purchaseLink:"",note:""};
  const [showForm, setShowForm] = useState(false);
  const [form, setForm] = useState(EMPTY);
  const [filter, setFilter] = useState("ì „ì²´");
  const FILTERS = ["ì „ì²´","ìš”ì²­ì¤‘","êµ¬ë§¤ì™„ë£Œ","ì·¨ì†Œ"];
  const SC = {ìš”ì²­ì¤‘:{bg:"rgba(56,189,248,.12)",border:"rgba(56,189,248,.3)",text:"#38bdf8"},
    êµ¬ë§¤ì™„ë£Œ:{bg:"rgba(16,185,129,.12)",border:"rgba(16,185,129,.3)",text:"#34d399"},
    ì·¨ì†Œ:{bg:"rgba(100,116,139,.12)",border:"rgba(100,116,139,.3)",text:"#94a3b8"}};
  const calcAmt = () => Math.round((parseInt(form.unitPrice)||0)*(parseInt(form.qty)||1));

  const submit = () => {
    if (!form.projectId||!form.item.trim()||!form.deadline||!form.buyerId) {
      toast("í”„ë¡œì íŠ¸Â·í’ˆëª©Â·ë§ˆê°ì¼Â·êµ¬ë§¤ë‹´ë‹¹ìëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤","error"); return;
    }
    const proj = projects.find(p=>p.id===parseInt(form.projectId));
    const buyer = users.find(u=>u.id===form.buyerId);
    setPurchases(prev=>[{
      id:Date.now(), requestDate:form.requestDate, deadline:form.deadline,
      projectId:parseInt(form.projectId), projectName:proj?.name||"",
      category:form.category, item:form.item, spec:form.spec,
      qty:parseInt(form.qty)||1, unitPrice:parseInt(form.unitPrice)||0,
      amount:calcAmt(), buyerId:form.buyerId, buyerName:buyer?.name||"",
      requester:currentUser?.name, requesterId:currentUser?.id,
      status:"ìš”ì²­ì¤‘", purchaseLink:form.purchaseLink, note:form.note, createdAt:today,
    }, ...prev]);
    setForm(EMPTY); setShowForm(false);
    toast(`ğŸ›’ êµ¬ë§¤ ìš”ì²­ ì™„ë£Œ Â· ${buyer?.name}ì—ê²Œ ì•Œë¦¼`, "success");
  };

  const confirm = (id) => {
    setPurchases(prev=>prev.map(p=>p.id===id?{...p,status:"êµ¬ë§¤ì™„ë£Œ",confirmedAt:today,confirmedBy:currentUser?.name}:p));
    toast("ğŸ›’ êµ¬ë§¤ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤","success");
  };
  const cancel = (id) => {
    setPurchases(prev=>prev.map(p=>p.id===id?{...p,status:"ì·¨ì†Œ",cancelledAt:today,cancelledBy:currentUser?.name}:p));
    toast("êµ¬ë§¤ ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤");
  };

  const canConfirm = (p) => p.buyerId===currentUser?.id && p.status==="ìš”ì²­ì¤‘";
  const canCancel = (p) => (p.requesterId===currentUser?.id || currentUser?.isAdmin) && p.status==="ìš”ì²­ì¤‘";
  const isUrgent = (p) => p.status==="ìš”ì²­ì¤‘" && p.deadline && p.deadline <= new Date(Date.now()+3*86400000).toISOString().slice(0,10);
  const filtered = filter==="ì „ì²´" ? purchases : purchases.filter(p=>p.status===filter);

  return (
    <div>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20,flexWrap:"wrap",gap:10}}>
        <div>
          <h1 style={{color:"var(--txt)",fontSize:20,fontWeight:800,marginBottom:4}}>ğŸ›’ êµ¬ë§¤ìš”ì²­</h1>
          <div style={{color:"var(--txt4)",fontSize:12}}>í–‰ì‚¬ ë¬¼í’ˆ êµ¬ë§¤ ìš”ì²­ ë° ë‹´ë‹¹ì ê´€ë¦¬</div>
        </div>
        <button className="btn btn-primary" onClick={()=>setShowForm(v=>!v)}>+ êµ¬ë§¤ ìš”ì²­</button>
      </div>

      {/* ìš”ì•½ */}
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:10,marginBottom:20}}>
        {[["ìš”ì²­ì¤‘", purchases.filter(p=>p.status==="ìš”ì²­ì¤‘").length+"ê±´","#38bdf8"],
          ["ê¸´ê¸‰ (3ì¼ ë‚´)", purchases.filter(p=>isUrgent(p)).length+"ê±´","#ef4444"],
          ["êµ¬ë§¤ ì™„ë£Œ", purchases.filter(p=>p.status==="êµ¬ë§¤ì™„ë£Œ").length+"ê±´","#34d399"],
          ["ì™„ë£Œ ê¸ˆì•¡", purchases.filter(p=>p.status==="êµ¬ë§¤ì™„ë£Œ").reduce((s,p)=>s+p.amount,0).toLocaleString()+"ì›","#10b981"],
        ].map(([l,v,c])=>(
          <div key={l} className="card-sm" style={{textAlign:"center"}}>
            <div style={{color:"var(--txt4)",fontSize:11,marginBottom:5}}>{l}</div>
            <div style={{color:c,fontWeight:800,fontSize:15}}>{v}</div>
          </div>
        ))}
      </div>

      {/* ì‹ ì²­ í¼ */}
      {showForm && (
        <div className="card-sm" style={{marginBottom:20,border:"1px solid rgba(56,189,248,.3)"}}>
          <div style={{color:"var(--txt2)",fontWeight:700,fontSize:13,marginBottom:14}}>ğŸ“ êµ¬ë§¤ ìš”ì²­ì„œ</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(150px,1fr))",gap:8,marginBottom:10}}>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:4}}>ìš”ì²­ì¼</div>
              <input type="date" value={form.requestDate} onChange={e=>setForm({...form,requestDate:e.target.value})}
                className="form-input" style={{width:"100%",padding:"7px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:4}}>ğŸ”´ êµ¬ë§¤ ë§ˆê°ì¼ *</div>
              <input type="date" value={form.deadline} onChange={e=>setForm({...form,deadline:e.target.value})}
                className="form-input" style={{width:"100%",padding:"7px 10px",fontSize:12,border:"1px solid rgba(239,68,68,.4)"}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:4}}>í”„ë¡œì íŠ¸ *</div>
              <select value={form.projectId} onChange={e=>setForm({...form,projectId:e.target.value})}
                style={{width:"100%",background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:6,padding:"7px 8px",fontSize:12}}>
                <option value="">ì„ íƒ</option>
                {projects.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
              </select>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:4}}>êµ¬ë¶„</div>
              <select value={form.category} onChange={e=>setForm({...form,category:e.target.value})}
                style={{width:"100%",background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:6,padding:"7px 8px",fontSize:12}}>
                {CATS.map(c=><option key={c}>{c}</option>)}
              </select>
            </div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(150px,1fr))",gap:8,marginBottom:10}}>
            <div style={{gridColumn:"span 2"}}>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:4}}>í’ˆëª©ëª… *</div>
              <input placeholder="ì˜ˆ: ë¸”ë£¨íˆ¬ìŠ¤ ìŠ¤í”¼ì»¤" value={form.item} onChange={e=>setForm({...form,item:e.target.value})}
                className="form-input" style={{width:"100%",padding:"7px 10px",fontSize:12}}/>
            </div>
            <div style={{gridColumn:"span 2"}}>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:4}}>ê·œê²©/ì‚¬ì–‘</div>
              <input placeholder="ì˜ˆ: JBL Charge5, ë¸”ë™, ë°©ìˆ˜" value={form.spec} onChange={e=>setForm({...form,spec:e.target.value})}
                className="form-input" style={{width:"100%",padding:"7px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:4}}>ìˆ˜ëŸ‰ *</div>
              <input type="number" min="1" value={form.qty} onChange={e=>setForm({...form,qty:e.target.value})}
                className="form-input" style={{width:"100%",padding:"7px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:4}}>ë‹¨ê°€ (ì›)</div>
              <input type="number" placeholder="0" value={form.unitPrice} onChange={e=>setForm({...form,unitPrice:e.target.value})}
                className="form-input" style={{width:"100%",padding:"7px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:4}}>í•©ê³„ (ìë™)</div>
              <div style={{color:"#38bdf8",fontWeight:800,fontSize:14,padding:"7px 10px",background:"rgba(56,189,248,.07)",borderRadius:6}}>
                {calcAmt().toLocaleString()}ì›
              </div>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:4}}>êµ¬ë§¤ë‹´ë‹¹ì *</div>
              <select value={form.buyerId} onChange={e=>setForm({...form,buyerId:e.target.value})}
                style={{width:"100%",background:"#1e293b",border:"1px solid #334155",color:"var(--txt)",borderRadius:6,padding:"7px 8px",fontSize:12}}>
                <option value="">ë‹´ë‹¹ì ì„ íƒ</option>
                {(users||[]).filter(u=>u.approved||u.id==="admin").map(u=><option key={u.id} value={u.id}>{u.name} ({u.role})</option>)}
              </select>
            </div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:10}}>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:4}}>ğŸ”— êµ¬ë§¤ ë§í¬</div>
              <input placeholder="https://example.com/product (êµ¬ë§¤ìê°€ ë°”ë¡œ í´ë¦­í•´ êµ¬ë§¤í•  ìˆ˜ ìˆëŠ” URL)" value={form.purchaseLink}
                onChange={e=>setForm({...form,purchaseLink:e.target.value})} className="form-input"
                style={{width:"100%",padding:"7px 10px",fontSize:12}}/>
            </div>
            <div>
              <div style={{color:"var(--txt4)",fontSize:11,marginBottom:4}}>ë¹„ê³ /ìš”ì²­ì‚¬í•­</div>
              <input placeholder="êµ¬ë§¤ì²˜ ì§€ì •, ìƒ‰ìƒ, ìš©ë„ ë“±" value={form.note}
                onChange={e=>setForm({...form,note:e.target.value})} className="form-input"
                style={{width:"100%",padding:"7px 10px",fontSize:12}}/>
            </div>
          </div>
          <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
            <button onClick={()=>setShowForm(false)} style={{background:"transparent",border:"1px solid var(--border)",color:"var(--txt4)",borderRadius:6,padding:"7px 16px",fontSize:12,cursor:"pointer"}}>ì·¨ì†Œ</button>
            <button onClick={submit} className="btn btn-primary" style={{padding:"7px 20px",fontSize:12}}>ìš”ì²­í•˜ê¸°</button>
          </div>
        </div>
      )}

      {/* í•„í„° */}
      <div style={{display:"flex",gap:6,marginBottom:14,flexWrap:"wrap"}}>
        {FILTERS.map(f=>(
          <button key={f} onClick={()=>setFilter(f)} style={{
            padding:"5px 14px",borderRadius:20,fontSize:12,fontWeight:600,border:"none",cursor:"pointer",
            background:filter===f?"linear-gradient(135deg,#0ea5e9,#38bdf8)":"rgba(255,255,255,.05)",
            color:filter===f?"#fff":"var(--txt3)",
          }}>{f} {f!=="ì „ì²´"&&<span style={{fontSize:10}}>({purchases.filter(p=>p.status===f).length})</span>}</button>
        ))}
      </div>

      {/* ëª©ë¡ */}
      {filtered.length===0 && <div style={{color:"var(--txt4)",fontSize:13,textAlign:"center",padding:"40px 0"}}>êµ¬ë§¤ ìš”ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>}
      {filtered.map(p=>{
        const urgent = isUrgent(p);
        const ddays = p.deadline ? Math.ceil((new Date(p.deadline)-new Date(today))/(1000*60*60*24)) : null;
        return (
          <div key={p.id} style={{
            background:"rgba(255,255,255,.02)",
            border:`1px solid ${urgent?"rgba(239,68,68,.4)":"rgba(255,255,255,.06)"}`,
            borderLeft:`3px solid ${urgent?"#ef4444":SC[p.status]?.text||"transparent"}`,
            borderRadius:8,padding:"12px 16px",marginBottom:8,
          }}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:10,flexWrap:"wrap"}}>
              <div style={{flex:1,minWidth:0}}>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:5,flexWrap:"wrap"}}>
                  <span style={{background:SC[p.status]?.bg,border:`1px solid ${SC[p.status]?.border}`,color:SC[p.status]?.text,
                    borderRadius:5,padding:"2px 8px",fontSize:11,fontWeight:700}}>{p.status}</span>
                  <span style={{background:"rgba(255,255,255,.05)",color:"var(--txt3)",borderRadius:5,padding:"2px 8px",fontSize:11}}>{p.category}</span>
                  {urgent && <span style={{background:"rgba(239,68,68,.15)",color:"#fca5a5",borderRadius:5,padding:"2px 8px",fontSize:11,fontWeight:700}}>ğŸ”´ ê¸´ê¸‰</span>}
                  {p.deadline && (
                    <span style={{color:ddays<=0?"#fca5a5":ddays<=3?"#fbbf24":"var(--txt4)",fontSize:11,fontWeight:ddays<=3?700:400}}>
                      ë§ˆê° {p.deadline} {ddays!==null&&`(D${ddays<=0?ddays:"-"+ddays})`}
                    </span>
                  )}
                </div>
                <div style={{color:"var(--txt)",fontWeight:700,fontSize:13,marginBottom:2}}>
                  {p.item} {p.spec&&<span style={{color:"var(--txt4)",fontWeight:400,fontSize:12}}>Â· {p.spec}</span>}
                </div>
                <div style={{color:"var(--txt3)",fontSize:12,marginBottom:3}}>
                  {p.qty}ê°œ{p.unitPrice>0&&` Ã— ${p.unitPrice.toLocaleString()}ì›`}
                </div>
                <div style={{color:"var(--txt4)",fontSize:11}}>
                  {p.projectName} &nbsp;Â·&nbsp; ìš”ì²­: {p.requester} &nbsp;Â·&nbsp; êµ¬ë§¤ë‹´ë‹¹: <span style={{color:"#38bdf8",fontWeight:600}}>{p.buyerName}</span>
                </div>
                {p.purchaseLink && (
                  <div style={{marginTop:4}}>
                    <a href={p.purchaseLink} target="_blank" rel="noopener noreferrer"
                      style={{display:"inline-flex",alignItems:"center",gap:5,
                        background:"rgba(56,189,248,.1)",border:"1px solid rgba(56,189,248,.25)",
                        color:"#38bdf8",borderRadius:5,padding:"3px 10px",fontSize:11,fontWeight:600,
                        textDecoration:"none",cursor:"pointer"}}>
                      ğŸ”— êµ¬ë§¤ ë§í¬ ì—´ê¸°
                    </a>
                  </div>
                )}
                {p.note&&<div style={{color:"var(--txt4)",fontSize:11,marginTop:3}}>ğŸ“ {p.note}</div>}
                {p.confirmedAt&&<div style={{color:"#34d399",fontSize:11,marginTop:3}}>âœ… {p.confirmedAt} {p.confirmedBy} êµ¬ë§¤ì™„ë£Œ</div>}
              </div>
              <div style={{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:6}}>
                {p.amount>0&&<span style={{color:"var(--txt)",fontWeight:800,fontSize:15}}>{p.amount.toLocaleString()}ì›</span>}
                <div style={{display:"flex",gap:5,flexWrap:"wrap",justifyContent:"flex-end"}}>
                  {canConfirm(p) && (
                    <button onClick={()=>confirm(p.id)} style={{background:"rgba(16,185,129,.1)",border:"1px solid rgba(16,185,129,.3)",color:"#34d399",borderRadius:5,padding:"5px 12px",fontSize:11,cursor:"pointer",fontWeight:700}}>
                      ğŸ›’ êµ¬ë§¤ì™„ë£Œ
                    </button>
                  )}
                  {canCancel(p) && (
                    <button onClick={()=>cancel(p.id)} style={{background:"rgba(100,116,139,.1)",border:"1px solid rgba(100,116,139,.3)",color:"#94a3b8",borderRadius:5,padding:"5px 10px",fontSize:11,cursor:"pointer"}}>
                      ì·¨ì†Œ
                    </button>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
}

function App() {
  // â”€â”€ localStorage ì˜ì†í™” (ìƒˆë¡œê³ ì¹¨í•´ë„ ë°ì´í„° ìœ ì§€) â”€â”€
  const [users, setUsers] = usePersistedState("eventos_users", INIT_USERS);
  const [authedUser, setAuthedUser] = useState(null);
  const [page, setPage] = useState("dashboard");
  const [detail, setDetail] = useState(null);
  const [projects, setProjects] = usePersistedState("eventos_projects", INIT_PROJECTS);
  const [priceList, setPriceList] = usePersistedState("eventos_priceList", INIT_PRICE_LIST);
  const [expenses, setExpenses] = usePersistedState("eventos_expenses", []);
  const [laborCosts, setLaborCosts] = usePersistedState("eventos_laborCosts", []);
  const [purchases, setPurchases] = usePersistedState("eventos_purchases", []);
  const [driveLoaded, setDriveLoaded] = useState(false);

  // â”€â”€ Google Drive ë™ê¸°í™”: ì‹œìŠ¤í…œ ë°ì´í„° ë³€ê²½ ì‹œ Driveì— ì €ì¥ â”€â”€
  const appDataRef = useRef(null);
  useEffect(() => {
    if (!driveLoaded) return; // ì´ˆê¸° ë¡œë“œ ì™„ë£Œ ì „ì—ëŠ” ì‹±í¬í•˜ì§€ ì•ŠìŒ
    const payload = { users, priceList, expenses, laborCosts, purchases };
    // ì´ì „ê³¼ ê°™ìœ¼ë©´ ìŠ¤í‚µ
    const json = JSON.stringify(payload);
    if (appDataRef.current === json) return;
    appDataRef.current = json;
    SyncManager.queueSync("saveAppData", { data: payload });
  }, [users, priceList, expenses, laborCosts, purchases, driveLoaded]);

  // â”€â”€ Google Drive ë™ê¸°í™”: í”„ë¡œì íŠ¸ ë³€ê²½ ì‹œ ê° í”„ë¡œì íŠ¸ ê°œë³„ ì €ì¥ â”€â”€
  const projectsRef = useRef(null);
  useEffect(() => {
    if (!driveLoaded) return;
    const json = JSON.stringify(projects);
    if (projectsRef.current === json) return;
    projectsRef.current = json;
    projects.forEach(p => {
      SyncManager.queueSync(`saveProject_${p.id}`, { project: p });
    });
  }, [projects, driveLoaded]);

  // â”€â”€ Google Drive ì´ˆê¸° ë¡œë“œ (ì•± ì‹œì‘ ì‹œ) â”€â”€
  useEffect(() => {
    (async () => {
      if (!DRIVE_CONFIG.ENABLED) { setDriveLoaded(true); return; }
      const cloud = await SyncManager.loadFromCloud();
      if (cloud && !cloud.error) {
        if (cloud.users?.length) setUsers(cloud.users);
        if (cloud.priceList?.length) setPriceList(cloud.priceList);
        if (cloud.expenses) setExpenses(cloud.expenses);
        if (cloud.laborCosts) setLaborCosts(cloud.laborCosts);
        if (cloud.purchases) setPurchases(cloud.purchases);
        if (cloud.projects?.length) setProjects(cloud.projects);
        toast("â˜ï¸ Google Driveì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.", "success");
      }
      setDriveLoaded(true);
    })();
  }, []);

  // ë¡œê·¸ì¸
  const handleLogin = (user) => {
    // lastLogin ê°±ì‹ 
    setUsers(prev => prev.map(u => u.id===user.id ? {...u, lastLogin: today} : u));
    setAuthedUser({...user, lastLogin: today});
    toast(`ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤, ${user.name}!`, "success");
  };

  // ë¡œê·¸ì•„ì›ƒ
  const handleLogout = () => {
    setAuthedUser(null);
    setPage("dashboard");
    setDetail(null);
    toast("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
  };

  // users ë³€ê²½ ì‹œ authedUserë„ ë™ê¸°í™” (ìê¸° ìì‹ ì´ ì°¨ë‹¨ëœ ê²½ìš° ë¡œê·¸ì•„ì›ƒ)
  useEffect(() => {
    if (!authedUser) return;
    const latest = users.find(u => u.id === authedUser.id);
    if (!latest) { handleLogout(); return; }
    if (authedUser.id !== "admin" && !latest.approved) {
      toast("ğŸš« ê´€ë¦¬ìì— ì˜í•´ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.", "error");
      handleLogout();
    }
  }, [users]);

  const updateProject = useCallback((updated) => {
    setProjects(prev => prev.map(p=>p.id===updated.id?updated:p));
    if (detail?.id===updated.id) setDetail(updated);
  }, [detail]);

  const addProject = useCallback((proj) => {
    setProjects(prev=>[proj,...prev]);
  }, []);

  // â”€â”€ ë¡œê·¸ì¸ ì „: ë¡œê·¸ì¸ í˜ì´ì§€ â”€â”€
  if (!authedUser) {
    return <LoginPage onLogin={handleLogin} users={users}/>;
  }

  const renderPage = () => {
    if (page==="detail"&&detail) {
      const live = projects.find(p=>p.id===detail.id)||detail;
      return <ProjectDetail project={live} onBack={()=>setPage("projects")} onUpdate={updateProject} currentUser={authedUser} users={users}/>;
    }
    if (page==="dashboard") return <Dashboard projects={projects} setPage={setPage} setDetail={setDetail}/>;
    if (page==="projects") return <ProjectsPage projects={projects} setDetail={setDetail} setPage={setPage} onAddProject={addProject} priceList={priceList}/>;
    if (page==="mywork") return <MyWork projects={projects} user={authedUser} users={users} setDetail={setDetail} setPage={setPage} expenses={expenses} laborCosts={laborCosts} purchases={purchases}/>;
    if (page==="expense") return <ExpensePanel expenses={expenses} setExpenses={setExpenses} projects={projects} users={users} currentUser={authedUser}/>;
    if (page==="labor") return <LaborPanel laborCosts={laborCosts} setLaborCosts={setLaborCosts} projects={projects} users={users} currentUser={authedUser}/>;
    if (page==="purchase") return <PurchasePanel purchases={purchases} setPurchases={setPurchases} projects={projects} users={users} currentUser={authedUser}/>;
    if (page==="files") return <FilesPage projects={projects}/>;
    // ê´€ë¦¬ì ì „ìš©
    if (page==="admin") {
      if (!authedUser.isAdmin) { setPage("dashboard"); return null; }
      return <AdminPanel users={users} onUsersChange={setUsers} priceList={priceList} onPriceListChange={setPriceList}/>;
    }
    return null;
  };

  return (
    <>
      <Topbar page={page} setPage={setPage} user={authedUser} onLogout={handleLogout}/>
      <BottomNav page={page} setPage={setPage} user={authedUser}/>
      <div id="main">{renderPage()}</div>
    </>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
